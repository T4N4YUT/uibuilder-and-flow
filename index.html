<!DOCTYPE html>
<html lang="th">

<head>
    <script
        src="https://cdn.jsdelivr.net/npm/node-red-contrib-uibuilder@7.4.2/front-end/uibuilder.iife.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .fa,
        .fas,
        .far,
        .fal,
        .fab,
        .fa-solid {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transform: translateZ(0);
        }

        html {
            font-size: 19px;
        }

        :root {
            --bg: #0b1220;
            --panel: #121a2b;
            --panel-2: #0f172a;
            --border: #1f2a44;
            --text: #cbd5e1;
            --muted: #94a3b8;
            --accent: #3b82f6;
            --chart-padding: 10px;
            --icon-gap: .5rem;
            --icon-w: 1.1rem;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            scrollbar-width: thin;
            scrollbar-color: var(--border) var(--bg);
        }

        .main-content {
            position: fixed;
            inset: 0;
            transition: transform .3s ease-in-out;
            will-change: transform;
            contain: paint;
        }

        @media (max-width:1023px) {
            .main-content {
                transform: none !important;
            }
        }

        #sidebar,
        #mainContent,
        #sidebar *,
        #mainContent * {
            caret-color: transparent;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #sidebar img,
        #mainContent img,
        #sidebar svg,
        #mainContent svg,
        #mainContent canvas {
            -webkit-user-drag: none;
            user-drag: none;
        }

        .copyable {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        .kpi-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
            padding: .75rem 1rem;
        }

        .kpi-title {
            color: var(--muted);
            font-size: .8rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .progress {
            height: 8px;
            background: var(--panel-2);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress>span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            width: var(--val, 0%);
        }

        .card-chart {
            width: 100%;
            height: clamp(60px, 12vh, 80px);
            min-height: 60px;
            max-height: 80px;
            overflow: hidden;
            display: block;
            position: relative;
            padding: 0 var(--chart-padding);
            border-radius: .75rem;
            box-sizing: border-box;
        }

        .card-chart>canvas {
            position: relative !important;
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
        }

        .hidden-card {
            display: none !important;
        }

        @media (max-width:640px) {
            .card-chart {
                height: 85px !important;
                min-height: 85px !important;
                max-height: 100px !important;
            }
        }

        @media (min-width:1280px) {
            .card-chart {
                min-height: 90px;
                max-height: 120px;
            }

            .flex-1.overflow-auto.p-6 {
                padding-right: 1rem;
            }
        }

        @media (min-width:1280px) {

            .flex-1.overflow-auto.p-6>.grid,
            .grid.grid-cols-1.xl\:grid-cols-\[1fr_22rem\] {
                grid-template-columns: minmax(0, 1fr) 22rem !important;
            }
        }

        :focus {
            outline: none;
        }

        :focus-visible {
            outline: 2px solid rgba(59, 130, 246, .7);
            outline-offset: 2px;
        }

        .offline-blank {
            background: var(--panel) !important;
            border: 1px solid var(--border) !important;
        }

        .offline-blank * {
            visibility: hidden !important;
        }

        .offline-hide {
            display: none !important;
        }

        .config-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            background: rgba(0, 0, 0, .5);
            display: none;
            z-index: 50;
        }

        .config-overlay.active {
            display: block;
        }

        .config-panel {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            width: 26rem;
            max-width: 95vw;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
            color: var(--text);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 3rem);
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            --cfg-gap: .75rem;
            --cfg-radius: .65rem;
        }

        .config-header {
            padding: .75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
            border-top-left-radius: .75rem;
            border-top-right-radius: .75rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            justify-content: space-between;
        }

        .config-header h5 {
            font-size: 1rem;
            font-weight: 600;
        }

        .config-body {
            flex-grow: 1;
            max-height: none;
            overflow: auto;
            padding: 1rem;
        }

        .config-footer {
            padding: .75rem 1rem;
            border-top: 1px solid var(--border);
            background: var(--panel-2);
            border-bottom-left-radius: .75rem;
            border-bottom-right-radius: .75rem;
        }

        .config-tabs {
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap;
            width: 100%;
            border-bottom: none;
            gap: .75rem;
        }

        .config-tab {
            flex: 1;
            text-align: center;
            padding: .5rem .25rem;
            border: none;
            border-radius: 0;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: .85rem;
            margin-bottom: 0;
        }

        .config-tab.active {
            color: var(--accent);
            font-weight: 600;
            box-shadow: inset 0 -2px 0 0 var(--accent);
        }

        .config-section {
            display: none;
            margin-top: .75rem;
        }

        .config-section.active {
            display: block;
        }

        .config-label {
            font-size: .875rem;
            color: var(--muted);
            margin-bottom: .35rem;
            display: block;
        }

        .config-input,
        .config-select {
            width: 100%;
            padding: .5rem .75rem;
            border-radius: var(--cfg-radius);
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .config-input::placeholder {
            color: #9aa6b2;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .75rem;
        }

        .btn {
            padding: .5rem .75rem;
            border-radius: .55rem;
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            cursor: pointer;
            height: 50px;
            font-size: .9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            filter: brightness(1.1);
        }

        .btn-primary {
            border-color: var(--accent);
        }

        .btn-danger {
            color: #fda4af;
            border-color: #7f1d1d;
        }

        .btn i {
            margin-right: .4rem;
        }

        .small-muted {
            font-size: .8rem;
            color: var(--muted);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: .5rem;
            padding: .4rem .6rem;
        }

        .remove-item-btn {
            color: #ef4444;
        }

        #modal-room-detail {
            z-index: 55;
        }

        #modal-room-detail canvas {
            user-select: auto;
            -webkit-user-select: auto;
            user-drag: auto;
            -webkit-user-drag: auto;
        }

        #modal-reboot,
        #modal-export,
        #modal-device-map,
        #modal-settings {
            z-index: 60;
        }

        #modal-reboot.centered,
        #modal-export.centered,
        #modal-device-map.centered,
        #modal-settings.centered {
            z-index: 70 !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div,
        #modal-settings.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
            max-width: min(92vw, 32rem) !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div {
            width: min(92vw, 26rem);
        }

        #modal-reboot.centered,
        #modal-export.centered,
        #modal-device-map.centered,
        #modal-settings.centered {
            display: block;
            background: rgba(0, 0, 0, .38);
        }

        .config-body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .config-body::-webkit-scrollbar-track {
            background: var(--panel-2);
            border-radius: 10px;
        }

        .config-body::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
            border: 2px solid var(--panel-2);
        }

        .config-body::-webkit-scrollbar-thumb:hover {
            background-color: var(--muted);
        }

        body::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        body::-webkit-scrollbar-track {
            background: var(--bg);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background-color: var(--muted);
        }

        #modal-settings.centered .config-panel {
            width: clamp(24rem, 32vw, 44rem) !important;
            max-width: 96vw !important;
            height: clamp(520px, 78vh, 720px) !important;
        }

        @media (max-width:640px) {
            #modal-settings.centered .config-panel {
                width: 96vw !important;
                height: 90vh !important;
            }
        }

        #modal-settings .config-panel.fullscreen {
            width: 96vw !important;
            height: 94vh !important;
        }

        #btn-copy-mac:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        #btn-copy-mac {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            padding: 0;
        }

        #btn-copy-mac i {
            margin-right: 0 !important;
            line-height: 1;
        }

        #btn-copy-mac .icon {
            margin-right: 0 !important;
            width: auto !important;
        }

        #modal-settings .cfg-mac-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--cfg-gap);
            padding: .6rem .75rem;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: var(--cfg-radius);
            margin-bottom: .5rem;
        }

        #modal-settings .cfg-mac-left {
            display: flex;
            align-items: center;
            gap: .6rem;
            min-width: 0;
        }

        #modal-settings .cfg-mac-label {
            font-size: .875rem;
            color: var(--muted);
        }

        #modal-settings .cfg-mac-value {
            font-size: .95rem;
            letter-spacing: .04em;
            white-space: nowrap;
        }

        .config-row.mqtt {
            display: grid;
            grid-template-columns: 1fr 11rem;
            gap: var(--cfg-gap, .75rem);
        }

        @media (max-width:640px) {
            .config-row.mqtt {
                grid-template-columns: 1fr;
            }
        }

        .cfg-field {
            display: flex;
            flex-direction: column;
            gap: .35rem;
        }

        .cfg-label-row {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: .9rem;
            color: var(--muted);
            font-weight: 600;
        }

        #modal-settings .config-input,
        #modal-settings .config-select {
            height: 44px !important;
            line-height: 44px !important;
            font-size: .95rem;
            padding-top: 0;
            padding-bottom: 0;
        }

        #modal-settings section#tab-alerts h6 {
            font-size: .9rem;
            margin-bottom: .25rem;
        }

        #modal-settings .config-section h5 .icon,
        #modal-settings .config-section h6 .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .config-section .config-label>.icon,
        #modal-settings .cfg-label-row .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .cfg-mac-left .icon,
        #modal-settings .btn .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .config-tabs .config-tab i {
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .icon>i {
            display: block;
            line-height: 1;
        }

        .config-label .icon,
        .cfg-mac-left .icon,
        #btn-copy-mac .icon,
        .btn .icon {
            display: inline-block !important;
            align-items: unset !important;
            justify-content: unset !important;
        }

        .config-icon {
            width: var(--icon-w, 1.25rem);
            height: var(--icon-w, 1.25rem);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .config-icon>i {
            line-height: 1;
        }

        .led {
            --led: #22c55e;
            position: relative;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            background: radial-gradient(circle at 35% 35%, #ffffff80 0%, var(--led) 40%, var(--led) 100%);
            box-shadow:
                inset 0 0 2px rgba(0, 0, 0, .35),
                0 0 4px 1px color-mix(in srgb, var(--led) 70%, transparent),
                0 0 8px 3px color-mix(in srgb, var(--led) 30%, transparent);
            animation: ledPulse 5s ease-in-out infinite;
        }

        .led--green {
            --led: #22c55e;
        }

        .led--red {
            --led: #ef4444;
        }

        .led--yellow {
            --led: #f59e0b;
        }

        .led--gray {
            --led: #94a3b8;
        }

        @keyframes ledPulse {

            0%,
            100% {
                box-shadow:
                    inset 0 0 2px rgba(0, 0, 0, .35),
                    0 0 4px 1px color-mix(in srgb, var(--led) 55%, transparent),
                    0 0 8px 3px color-mix(in srgb, var(--led) 25%, transparent);
                filter: brightness(1);
            }

            50% {
                box-shadow:
                    inset 0 0 2px rgba(0, 0, 0, .35),
                    0 0 6px 2px color-mix(in srgb, var(--led) 80%, transparent),
                    0 0 10px 4px color-mix(in srgb, var(--led) 40%, transparent);
                filter: brightness(1.15);
            }
        }

        .icon-ring {
            width: 5rem;
            height: 5rem;
            border-radius: 9999px;
            display: grid;
            place-items: center;
            background: rgba(255, 255, 255, .18);
            box-shadow:
                inset 0 1px 2px rgba(255, 255, 255, .25),
                0 6px 18px rgba(0, 0, 0, .18);
            backdrop-filter: blur(2px);
            margin: 0 auto 0.5rem;
        }

        .icon-ring img {
            width: 2.6rem;
            height: 2.6rem;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, .18));
        }

        .metric-title {
            font-weight: 700;
            font-size: clamp(1.2rem, 1.2vw, 1.05rem);
        }

        .metric-value {
            font-weight: 800;
            font-size: clamp(1.6rem, 3vw, 2rem);
            line-height: 1.05;
        }

        .metric-status {
            font-weight: 600;
            font-size: clamp(.80rem, 1.1vw, 1rem);
            opacity: .95;
        }

        .main-content {
            padding: 1rem !important;
        }

        .room-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            border-color: var(--accent);
            color: white;
            filter: brightness(1.2);
        }

        #modal-room-detail .config-header .btn {
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        #modal-room-detail .config-header button[data-close="modal-room-detail"]:hover {
            background-color: rgba(239, 68, 68, 0.25) !important;
            border-color: rgba(239, 68, 68, 0.8) !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div,
        #modal-settings.centered .config-panel,
        #modal-room-detail.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
        }

        #modal-room-detail.centered .config-panel {
            width: calc(100vw - 4rem);
            height: calc(100vh - 4rem);
            max-width: initial;
        }

        .detail-card {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: .75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .detail-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: .75rem;
            flex-shrink: 0;
        }

        .detail-card-content {
            flex-grow: 1;
            position: relative;
        }

        .live-row {
            display: grid;
            grid-template-columns: 7.5rem 1fr;
            align-items: center;
        }

        @media (max-width:480px) {
            .live-row {
                grid-template-columns: 6.25rem 1fr;
            }
        }

        .live-values {
            font-variant-numeric: tabular-nums;
            letter-spacing: .01em;
        }

        .badge-chip {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: .35rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
        }

        .badge-temp {
            background: rgba(244, 63, 94, .12);
            color: #fda4af;
        }

        .badge-hum {
            background: rgba(59, 130, 246, .12);
            color: #93c5fd;
        }

        .live-sep {
            opacity: .45;
            margin: 0 .2rem;
        }

        .detail-card {
            display: flex;
            flex-direction: column;
        }

        .detail-card .detail-card-content {
            flex: 1 1 auto;
            min-height: 0;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.7rem;
            /* 12px */
            line-height: 1;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .legend-item.hidden {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .legend-box {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
        }

        .modal-detail-room {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #modal-pin-map {
            z-index: 65;
        }

        #modal-pin-map.centered>div {
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
            width: min(92vw, 32rem);
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(1) brightness(1.2) contrast(1.1);
            opacity: 0.95;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        input[type="datetime-local"],
        input[type="date"],
        input[type="time"],
        input[type="month"] {
            color: #fff;
        }

        .custom-tooltip {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transform: translate(-50%, -110%);
            transition: opacity 0.15s ease;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            font-size: 0.8rem;
            width: max-content;
            z-index: 100;
        }

        .custom-tooltip-header {
            font-weight: bold;
            margin-bottom: 6px;
        }

        .custom-tooltip-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tooltip-line {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tooltip-color-box {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }


        .chart-legend .legend-item {
            cursor: default;
            pointer-events: none;
        }

        .chart-legend .legend-box {
            opacity: 1;
            border: 0 !important;
        }
    </style>

</head>

<body class="relative h-screen overflow-hidden">
    <main id="mainContent" class="main-content flex flex-col">
        <div class="flex-1 overflow-auto p-6 h-full">
            <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,1fr)_22rem] gap-6 items-stretch h-full">
                <div class="flex flex-col h-full">
                    <section
                        class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6 items-stretch auto-rows-fr flex-1 h-full">

                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-a">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-a" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room A</h3>
                                </div>
                                <span id="updated-room-a" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-a">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-a">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-b">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-b" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room B</h3>
                                </div>
                                <span id="updated-room-b" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-b">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-b">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-c">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-c" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room C</h3>
                                </div>
                                <span id="updated-room-c" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-c">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-c">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-d">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-d" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room D</h3>
                                </div>
                                <span id="updated-room-d" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-d">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-d">â€”</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>

                    </section>
                </div>

                <!-- Sidebar -->
                <aside class="self-stretch h-full">
                    <div class="space-y-4 pr-1">
                        <div class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)]">
                            <h4 class="text-lg font-semibold mb-3">ðŸ“ˆ System summary</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="rounded-lg border border-[var(--border)] p-3">
                                    <div class="text-xs text-[var(--muted)]">Devices Online</div>
                                    <div class="text-2xl font-extrabold leading-tight" id="kpi-devices-online">0/4</div>
                                </div>
                                <div class="rounded-lg border border-[var(--border)] p-3">
                                    <div class="text-xs text-[var(--muted)]">Active Alerts</div>
                                    <div class="text-2xl font-extrabold leading-tight" id="kpi-active-alerts">0</div>
                                </div>
                                <div class="rounded-lg border border-[var(--border)] p-3">
                                    <div class="text-xs text-[var(--muted)]">Avg Temp (24h)</div>
                                    <div class="text-2xl font-extrabold leading-tight" id="kpi-avg-temp">â€”</div>
                                </div>
                                <div class="rounded-lg border border-[var(--border)] p-3">
                                    <div class="text-xs text-[var(--muted)]">Avg RH (24h)</div>
                                    <div class="text-2xl font-extrabold leading-tight" id="kpi-avg-rh">â€”</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)]">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold">ðŸ”” Alerts</h4>
                                <a class="text-sm text-[var(--muted)] hover:text-white" href="#">View all</a>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <!-- Critical Card -->
                                <div id="card-critical"
                                    class="p-4 rounded-lg border border-[var(--border)] bg-opacity-60">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="text-xs text-[var(--muted)]">Critical</div>
                                            <div id="count-critical" class="text-3xl font-extrabold text-red-400">0
                                            </div>
                                        </div>
                                        <div
                                            class="w-10 h-10 rounded-full bg-[rgba(248,113,113,0.08)] flex items-center justify-center">
                                            <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                                        </div>
                                    </div>
                                    <ul id="list-critical"
                                        class="text-sm text-[var(--muted)] space-y-1 max-h-24 overflow-y-auto mt-3">
                                        <!-- JS à¸ˆà¸°à¹€à¸•à¸´à¸¡ <li> à¸—à¸µà¹ˆà¸™à¸µà¹ˆ -->
                                    </ul>
                                </div>

                                <!-- Warning Card -->
                                <div id="card-warning"
                                    class="p-4 rounded-lg border border-[var(--border)] bg-opacity-60">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="text-xs text-[var(--muted)]">Warning</div>
                                            <div id="count-warning" class="text-3xl font-extrabold text-yellow-400">0
                                            </div>
                                        </div>
                                        <div
                                            class="w-10 h-10 rounded-full bg-[rgba(251,191,36,0.06)] flex items-center justify-center">
                                            <i class="fa-solid fa-triangle-exclamation text-yellow-400"></i>
                                        </div>
                                    </div>
                                    <ul id="list-warning"
                                        class="text-sm text-[var(--muted)] space-y-1 max-h-24 overflow-y-auto mt-3">
                                        <!-- JS à¸ˆà¸°à¹€à¸•à¸´à¸¡ <li> à¸—à¸µà¹ˆà¸™à¸µà¹ˆ -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div id="qa-card" class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)]">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold">âš¡ Quick Actions</h4>
                                <button id="open-device-map" class="text-sm text-[var(--muted)] hover:text-white">
                                    Device Map
                                </button>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button id="qa-reboot"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--panel-2)]"><i
                                        class="fa-solid fa-power-off mr-2"></i></button>
                                <button id="qa-export"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--panel-2)]"><i
                                        class="fa-solid fa-file-arrow-down mr-2"></i></button>
                                <button id="qa-settings"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-[var(--panel-2)]"><i
                                        class="fa-solid fa-gear mr-2"></i></button>
                            </div>
                            <p id="qa-status" class="mt-3 text-xs text-[var(--muted)]">Ready</p>
                        </div>

                        <div id="modal-reboot" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-transparent" data-close="modal-reboot"></div>
                            <div
                                class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[22rem]">

                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-semibold">Reboot device</h5>
                                    <button
                                        class="flex items-center justify-center h-10 w-10 rounded-lg border border-red-500 text-red-500 hover:bg-red-500/10"
                                        data-close="modal-reboot" aria-label="Close">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>

                                <form id="form-reboot" class="space-y-3">
                                    <label class="block text-sm">Select room
                                        <select name="target"
                                            class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                                            <option value="room-a">Room A</option>
                                            <option value="room-b">Room B</option>
                                            <option value="room-c">Room C</option>
                                            <option value="room-d">Room D</option>
                                            <option value="all">All Devices</option>
                                        </select>
                                    </label>

                                    <div class="flex items-center justify-end pt-1">
                                        <button type="submit" class="px-6 py-3 rounded-lg font-semibold
                   bg-blue-600 text-white
                   hover:bg-blue-700
                   focus:outline-none focus:ring-2 focus:ring-blue-400
                   transition">
                                            <i class="fa-solid fa-rotate-right mr-2"></i>Confirm
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="modal-export" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-transparent" data-close="modal-export"></div>
                            <div
                                class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[26rem]">

                                <!-- Header + à¸›à¸¸à¹ˆà¸¡à¸à¸²à¸à¸šà¸²à¸— -->
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-semibold">Generate Report</h5>
                                    <button
                                        class="flex items-center justify-center h-10 w-10 rounded-lg border border-red-500 text-red-500 hover:bg-red-500/10"
                                        data-close="modal-export" aria-label="Close">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>

                                <form id="form-export" class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="block text-sm">Select room
                                            <select name="room"
                                                class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                                                <option value="room-a">Room A</option>
                                                <option value="room-b">Room B</option>
                                                <option value="room-c">Room C</option>
                                                <option value="room-d">Room D</option>
                                                <option value="all">All Rooms</option>
                                            </select>
                                        </label>
                                        <label class="block text-sm">Type
                                            <select name="type"
                                                class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                                                <option value="csv">CSV</option>
                                                <option value="pdf">PDF</option>
                                            </select>
                                        </label>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="block text-sm">Start
                                            <input type="datetime-local" name="from"
                                                class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                                        </label>
                                        <label class="block text-sm">End
                                            <input type="datetime-local" name="to"
                                                class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                                        </label>
                                    </div>

                                    <!-- à¹€à¸«à¸¥à¸·à¸­à¹à¸„à¹ˆà¸›à¸¸à¹ˆà¸¡ Confirm à¸ªà¸µà¸Ÿà¹‰à¸² -->
                                    <div class="flex items-center justify-end pt-1">
                                        <button type="submit" class="px-6 py-3 rounded-lg font-semibold
                           bg-blue-600 text-white
                           hover:bg-blue-700
                           focus:outline-none focus:ring-2 focus:ring-blue-400
                           transition">
                                            <i class="fa-solid fa-check mr-2"></i>Confirm
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="modal-settings" class="config-overlay">
                            <div class="config-panel">
                                <div class="config-header">
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-semibold">Settings</h5>
                                        <select id="cfg-room" class="config-select" style="width:9rem">
                                            <option value="room-a">Room A</option>
                                            <option value="room-b">Room B</option>
                                            <option value="room-c">Room C</option>
                                            <option value="room-d">Room D</option>
                                        </select>
                                    </div>
                                    <button
                                        class="flex items-center justify-center h-11 w-11 rounded-lg border border-red-500 text-red-500 hover:bg-red-500/10"
                                        data-close="modal-settings" aria-label="Close">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>

                                <div class="config-body">
                                    <div class="config-tabs">
                                        <button class="config-tab active" data-tab="ethernet"><i
                                                class="fa-solid fa-ethernet mr-2 opacity-80"></i>Ethernet</button>
                                        <button class="config-tab" data-tab="mqtt"><i
                                                class="fa-solid fa-server mr-2 opacity-80"></i>MQTT</button>
                                        <button class="config-tab" data-tab="alerts"><i
                                                class="fa-solid fa-bell mr-2 opacity-80"></i>Alerts</button>
                                        <button class="config-tab" data-tab="recipients"><i
                                                class="fa-solid fa-paper-plane mr-2 opacity-80"></i>Recipients</button>
                                    </div>

                                    <!-- ETHERNET -->
                                    <section id="tab-ethernet" class="config-section active space-y-3">
                                        <div class="cfg-mac-row">
                                            <div class="cfg-mac-left">
                                                <span class="icon text-sky-400"><i class="fa-solid fa-network-wired"
                                                        aria-hidden="true"></i></span>
                                                <span class="cfg-mac-label">MAC :</span>
                                                <span id="cfg-mac" class="cfg-mac-value">--:--:--:--:--:--</span>
                                            </div>
                                            <button id="btn-copy-mac"
                                                class="btn flex items-center justify-center w-9 h-9 p-0"
                                                aria-label="Copy MAC">
                                                <span class="config-icon"><i class="fa-regular fa-copy"></i></span>
                                            </button>
                                        </div>

                                        <label class="config-label">
                                            <span class="icon text-emerald-400"><i class="fa-solid fa-microchip"
                                                    aria-hidden="true"></i></span>IP Address
                                            <input id="ip" class="config-input mt-1" placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-indigo-400"><i class="fa-solid fa-sitemap"
                                                    aria-hidden="true"></i></span>Subnet Mask
                                            <input id="subnet" class="config-input mt-1" placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-purple-400"><i class="fa-solid fa-route"
                                                    aria-hidden="true"></i></span>Gateway
                                            <input id="gateway" class="config-input mt-1" placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-blue-400"><i class="fa-solid fa-globe"
                                                    aria-hidden="true"></i></span>DNS
                                            <input id="dns" class="config-input mt-1" placeholder="">
                                        </label>
                                    </section>

                                    <!-- MQTT -->
                                    <section id="tab-mqtt" class="config-section space-y-3">
                                        <label class="config-label">
                                            <span class="icon text-sky-400">
                                                <i class="fa-solid fa-server" aria-hidden="true"></i>
                                            </span>
                                            Broker
                                            <input id="mqtt-broker" class="config-input mt-1" placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-amber-400">
                                                <i class="fa-solid fa-diagram-project" aria-hidden="true"></i>
                                            </span>
                                            Port
                                            <input id="mqtt-port" type="number" class="config-input mt-1"
                                                placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-emerald-400">
                                                <i class="fa-solid fa-user" aria-hidden="true"></i>
                                            </span>
                                            Username
                                            <input id="mqtt-user" class="config-input mt-1" placeholder="">
                                        </label>

                                        <label class="config-label">
                                            <span class="icon text-rose-400">
                                                <i class="fa-solid fa-key" aria-hidden="true"></i>
                                            </span>
                                            Password
                                            <input id="mqtt-pass" type="password" class="config-input mt-1"
                                                placeholder="">
                                        </label>
                                    </section>

                                    <!-- ALERTS -->
                                    <section id="tab-alerts" class="config-section">
                                        <h6 class="mb-2 font-semibold">
                                            <span class="icon text-red-400"><i class="fa-solid fa-temperature-half"
                                                    aria-hidden="true"></i></span>Temperature (Â°C)
                                        </h6>
                                        <div class="config-row">
                                            <label class="config-label">
                                                <span class="icon text-red-400"><i class="fa-solid fa-arrow-down"
                                                        aria-hidden="true"></i></span>Critical Low Temperature
                                                <input id="temp-crit-low" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                            <label class="config-label">
                                                <span class="icon text-amber-400"><i class="fa-solid fa-arrow-down"
                                                        aria-hidden="true"></i></span>Warning Low Temperature
                                                <input id="temp-warn-low" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                        </div>
                                        <div class="config-row" style="margin-top:.75rem">
                                            <label class="config-label">
                                                <span class="icon text-amber-400"><i class="fa-solid fa-arrow-up"
                                                        aria-hidden="true"></i></span>Warning High Temperature
                                                <input id="temp-warn-high" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                            <label class="config-label">
                                                <span class="icon text-red-400"><i class="fa-solid fa-arrow-up"
                                                        aria-hidden="true"></i></span>Critical High Temperature
                                                <input id="temp-crit-high" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                        </div>

                                        <h6 class="mt-4 mb-2 font-semibold">
                                            <span class="icon text-blue-400"><i class="fa-solid fa-droplet"
                                                    aria-hidden="true"></i></span>Humidity (%)
                                        </h6>
                                        <div class="config-row">
                                            <label class="config-label">
                                                <span class="icon text-red-400"><i class="fa-solid fa-arrow-down"
                                                        aria-hidden="true"></i></span>Critical Low Humidity
                                                <input id="hum-crit-low" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                            <label class="config-label">
                                                <span class="icon text-amber-400"><i class="fa-solid fa-arrow-down"
                                                        aria-hidden="true"></i></span>Warning Low Humidity
                                                <input id="hum-warn-low" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                        </div>
                                        <div class="config-row" style="margin-top:.75rem">
                                            <label class="config-label">
                                                <span class="icon text-amber-400"><i class="fa-solid fa-arrow-up"
                                                        aria-hidden="true"></i></span>Warning High Humidity
                                                <input id="hum-warn-high" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                            <label class="config-label">
                                                <span class="icon text-red-400"><i class="fa-solid fa-arrow-up"
                                                        aria-hidden="true"></i></span>Critical High Humidity
                                                <input id="hum-crit-high" type="number" step="0.1"
                                                    class="config-input mt-1">
                                            </label>
                                        </div>
                                    </section>

                                    <!-- RECIPIENTS -->
                                    <section id="tab-recipients" class="config-section">
                                        <h6 class="mb-2 font-semibold">
                                            <span class="icon text-yellow-400">
                                                <i class="fa-solid fa-envelope" aria-hidden="true"></i>
                                            </span>
                                            Email Recipients
                                        </h6>
                                        <div class="flex gap-2 mb-2">
                                            <!-- à¸Šà¹ˆà¸­à¸‡à¸à¸£à¸­à¸ Email -->
                                            <input id="new-email-input" type="text" placeholder="Enter email"
                                                class="flex-1 h-11 px-3 rounded-lg bg-[#0f172a] border border-[#1f2a44] text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                            <!-- à¸›à¸¸à¹ˆà¸¡ + -->
                                            <button id="add-email-btn"
                                                class="w-11 h-11 flex items-center justify-center rounded-lg bg-[#0f172a] border border-[#1f2a44] text-emerald-400 hover:bg-[#1e293b]">
                                                <span class="config-icon"><i class="fa-solid fa-plus"></i></span>
                                            </button>
                                        </div>
                                        <ul id="email-list" class="space-y-2"></ul>

                                        <h6 class="mt-4 mb-2 font-semibold">
                                            <span class="icon text-sky-400">
                                                <i class="fa-brands fa-telegram" aria-hidden="true"></i>
                                            </span>
                                            Telegram Chat IDs
                                        </h6>
                                        <div class="flex gap-2 mb-2">
                                            <!-- à¸Šà¹ˆà¸­à¸‡à¸à¸£à¸­à¸ Telegram -->
                                            <input id="new-chat-id-input" type="text" placeholder="Enter Chat ID"
                                                class="flex-1 h-11 px-3 rounded-lg bg-[#0f172a] border border-[#1f2a44] text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                            <!-- à¸›à¸¸à¹ˆà¸¡ + -->
                                            <button id="add-chat-id-btn"
                                                class="w-11 h-11 flex items-center justify-center rounded-lg bg-[#0f172a] border border-[#1f2a44] text-emerald-400 hover:bg-[#1e293b]">
                                                <span class="config-icon"><i class="fa-solid fa-plus"></i></span>
                                            </button>
                                        </div>
                                        <ul id="chat-id-list" class="space-y-2"></ul>
                                    </section>



                                </div>

                                <div class="config-footer">
                                    <div class="flex items-center justify-between gap-2">
                                        <button id="btn-save-settings" class="w-full px-6 py-3 rounded-lg font-semibold
           bg-blue-600 text-white
           hover:bg-blue-700
           focus:outline-none focus:ring-2 focus:ring-blue-400
           transition">
                                            <i class="fa-solid fa-save mr-2"></i> Save & Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-pin-map" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-transparent" data-close="modal-pin-map"></div>
                            <div
                                class="absolute bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[32rem] max-w-[95vw]">
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-semibold text-lg">Sensor Name</h5>
                                    <button
                                        class="flex items-center justify-center h-10 w-10 rounded-lg border border-red-500 text-red-500 hover:bg-red-500/10"
                                        data-close="modal-pin-map" aria-label="Close">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>
                                <form id="form-pin-map" class="space-y-3">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin 25</label>
                                            <input name="name_pin_25" placeholder="" class="config-input mt-1"
                                                autofocus>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin 26</label>
                                            <input name="name_pin_26" placeholder="" class="config-input mt-1">
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin 32</label>
                                            <input name="name_pin_32" placeholder="" class="config-input mt-1">
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin 33</label>
                                            <input name="name_pin_33" placeholder="" class="config-input mt-1">
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-end pt-2">
                                        <button type="submit"
                                            class="px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                                            <i class="fa-solid fa-check mr-2"></i>Confirm
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- Device Map (MAC â†” Room) -->
                        <div id="modal-device-map" class="fixed inset-0 z-50 hidden">
                            <div class="absolute inset-0 bg-transparent" data-close="modal-device-map"></div>
                            <div
                                class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[32rem] max-w-[95vw]">
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-semibold text-lg">Device Map</h5>
                                    <button
                                        class="flex items-center justify-center h-10 w-10 rounded-lg border border-red-500 text-red-500 hover:bg-red-500/10"
                                        data-close="modal-device-map" aria-label="Close">
                                        <i class="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>
                                <form id="form-device-map" class="space-y-3">

                                    <div class="grid grid-cols-2">

                                        <div class="pr-6 pb-6 border-r border-b border-dashed border-[var(--border)]">
                                            <div class="space-y-3">
                                                <div>
                                                    <label for="name_room_a"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">Name</label>
                                                    <input type="text" id="name_room_a" name="name_room_a"
                                                        placeholder="" class="config-input">
                                                </div>
                                                <div>
                                                    <label for="mac_room_a"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                                        Address</label>
                                                    <input type="text" id="mac_room_a" name="mac_room_a" placeholder=""
                                                        class="config-input copyable">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="pl-6 pb-6 border-b border-dashed border-[var(--border)]">
                                            <div class="space-y-3">
                                                <div>
                                                    <label for="name_room_b"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">Name</label>
                                                    <input type="text" id="name_room_b" name="name_room_b"
                                                        placeholder="" class="config-input">
                                                </div>
                                                <div>
                                                    <label for="mac_room_b"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                                        Address</label>
                                                    <input type="text" id="mac_room_b" name="mac_room_b" placeholder=""
                                                        class="config-input copyable">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="pr-6 pt-6 border-r border-dashed border-[var(--border)]">
                                            <div class="space-y-3">
                                                <div>
                                                    <label for="name_room_c"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">Name</label>
                                                    <input type="text" id="name_room_c" name="name_room_c"
                                                        placeholder="" class="config-input">
                                                </div>
                                                <div>
                                                    <label for="mac_room_c"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                                        Address</label>
                                                    <input type="text" id="mac_room_c" name="mac_room_c" placeholder=""
                                                        class="config-input copyable">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="pl-6 pt-6">
                                            <div class="space-y-3">
                                                <div>
                                                    <label for="name_room_d"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">Name</label>
                                                    <input type="text" id="name_room_d" name="name_room_d"
                                                        placeholder="" class="config-input">
                                                </div>
                                                <div>
                                                    <label for="mac_room_d"
                                                        class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                                        Address</label>
                                                    <input type="text" id="mac_room_d" name="mac_room_d" placeholder=""
                                                        class="config-input copyable">
                                                </div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="flex items-center justify-end pt-2">
                                        <button type="submit"
                                            class="px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                                            <i class="fa-solid fa-check mr-2"></i>Confirm
                                        </button>
                                    </div>
                                    <p id="map-status" class="mt-2 text-xs text-[var(--muted)]"></p>
                                </form>
                            </div>
                        </div>

                    </div>
            </div>

        </div>

        <div id="modal-room-detail" class="config-overlay hidden">
            <div class="config-panel">
                <div class="config-header">
                    <div class="flex items-center gap-4">
                        <span id="detail-room-status-led" class="led led--red"></span>
                        <h5 id="detail-room-name" class="font-semibold text-lg">Room Details</h5>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="detail-btn-reboot" class="btn"><i
                                class="fa-solid fa-power-off mr-2"></i>Reboot</button>
                        <button id="detail-btn-export" class="btn"><i
                                class="fa-solid fa-file-arrow-down mr-2"></i>Export</button>
                        <button id="detail-btn-settings" class="btn"><i
                                class="fa-solid fa-gear mr-2"></i>Settings</button>
                        <button id="open-pin-map" class="btn"><i class="fa-solid fa-tags mr-2"></i>Sensor Name</button>
                        <button data-close="modal-room-detail"
                            class="w-11 h-11 flex items-center justify-center rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20"><i
                                class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                </div>

                <div class="config-body grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">

                    <div class="flex flex-col gap-4 h-full min-h-0">
                        <!-- Room Alerts: à¸à¸´à¸™à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­ -->
                        <div class="detail-card flex-1 min-h-0" id="detail-card-alerts">
                            <h6 class="detail-card-title">ðŸ”” Room Alerts</h6>
                            <div class="detail-card-content overflow-y-auto">
                                <ul id="detail-alert-list" class="space-y-2">
                                    <li class="text-center text-[var(--muted)] mt-4">No active alerts</li>
                                </ul>
                            </div>
                        </div>
                        <div class="detail-card">
                            <h6 class="detail-card-title">ðŸ“ˆ System summary</h6>
                            <!-- KPIs -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center">
                                <!-- Temperature -->
                                <div class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)]">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Temperature (Â°C)</div>
                                    <div class="mt-3 grid grid-cols-3 gap-3 items-end">
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MIN</div>
                                            <div id="kpi-temp-min" class="text-2xl font-extrabold text-sky-400">â€”</div>
                                            <div class="h-1 rounded bg-sky-500/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">AVG</div>
                                            <div id="kpi-temp-avg" class="text-2xl font-extrabold">â€”</div>
                                            <div class="h-1 rounded bg-slate-300/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MAX</div>
                                            <div id="kpi-temp-max" class="text-2xl font-extrabold text-red-400">â€”</div>
                                            <div class="h-1 rounded bg-red-500/30 mt-1"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Humidity -->
                                <div class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)]">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Humidity (%)</div>
                                    <div class="mt-3 grid grid-cols-3 gap-3 items-end">
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MIN</div>
                                            <div id="kpi-rh-min" class="text-2xl font-extrabold text-sky-400">â€”</div>
                                            <div class="h-1 rounded bg-sky-500/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">AVG</div>
                                            <div id="kpi-rh-avg" class="text-2xl font-extrabold">â€”</div>
                                            <div class="h-1 rounded bg-slate-300/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MAX</div>
                                            <div id="kpi-rh-max" class="text-2xl font-extrabold text-red-400">â€”</div>
                                            <div class="h-1 rounded bg-red-500/30 mt-1"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dew Point -->
                                <div
                                    class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)] flex flex-col items-center justify-center">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Dew Point (Â°C)</div>
                                    <div id="kpi-dew-avg" class="text-3xl font-extrabold text-emerald-400 mt-2">â€”</div>
                                    <div class="h-1 w-16 rounded bg-emerald-500/30 mt-2"></div>
                                </div>

                            </div>

                            <!-- divider -->
                            <div class="border-t border-[var(--border)] my-4"></div>

                            <!-- Live sensors merged in -->
                            <div class="detail-card-content overflow-y-auto">
                                <ul id="detail-sensor-list" class="space-y-2">
                                    <li class="text-center text-[var(--muted)] mt-4"></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4 h-full min-h-0">
                        <div id="detail-toolbar" class="detail-card p-3">
                            <div id="range-controls"
                                class="mb-3 grid grid-cols-1 md:grid-cols-[1fr_1fr_auto_auto] gap-2 items-end">
                                <label class="text-xs text-[var(--muted)]">
                                    Start
                                    <input id="range-start" type="datetime-local"
                                        class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2 text-sm">
                                </label>
                                <label class="text-xs text-[var(--muted)]">
                                    End
                                    <input id="range-end" type="datetime-local"
                                        class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2 text-sm">
                                </label>
                                <button id="btn-apply-range" class="btn btn-primary h-10 px-4">Apply</button>
                                <button id="btn-reset-range" class="btn h-10 px-4">Reset</button>
                            </div>

                            <div class="mt-3 relative text-sm">
                                <button id="series-dropdown-btn"
                                    class="btn h-10 px-4 w-full text-left flex justify-between items-center">
                                    <span>Select Series & Options</span>
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </button>
                                <div id="series-dropdown-panel"
                                    class="hidden absolute z-10 mt-1 w-full bg-[var(--panel)] border border-[var(--border)] rounded-lg shadow-lg p-3">
                                    <div id="series-toggle" class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm">
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="overall" checked> Overall</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin25"> Pin 25</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin33"> Pin 33</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="dew" checked> Dew Point(Overall)</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin26"> Pin 26</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin32"> Pin 32</label>

                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                id="toggle-thresholds"> Thresholds</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="detail-card flex-1 min-h-0">
                            <div class="flex justify-between items-center mb-2">
                                <h6 class="detail-card-title !mb-0">Temperature (Â°C)</h6>
                                <div id="legend-container-temp" class="chart-legend"></div>
                            </div>
                            <div class="detail-card-content">
                                <canvas id="detail-chart-temp" class="w-full h-full"></canvas>
                            </div>
                        </div>
                        <div class="detail-card flex-1 min-h-0">
                            <div class="flex justify-between items-center mb-2">
                                <h6 class="detail-card-title !mb-0">Humidity (%)</h6>
                                <div id="legend-container-rh" class="chart-legend"></div>
                            </div>
                            <div class="detail-card-content">
                                <canvas id="detail-chart-rh" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div id="modal-reboot" class="fixed inset-0 z-50 hidden">
            </aside>

        </div>
        </div>

    </main>

    <!-- Scripts at the end -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadDeviceMapFromServer(), loadPinMapFromServer()]);
            uibuilder.start();
            if (typeof applyRoomNames === 'function') applyRoomNames?.();
            if (typeof applyPinNames === 'function') applyPinNames?.();
            const htmlLegendPlugin = {
                id: 'htmlLegend',
                afterUpdate(chart, args, options) {
                    const ul = getOrCreateLegendList(chart, options.containerID);

                    while (ul.firstChild) {
                        ul.firstChild.remove();
                    }

                    const items = chart.options.plugins.legend.labels.generateLabels(chart);

                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.classList.add('legend-item');
                        if (item.hidden) {
                            li.classList.add('hidden');
                        }

                        const boxSpan = document.createElement('span');
                        boxSpan.classList.add('legend-box');
                        boxSpan.style.background = item.strokeStyle || '#9aa6b2';
                        boxSpan.style.borderColor = 'transparent';
                        boxSpan.style.borderWidth = '0';

                        const textContainer = document.createElement('span');
                        textContainer.style.color = item.fontColor;
                        textContainer.style.textDecoration = item.hidden ? 'line-through' : '';
                        const text = document.createTextNode(item.text);
                        textContainer.appendChild(text);

                        li.appendChild(boxSpan);
                        li.appendChild(textContainer);

                        li.onclick = () => {
                            const { type } = chart.config;
                            if (type === 'pie' || type === 'doughnut') {
                                chart.toggleDataVisibility(item.index);
                            } else {
                                chart.setDatasetVisibility(item.datasetIndex, !chart.isDatasetVisible(item.datasetIndex));
                            }
                            chart.update();
                        };

                        ul.appendChild(li);
                    });
                }
            };
            const ThresholdPlugin = {
                id: 'thresholdPlugin',
                afterDatasetsDraw(chart, args, pluginOpts) {
                    const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                    const lines = pluginOpts?.lines || [];
                    ctx.save();
                    lines.forEach(l => {
                        if (typeof l.y !== 'number') return;
                        const py = y.getPixelForValue(l.y);
                        if (py < top || py > bottom) return;
                        ctx.beginPath();
                        if (Array.isArray(l.dash)) ctx.setLineDash(l.dash);
                        ctx.lineWidth = l.width || 1;
                        ctx.strokeStyle = l.color || 'rgba(255,255,255,0.3)';
                        ctx.moveTo(left, py);
                        ctx.lineTo(right, py);
                        ctx.stroke();
                        if (l.label) {
                            ctx.fillStyle = l.color || 'rgba(255,255,255,0.7)';
                            ctx.font = '10px sans-serif';
                            ctx.fillText(l.label, left + 6, py - 4);
                        }
                    });
                    ctx.restore();
                }
            };

            const getOrCreateLegendList = (chart, containerID) => {
                const container = document.getElementById(containerID);
                let listContainer = container.querySelector('ul');

                if (!listContainer) {
                    listContainer = document.createElement('ul');
                    listContainer.style.display = 'flex';
                    listContainer.style.flexDirection = 'row';
                    listContainer.style.margin = '0';
                    listContainer.style.padding = '0';
                    listContainer.style.gap = '0.75rem';

                    container.appendChild(listContainer);
                }

                return listContainer;
            };
            const zoomPlugin = ChartZoom;
            Chart.register(zoomPlugin);
            Chart.register(ThresholdPlugin);
            Chart.register(htmlLegendPlugin);
            const css = getComputedStyle(document.documentElement);
            Chart.defaults.color = '#ffffff';
            Chart.defaults.borderColor = 'rgba(255,255,255,.08)';
            Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
            window.DEVICE_MAP_DATA = {};
            window.ROOM_PIN_NAMES = {};
            window.pinStatuses = {};
            window.MAC_TO_ROOM_MAP = {};
            window.ROOM_TO_MAC_MAP = {};
            window._gotFirstMsg = false;
            window._detailCharts = { temp: null, rh: null };
            window.chartApiData = [];
            window.roomDataStore = {
                'room-a': { history: [], live: {} },
                'room-b': { history: [], live: {} },
                'room-c': { history: [], live: {} },
                'room-d': { history: [], live: {} },
            };
            document.querySelectorAll('.detail-card-title').forEach(el => {
                if (el.textContent && el.textContent.includes('Key Indicators')) {
                    el.textContent = 'ðŸ“Š System summary';
                }
            });
            const MAP_STORAGE_KEY = 'room_mac_map_v1';
            let currentCfgRoom = 'room-a';
            let notificationEmails = [];
            let telegramChatIds = [];
            window._cfgReqs = window._cfgReqs || {};
            window._lastReqPerRoom = window._lastReqPerRoom || {};
            window._configPromises = {};
            window.liveAlertSettings = {};
            const CFG_REQUEST_TIMEOUT_MS = 3000;
            function canonicalRoomKey(k) {
                const m = String(k).match(/^room([ABCD])$/i);
                return m ? `room-${m[1].toLowerCase()}` : null;
            }
            async function saveDeviceMapToServer(formData) {
                const dataToSave = {
                    roomA: normalizeMAC(formData.get('mac_room_a')),
                    nameA: formData.get('name_room_a')?.trim() || '',
                    roomB: normalizeMAC(formData.get('mac_room_b')),
                    nameB: formData.get('name_room_b')?.trim() || '',
                    roomC: normalizeMAC(formData.get('mac_room_c')),
                    nameC: formData.get('name_room_c')?.trim() || '',
                    roomD: normalizeMAC(formData.get('mac_room_d')),
                    nameD: formData.get('name_room_d')?.trim() || ''
                };

                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š MAC à¸‹à¹‰à¸³
                const macs = Object.values(dataToSave).filter(v => typeof v === 'string' && v.includes(':'));
                const uniqueMacs = new Set(macs);
                if (macs.length !== uniqueMacs.size) {
                    showPopup('âŒ à¸¡à¸µ MAC Address à¸‹à¹‰à¸³à¸à¸±à¸™', { type: 'fail' });
                    return false;
                }

                try {
                    const response = await fetch('/api/device-map', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.error || 'Unknown error');
                    window.DEVICE_MAP_DATA = dataToSave;
                    updateGlobalMappings(dataToSave);
                    applyRoomNames();

                    showPopup('âœ… à¸šà¸±à¸™à¸—à¸¶à¸ Device Map à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!', { type: 'success' });
                    return true;
                } catch (error) {
                    console.error('[Device Map] Error saving to server:', error);
                    showPopup(`âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${error.message}`, { type: 'fail' });
                    return false;
                }
            }
            async function savePinMapToServer(roomId, formData) {
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) {
                    showPopup(`âŒ à¹„à¸¡à¹ˆà¸žà¸š MAC Address à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¹‰à¸­à¸‡ ${roomId}`, { type: 'fail' });
                    return false;
                }
                const dataToSave = {
                    name_pin_25: formData.get('name_pin_25')?.trim() || '',
                    name_pin_26: formData.get('name_pin_26')?.trim() || '',
                    name_pin_32: formData.get('name_pin_32')?.trim() || '',
                    name_pin_33: formData.get('name_pin_33')?.trim() || ''
                };
                try {
                    const response = await fetch('/api/pin-map', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mac, ...dataToSave })
                    });
                    if (!response.ok) throw new Error('Server error');

                    window.MAC_PIN_NAMES[mac] = dataToSave;

                    showPopup('âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸Šà¸·à¹ˆà¸­ Pin à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!', { type: 'success' });
                    const detailRoomNameEl = document.getElementById('detail-room-name');
                    if (detailRoomNameEl?.dataset?.currentRoom === roomId) {
                        updateSensorList(window.roomDataStore[roomId].live, roomId);
                        feedChartsFromRows(window.chartApiData, false);
                    }
                    applyPinNames?.();
                    return true;
                } catch (error) {
                    console.error('[Pin Map] Error saving to server:', error);
                    showPopup('âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¸Šà¸·à¹ˆà¸­ Pin à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', { type: 'fail' });
                    return false;
                }
            }
            async function loadPinMapFromServer() {
                try {
                    const res = await fetch('/api/pin-map', { cache: 'no-store' });
                    if (!res.ok) throw new Error('Failed to fetch pin map');
                    window.MAC_PIN_NAMES = await res.json();
                    console.log('[pin-map] loaded', window.MAC_PIN_NAMES);
                } catch (err) {
                    console.warn('Could not load pin names:', err);
                    window.MAC_PIN_NAMES = {};
                }
                applyPinNames?.();
            }
            function pinLabel(pin) {
                const roomEl = document.getElementById('detail-room-name');
                const roomId =
                    roomEl?.dataset?.currentRoom ||
                    window.currentRoomId ||
                    document.getElementById('cfg-room')?.value ||
                    'room-a';
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                const map = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                const v = map[`name_pin_${pin}`];
                return (v && String(v).trim()) || `Pin ${pin}`;
            }
            function getPinLabel(pin) {
                const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                if (!currentRoomId) return `Pin ${pin}`;
                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                if (!mac) return `Pin ${pin}`;
                const map = window.MAC_PIN_NAMES?.[mac] || {};
                const v = map[`name_pin_${pin}`];
                return (v && String(v).trim()) || `Pin ${pin}`;
            }

            function applyPinNames(roomId) {
                // à¹ƒà¸Šà¹‰ roomId à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¸¡à¸² à¸«à¸£à¸·à¸­à¸«à¸²à¸ˆà¸²à¸à¸„à¹ˆà¸²à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸ªà¹ˆà¸‡à¸¡à¸²
                const currentRoomId = roomId || window.currentCfgRoom || document.getElementById('cfg-room')?.value || 'room-a';

                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² map à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
                if (!window.ROOM_TO_MAC_MAP || !window.MAC_PIN_NAMES) return;

                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                const map = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};

                document.querySelectorAll('#series-toggle input[data-series]').forEach(input => {
                    const ds = input.dataset.series;
                    if (ds.startsWith('pin')) {
                        const pin = ds.replace('pin', '');
                        const name = map[`name_pin_${pin}`] || `Pin ${pin}`;
                        const labelNode = input.parentNode.childNodes;
                        labelNode.forEach(node => {
                            if (node.nodeType === Node.TEXT_NODE) node.nodeValue = ` ${name}`;
                        });
                    }
                });
                updateSeriesSummary?.();
            }
            const seriesBtn = document.getElementById('series-dropdown-btn');
            const seriesPanel = document.getElementById('series-dropdown-panel');

            seriesBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                seriesPanel.classList.toggle('hidden');
            });
            // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ label à¸‚à¹‰à¸²à¸‡ à¹† checkbox (à¹„à¸¡à¹ˆà¹€à¸­à¸² icon/element à¸¥à¸¹à¸)
            function getLabelTextFrom(el) {
                const label = el.closest('label');
                if (!label) return '';
                return Array.from(label.childNodes)
                    .filter(n => n.nodeType === Node.TEXT_NODE)
                    .map(n => n.nodeValue.trim())
                    .join(' ')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
            }

            function summarizeList(list, maxChars = 48) {
                const joined = list.join(', ');
                if (joined.length <= maxChars) return joined;
                let out = '', used = 0;
                for (const item of list) {
                    const next = out ? ', ' + item : item;
                    if ((out + next).length > maxChars) break;
                    out += next; used++;
                }
                const remain = list.length - used;
                return out + (remain > 0 ? ` +${remain} more` : '');
            }

            function updateSeriesSummary() {
                const btn = document.getElementById('series-dropdown-btn');
                if (!btn) return;
                const textSpan = btn.querySelector('span');

                const cbs = document.querySelectorAll('#series-toggle input[type="checkbox"][data-series]');
                const selectedLabels = [];
                cbs.forEach(cb => {
                    if (cb.checked) {
                        selectedLabels.push(getLabelTextFrom(cb));
                    }
                });

                const thresholdsOn = !!document.getElementById('toggle-thresholds')?.checked;

                let summary;
                if (selectedLabels.length === 0) {
                    summary = 'Select Series & Options';
                } else {
                    summary = `Selected (${selectedLabels.length}): ${summarizeList(selectedLabels, 44)}`;
                }
                if (thresholdsOn) summary += ' Â· Thresholds';

                textSpan.textContent = summary;
            }

            document.addEventListener('click', (e) => {
                if (!seriesBtn.contains(e.target) && !seriesPanel.contains(e.target)) {
                    seriesPanel.classList.add('hidden');
                }
            });
            document.querySelectorAll('#series-toggle input[type="checkbox"]').forEach(inp => {
                inp.addEventListener('change', updateSeriesSummary);
            });

            seriesBtn.addEventListener('click', () => {
                updateSeriesSummary();
            });

            updateSeriesSummary();

            function updateGlobalMappings(data) {
                window.DEVICE_MAP_DATA = data || {};
                const mac2room = {};
                const room2mac = {};
                const roomNames = {};

                for (const [k, v] of Object.entries(window.DEVICE_MAP_DATA)) {
                    const roomKey = canonicalRoomKey(k);
                    if (!roomKey) continue;

                    const mac = normalizeMAC(v);
                    if (mac) {
                        mac2room[mac] = roomKey;
                        room2mac[roomKey] = mac;
                    }
                }
                roomNames['room-a'] = data.nameA || 'Room A';
                roomNames['room-b'] = data.nameB || 'Room B';
                roomNames['room-c'] = data.nameC || 'Room C';
                roomNames['room-d'] = data.nameD || 'Room D';

                window.MAC_TO_ROOM_MAP = mac2room;
                window.ROOM_TO_MAC_MAP = room2mac;
                window.ROOM_NAMES = roomNames;

                console.log('[Device Map] mac->room', mac2room);
                console.log('[Device Map] room->mac', room2mac);
                console.log('[Device Map] room->name', roomNames);
            }
            async function loadDeviceMapFromServer() {
                const res = await fetch('/api/device-map', { cache: 'no-store' });
                if (!res.ok) throw new Error('fetch /api/device-map failed');
                updateGlobalMappings(await res.json());
            }
            // à¹ƒà¸«à¹‰à¹„à¸Ÿà¸¥à¹Œà¸­à¸·à¹ˆà¸™à¹€à¸£à¸µà¸¢à¸à¹„à¸”à¹‰
            function getRoomToMacFromStorage() {
                return window.ROOM_TO_MAC_MAP || {};
            }
            async function fetchConfigFromDevice(roomId, timeoutMs = 5000) {
                if (typeof uibuilder === 'undefined') {
                    throw new Error('uibuilder is not available');
                }
                const roomToMac = getRoomToMacFromStorage();
                const mac = normalizeMAC(roomToMac?.[roomId] || '');

                if (!mac) {
                    throw new Error(`No MAC address mapped for ${roomId}`);
                }

                const requestId = uuid();

                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        delete window._configPromises[requestId];
                        reject(new Error(`Config request for ${roomId} timed out after ${timeoutMs}ms`));
                    }, timeoutMs);

                    window._configPromises[requestId] = {
                        resolve: (data) => {
                            clearTimeout(timeoutId);
                            resolve(data);
                            delete window._configPromises[requestId];
                        },
                        reject: (err) => {
                            clearTimeout(timeoutId);
                            reject(err);
                            delete window._configPromises[requestId];
                        }
                    };

                    uibuilder.send({
                        topic: `esp32/control/${roomId}/request_config`,
                        payload: { command: "get_config", room: roomId, mac, requestId }
                    });
                    console.log(`[ConfigFetch] Sent config request for ${roomId} with ID: ${requestId}`);
                });
            }
            function clearSettingsFormFor(room, mac) {
                document.getElementById('cfg-mac').textContent = mac || '';
                const macLabel = document.getElementById('cfg-mac');
                if (macLabel) macLabel.textContent = mac || '';
                const ids = [
                    'ip', 'subnet', 'gateway', 'dns',
                    'mqtt-broker', 'mqtt-port', 'mqtt-user', 'mqtt-pass',
                    'temp-crit-low', 'temp-warn-low', 'temp-warn-high', 'temp-crit-high',
                    'hum-crit-low', 'hum-warn-low', 'hum-warn-high', 'hum-crit-high'
                ];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                notificationEmails = [];
                telegramChatIds = [];
                renderEmailList();
                renderChatIdList();
                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !(mac && mac !== 'â€”');
            }
            function setLed(el, colorClass) {
                if (!el) return;
                el.classList.remove('led--green', 'led--red', 'led--gray');
                el.classList.add('led', colorClass);
            }
            async function showConfigPopup() {
                updateRoomSelectorStatus();
                const el = document.getElementById('modal-settings');
                if (!el) return;
                openModal('modal-settings');

                const sel = document.getElementById('cfg-room');
                if (sel) sel.value = currentCfgRoom;

                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');
                clearSettingsFormFor(currentCfgRoom, mac);

                const dot = document.getElementById(`status-dot-${currentCfgRoom}`);
                const isOnline = dot && dot.classList.contains('led--green');

                const saveBtn = document.getElementById('btn-save-settings');

                if (isOnline) {
                    if (saveBtn) saveBtn.disabled = false;
                    try {
                        await requestConfigFromDevice(currentCfgRoom);
                    } catch (err) {
                        console.warn('[Settings] requestConfigFromDevice failed:', err);
                        scheduleLocalFallback(currentCfgRoom);
                    }
                } else {
                    if (saveBtn) saveBtn.disabled = true;
                    console.log(`[Settings] Room ${currentCfgRoom} is offline. Form will remain empty.`);
                }
            }
            function hideConfigPopup() {
                closeModal('modal-settings');
            }
            document.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => {
                    const roomId = card.dataset.room;
                    if (roomId) openRoomDetailModal(roomId);
                });
            });
            document.getElementById('qa-settings')?.addEventListener('click', showConfigPopup);
            document.addEventListener('click', e => {
                if (e.target?.dataset?.close === 'modal-settings') hideConfigPopup();
            });

            document.querySelectorAll('.config-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    const name = btn.dataset.tab;
                    document.querySelectorAll('.config-tab').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.config-section').forEach(s => s.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + name)?.classList.add('active');
                });
            });
            document.getElementById('cfg-room')?.addEventListener('change', e => {
                currentCfgRoom = e.target.value;
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const mac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');

                clearSettingsFormFor(currentCfgRoom, mac);

                const dot = document.getElementById(`status-dot-${currentCfgRoom}`);
                const isOnline = dot && dot.classList.contains('led--green');
                const saveBtn = document.getElementById('btn-save-settings');

                if (isOnline) {
                    if (saveBtn) saveBtn.disabled = false;
                    (async () => {
                        try {
                            await requestConfigFromDevice(currentCfgRoom);
                        } catch (err) {
                            console.warn('[Settings] requestConfigFromDevice failed:', err);
                            scheduleLocalFallback(currentCfgRoom);
                        }
                    })();
                } else {
                    if (saveBtn) saveBtn.disabled = true;
                }
            });
            function updateRoomSelectorStatus() {
                const roomSelector = document.getElementById('cfg-room');
                if (!roomSelector) return;

                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                let firstOnlineRoom = null;

                rooms.forEach(roomId => {
                    const option = roomSelector.querySelector(`option[value="${roomId}"]`);
                    const statusDot = document.getElementById(`status-dot-${roomId}`);
                    const isOnline = statusDot && statusDot.classList.contains('led--green');
                    console.log(roomId, { option, statusDot, isOnline });
                });
                const currentSelectedOption = roomSelector.querySelector(`option[value="${roomSelector.value}"]`);
                if (currentSelectedOption && currentSelectedOption.disabled && firstOnlineRoom) {
                    console.log(`[Settings] Current room '${roomSelector.value}' is offline. Switching to first available: '${firstOnlineRoom}'`);
                    roomSelector.value = firstOnlineRoom;
                    currentCfgRoom = firstOnlineRoom;
                    const roomToMac = Object.fromEntries(
                        Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                    );
                    const newMac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');
                    clearSettingsFormFor(currentCfgRoom, newMac);
                    requestConfigFromDevice(currentCfgRoom);
                    scheduleLocalFallback(currentCfgRoom);
                }
            }
            // ===== Storage helpers=====
            async function loadAllConfigs(room) {
                const cfg = await fetchConfig(room);
                // Ethernet
                document.getElementById('ip').value = cfg.ethernet?.ip || '';
                document.getElementById('subnet').value = cfg.ethernet?.mask || '';
                document.getElementById('gateway').value = cfg.ethernet?.gw || '';
                document.getElementById('dns').value = cfg.ethernet?.dns || '';
                // MQTT
                document.getElementById('mqtt-broker').value = cfg.mqtt?.broker || '';
                document.getElementById('mqtt-port').value = cfg.mqtt?.port || '';
                document.getElementById('mqtt-user').value = cfg.mqtt?.user || '';
                document.getElementById('mqtt-pass').value = cfg.mqtt?.pass || '';
                // Alerts
                const a = cfg.alerts || getAlertDefaults();
                document.getElementById('temp-crit-low').value = a.temp.critLow;
                document.getElementById('temp-warn-low').value = a.temp.warnLow;
                document.getElementById('temp-warn-high').value = a.temp.warnHigh;
                document.getElementById('temp-crit-high').value = a.temp.critHigh;
                document.getElementById('hum-crit-low').value = a.hum.critLow;
                document.getElementById('hum-warn-low').value = a.hum.warnLow;
                document.getElementById('hum-warn-high').value = a.hum.warnHigh;
                document.getElementById('hum-crit-high').value = a.hum.critHigh;
                // Notifications
                notificationEmails = cfg.notifications?.emails || [];
                telegramChatIds = cfg.notifications?.telegram_chat_ids || [];
                renderEmailList();
                renderChatIdList();
            }
            function renderList(ulEl, items, type) {
                ulEl.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>${item}</span><button class="remove-item-btn btn" data-type="${type}" data-val="${item}"><span class="config-icon"><i class="fa-solid fa-trash"></i></span></button>`;
                    ulEl.appendChild(li);
                });
            }
            function renderEmailList() { renderList(document.getElementById('email-list'), notificationEmails, 'email'); }
            function renderChatIdList() { renderList(document.getElementById('chat-id-list'), telegramChatIds, 'chat'); }

            document.getElementById('add-email-btn')?.addEventListener('click', () => {
                const inp = document.getElementById('new-email-input');
                const v = (inp.value || '').trim().toLowerCase();
                if (v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v) && !notificationEmails.includes(v)) {
                    notificationEmails.push(v); renderEmailList(); inp.value = '';
                }
            });
            document.getElementById('email-list')?.addEventListener('click', e => {
                const btn = e.target.closest('.remove-item-btn');
                if (!btn) return;
                if (btn.dataset.type === 'email') {
                    notificationEmails = notificationEmails.filter(x => x !== btn.dataset.val);
                    renderEmailList();
                }
            });
            document.getElementById('add-chat-id-btn')?.addEventListener('click', () => {
                const inp = document.getElementById('new-chat-id-input');
                const v = (inp.value || '').trim();
                if (v && /^-?\d+$/.test(v) && !telegramChatIds.includes(v)) {
                    telegramChatIds.push(v); renderChatIdList(); inp.value = '';
                }
            });
            document.getElementById('chat-id-list')?.addEventListener('click', e => {
                const btn = e.target.closest('.remove-item-btn');
                if (!btn) return;
                if (btn.dataset.type === 'chat') {
                    telegramChatIds = telegramChatIds.filter(x => x !== btn.dataset.val);
                    renderChatIdList();
                }
            });
            function scheduleLocalFallback(room) {
                const lastId = (window._lastReqPerRoom || {})[room];
                setTimeout(async () => {
                    if (!lastId) return;
                    if ((window._lastReqPerRoom || {})[room] !== lastId) return;

                    const hasAnyValue = ['ip', 'subnet', 'gateway', 'dns', 'mqtt-broker', 'mqtt-port', 'mqtt-user', 'mqtt-pass']
                        .some(id => (document.getElementById(id)?.value || '').trim() !== '');

                    if (!hasAnyValue) {
                        console.warn(`[Settings] fallback: no response for ${room} after ${CFG_REQUEST_TIMEOUT_MS}ms â€” load local values`);
                        await (room);
                    }

                    delete window._cfgReqs[lastId];
                    window._lastReqPerRoom[room] = null;
                    const sel = document.getElementById('cfg-room');
                    if (sel) { sel.disabled = false; sel.classList.remove('opacity-60', 'cursor-not-allowed'); }
                }, CFG_REQUEST_TIMEOUT_MS + 300);
            }
            async function loadAllForRoom(room) {
                const dot = document.getElementById(`status-dot-${room}`);
                const isOnline = !!(dot && dot.classList.contains('led--green'));
                if (!isOnline) {
                    clearSettingsFormFor(room, '');
                    return;
                }

                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[room] || '');
                const macEl = document.getElementById('cfg-mac');
                if (macEl) macEl.textContent = mac || 'â€”';

                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !mac;

                await loadAllConfigs(room);
            }
            document.getElementById('btn-save-settings')?.addEventListener('click', async () => {
                const room = currentCfgRoom;

                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[room] || '');
                if (!mac) {
                    showQAStatus(`âŒ à¸«à¹‰à¸­à¸‡ ${room.toUpperCase()} à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ MAC (à¸à¸£à¸¸à¸“à¸²à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹ƒà¸™ Device Map)`);
                    return;
                }

                const v1 = validateEthernet(room); if (!v1.ok) { showQAStatus(v1.msg); return; }
                const v2 = validateMqtt(); if (!v2.ok) { showQAStatus(v2.msg); return; }
                const v3 = validateAlerts(); if (!v3.ok) { showQAStatus(v3.msg); return; }
                const v4 = validateNotifications(); if (!v4.ok) { showQAStatus(v4.msg); return; }

                const settings = collectAllSettings(room);
                const requestId = uuid();

                if (typeof uibuilder !== 'undefined') {
                    uibuilder.send({
                        topic: `esp32/control/${room}/set_config`,
                        payload: { command: "set_config", room, mac, requestId, settings }
                    });
                }
                showQAStatus(`âœ… à¸ªà¹ˆà¸‡à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹„à¸›à¸¢à¸±à¸‡ ${room.toUpperCase()} (${mac}) à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢`);
                hideConfigPopup();
            });
            function collectAllSettings(room) {
                const ethernet = {
                    ip: document.getElementById('ip').value.trim(),
                    subnet: document.getElementById('subnet').value.trim(),
                    gateway: document.getElementById('gateway').value.trim(),
                    dns: document.getElementById('dns').value.trim()
                };
                const mqtt = {
                    broker: document.getElementById('mqtt-broker').value.trim(),
                    port: document.getElementById('mqtt-port').value.trim(),
                    user: document.getElementById('mqtt-user').value.trim(),
                    pass: document.getElementById('mqtt-pass').value.trim()
                };
                const alerts = {
                    temp: {
                        critLow: parseFloat(document.getElementById('temp-crit-low').value) || null,
                        warnLow: parseFloat(document.getElementById('temp-warn-low').value) || null,
                        warnHigh: parseFloat(document.getElementById('temp-warn-high').value) || null,
                        critHigh: parseFloat(document.getElementById('temp-crit-high').value) || null,
                    },
                    hum: {
                        critLow: parseFloat(document.getElementById('hum-crit-low').value) || null,
                        warnLow: parseFloat(document.getElementById('hum-warn-low').value) || null,
                        warnHigh: parseFloat(document.getElementById('hum-warn-high').value) || null,
                        critHigh: parseFloat(document.getElementById('hum-crit-high').value) || null,
                    }
                };
                const notifications = {
                    emails: notificationEmails,
                    telegram_chat_ids: telegramChatIds
                };
                return { ethernet, mqtt, alerts, notifications, room };
            }
            async function requestConfigFromDevice(room) {
                // UI: à¸¥à¹‡à¸­à¸ Dropdown à¸‚à¸“à¸°à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”
                const sel = document.getElementById('cfg-room');
                if (sel) { sel.disabled = true; sel.classList.add('opacity-60', 'cursor-not-allowed'); }

                try {
                    console.log(`[Settings] Requesting config for ${room} using the Promise-based fetcher.`);
                    const configData = await fetchConfigFromDevice(room);
                    const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                    const mac = normalizeMAC(roomToMac?.[room] || '');
                    applyConfigFieldsToUI(configData, mac);

                } catch (error) {
                    console.warn(`[Settings] Could not fetch live config for ${room}. Error: ${error.message}`);
                    showPopup(`à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ ${room} à¹„à¸”à¹‰ à¸­à¸²à¸ˆà¸ˆà¸°à¸­à¸­à¸Ÿà¹„à¸¥à¸™à¹Œà¸­à¸¢à¸¹à¹ˆ`, { type: 'warn' });

                } finally {
                    if (sel) { sel.disabled = false; sel.classList.remove('opacity-60', 'cursor-not-allowed'); }
                }
            }
            function normalizeMAC(s) {
                if (!s) return '';
                const hex = String(s).toUpperCase().replace(/[^0-9A-F]/g, '');
                if (hex.length !== 12) return '';
                return hex.match(/.{2}/g).join(':');
            }
            async function fetchConfig(room) {
                const res = await fetch(`/api/config?roomId=${encodeURIComponent(room)}`);
                if (!res.ok) throw new Error('à¹‚à¸«à¸¥à¸” config à¹„à¸¡à¹ˆà¹„à¸”à¹‰');
                return (await res.json()) || {};
            }

            async function persistConfig(room, config) {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: room, config })
                });
                const data = await res.json();
                if (!data.ok) throw new Error('à¸šà¸±à¸™à¸—à¸¶à¸ config à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');
            }
            function findMACInObject(obj) {
                const seen = new Set();
                const re = /([0-9A-F]{2}([-:])){5}[0-9A-F]{2}/i;
                function walk(v) {
                    if (v == null) return '';
                    if (typeof v === 'string') {
                        const m = v.match(re);
                        return m ? normalizeMAC(m[0]) : '';
                    }
                    if (typeof v === 'number' || typeof v === 'boolean') return '';
                    if (typeof v === 'object') {
                        if (seen.has(v)) return '';
                        seen.add(v);
                        const prefer = ['mac_address', 'mac', 'macAddr', 'device_mac', 'deviceMac', 'wifi_mac', 'eth_mac'];
                        for (const k of prefer) {
                            if (k in v) {
                                const got = walk(v[k]);
                                if (got) return got;
                            }
                        }
                        for (const key of Object.keys(v)) {
                            const got = walk(v[key]);
                            if (got) return got;
                        }
                    }
                    return '';
                }
                return walk(obj);
            }

            function applyRoomNames() {
                const names = window.ROOM_NAMES || {};
                for (const roomId in names) {
                    const name = names[roomId];
                    const cardHeader = document.querySelector(`.room-card[data-room="${roomId}"] h3`);
                    if (cardHeader) cardHeader.textContent = name;

                    const option = document.querySelector(`#cfg-room option[value="${roomId}"]`);
                    if (option) option.textContent = name;

                    const rebootOption = document.querySelector(`#modal-reboot select[name="target"] option[value="${roomId}"]`);
                    if (rebootOption) rebootOption.textContent = name;

                    const exportOption = document.querySelector(`#modal-export select[name="room"] option[value="${roomId}"]`);
                    if (exportOption) exportOption.textContent = name;
                }
            }
            console.table(window.MAC_TO_ROOM_MAP);
            window._roomTimeouts = {};
            const ROOM_TIMEOUT_MS = 120000;
            window.RoomStore = {
                'room-a': { selectedPin: 'OVERALL', sensors: {} },
                'room-b': { selectedPin: 'OVERALL', sensors: {} },
                'room-c': { selectedPin: 'OVERALL', sensors: {} },
                'room-d': { selectedPin: 'OVERALL', sensors: {} },
            };

            function loadMapForm() {
                const map = window.DEVICE_MAP_DATA;
                const form = document.getElementById('form-device-map');
                if (!form) return;
                form.mac_room_a.value = map.roomA || '';
                form.name_room_a.value = map.nameA || '';
                form.mac_room_b.value = map.roomB || '';
                form.name_room_b.value = map.nameB || '';
                form.mac_room_c.value = map.roomC || '';
                form.name_room_c.value = map.nameC || '';
                form.mac_room_d.value = map.roomD || '';
                form.name_room_d.value = map.nameD || '';
            }
            const getOrCreateTooltip = (chart) => {
                let tooltipEl = document.getElementById('custom-tooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'custom-tooltip';
                    tooltipEl.className = 'custom-tooltip';
                    document.body.appendChild(tooltipEl);
                }
                return tooltipEl;
            };

            const customTooltipHandler = (context) => {
                const tooltipEl = getOrCreateTooltip(context.chart);
                const tooltipModel = context.tooltip;

                if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }

                const tempChart = window._detailCharts.temp;
                const rhChart = window._detailCharts.rh;
                if (!tooltipModel.dataPoints.length || !tempChart || !rhChart) {
                    return;
                }

                const timestamp = tooltipModel.dataPoints[0].parsed.x;

                const findDataForTimestamp = (chart, ts) => {
                    const points = [];
                    chart.data.datasets.forEach((dataset, i) => {
                        if (chart.isDatasetVisible(i)) {
                            const point = dataset.data.find(p => p.x === ts);
                            if (point) {
                                points.push({
                                    value: point.y,
                                    label: dataset.label,
                                    pinId: dataset.pinId,
                                    dataType: dataset.dataType,
                                    color: dataset.borderColor,
                                    unit: dataset.dataType === 'rh' ? '%' : 'Â°C'
                                });
                            }
                        }
                    });
                    return points;
                };

                const tempPoints = findDataForTimestamp(tempChart, timestamp);
                const rhPoints = findDataForTimestamp(rhChart, timestamp);
                const combinedPoints = [...tempPoints, ...rhPoints];

                let innerHtml = '';
                if (combinedPoints.length > 0) {
                    const title = new Date(timestamp).toLocaleString('en-GB', {
                        year: 'numeric',
                        month: 'long',  // August
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Bangkok',
                    });
                    innerHtml = `<div class="custom-tooltip-header">${title}</div>`;
                    innerHtml += '<div class="custom-tooltip-body">';

                    const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                    const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                    const pinMap = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                    const getDynamicPinLabel = (pin) => (pinMap[`name_pin_${pin}`]?.trim()) || `Pin ${pin}`;

                    combinedPoints.forEach(point => {
                        let dynamicLabel;
                        if (point.dataType === 'dew') {
                            dynamicLabel = 'Dew Point(Overall)';
                        } else if (point.pinId === 'overall') {
                            dynamicLabel = `${point.dataType === 'temp' ? 'Temp' : 'RH'} (Overall)`;
                        } else {
                            dynamicLabel = `${point.dataType === 'temp' ? 'Temp' : 'RH'} ${getDynamicPinLabel(point.pinId)}`;
                        }

                        innerHtml += `
                    <div class="tooltip-line">
                        <span class="tooltip-color-box" style="background-color:${point.color}"></span>
                        <span>${dynamicLabel}: ${point.value.toFixed(1)} ${point.unit}</span>
                    </div>
                    `;
                    });
                    innerHtml += '</div>';
                }

                tooltipEl.innerHTML = innerHtml;

                const position = context.chart.canvas.getBoundingClientRect();
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
            };
            function initializeDetailCharts() {
                const tempCtx = document.getElementById('detail-chart-temp')?.getContext('2d');
                const rhCtx = document.getElementById('detail-chart-rh')?.getContext('2d');
                if (!tempCtx || !rhCtx) return;

                const createTimeScaleOptions = (chartType) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'dd MMM yyyy, HH:mm',
                                displayFormats: { hour: 'HH:mm', day: 'dd MMM' }
                            },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.06)' }
                        },
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.12)' }
                        }
                    },
                    plugins: {
                        htmlLegend: {
                            containerID: chartType === 'temp' ? 'legend-container-temp' : 'legend-container-rh'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false,
                            mode: 'index',
                            intersect: false,
                            external: customTooltipHandler,
                            usePointStyle: true,
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const unit = context.chart.canvas.id.includes('rh') ? '%' : 'Â°C';
                                        label += `${context.parsed.y.toFixed(1)} ${unit}`;
                                    }
                                    return label;
                                },
                                labelPointStyle: function (context) {
                                    return {
                                        pointStyle: 'rect',
                                        rotation: 0
                                    };
                                }
                            }
                        },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                            limits: { x: {} }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' },
                    elements: { point: { radius: 0 } }
                });

                const tempOptions = createTimeScaleOptions('temp');
                tempOptions.scales.y.min = 0;
                tempOptions.scales.y.max = 40;

                window._detailCharts.temp = new Chart(tempCtx, {
                    type: 'line',
                    data: { datasets: [] },
                    options: tempOptions
                });

                const rhOptions = createTimeScaleOptions('rh');
                rhOptions.scales.y.min = 0;
                rhOptions.scales.y.max = 100;

                window._detailCharts.rh = new Chart(rhCtx, {
                    type: 'line',
                    data: { datasets: [] },
                    options: rhOptions
                });
            }

            // ---------- VALIDATORS ----------
            function isValidIP(ip) {
                const re = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
                return re.test(String(ip || '').trim());
            }
            function isValidHostname(h) {
                const re = /^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9-]*[A-Za-z0-9])$/;
                return re.test(String(h || '').trim());
            }
            function isValidPort(p) {
                const n = Number(p); return Number.isInteger(n) && n >= 1 && n <= 65535;
            }
            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
            }
            function isValidChatId(id) {
                return /^-?\d+$/.test(String(id || '').trim());
            }
            function parseBrokerHost(broker) {
                if (!broker) return '';
                const withProto = broker.startsWith('mqtt://') || broker.startsWith('ws://') || broker.startsWith('wss://')
                    ? broker : `mqtt://${broker}`;
                try { return new URL(withProto).hostname; } catch { return ''; }
            }

            function validateEthernet(room) {
                const ip = document.getElementById('ip').value.trim();
                const mask = document.getElementById('subnet').value.trim();
                const gw = document.getElementById('gateway').value.trim();
                const dns = document.getElementById('dns').value.trim();

                if (!isValidIP(ip)) return { ok: false, msg: 'âŒ IP Address à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' };
                if (!isValidIP(mask)) return { ok: false, msg: 'âŒ Subnet Mask à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' };
                if (!isValidIP(gw)) return { ok: false, msg: 'âŒ Gateway à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' };
                if (!isValidIP(dns)) return { ok: false, msg: 'âŒ DNS à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' };
                return { ok: true };
            }
            function validateMqtt() {
                const broker = document.getElementById('mqtt-broker').value.trim();
                const port = document.getElementById('mqtt-port').value.trim();
                if (!broker) return { ok: false, msg: 'âŒ Broker URL/Host à¸§à¹ˆà¸²à¸‡' };
                const host = parseBrokerHost(broker);
                if (!(isValidIP(host) || isValidHostname(host)))
                    return { ok: false, msg: 'âŒ Broker à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ IP à¸«à¸£à¸·à¸­ Hostname à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ (à¹€à¸Šà¹ˆà¸™ 192.168.1.10 à¸«à¸£à¸·à¸­ my-broker.local)' };
                if (!isValidPort(port)) return { ok: false, msg: 'âŒ Port à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚ 1â€“65535' };
                return { ok: true };
            }
            function validateAlerts() {
                const t = {
                    cl: +document.getElementById('temp-crit-low').value,
                    wl: +document.getElementById('temp-warn-low').value,
                    wh: +document.getElementById('temp-warn-high').value,
                    ch: +document.getElementById('temp-crit-high').value
                };
                const h = {
                    cl: +document.getElementById('hum-crit-low').value,
                    wl: +document.getElementById('hum-warn-low').value,
                    wh: +document.getElementById('hum-warn-high').value,
                    ch: +document.getElementById('hum-crit-high').value
                };
                const asc = (o) => [o.cl, o.wl, o.wh, o.ch].every(v => !isNaN(v)) && o.cl < o.wl && o.wl < o.wh && o.wh < o.ch;
                if (!asc(t)) return { ok: false, msg: 'âŒ à¸Šà¹ˆà¸§à¸‡ Temperature à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡: Crit Low < Warn Low < Warn High < Crit High' };
                if (!asc(h)) return { ok: false, msg: 'âŒ à¸Šà¹ˆà¸§à¸‡ Humidity à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸‡: Crit Low < Warn Low < Warn High < Crit High' };
                return { ok: true };
            }
            function validateNotifications() {
                const badEmail = (notificationEmails || []).find(e => !isValidEmail(e));
                if (badEmail) return { ok: false, msg: `âŒ Email à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: ${badEmail}` };
                const badChat = (telegramChatIds || []).find(id => !isValidChatId(id));
                if (badChat) return { ok: false, msg: `âŒ Telegram Chat ID à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: ${badChat}` };
                return { ok: true };
            }
            function showQAStatus(text, opts = {}) {
                const type = opts.type || 'info';
                const timeout = opts.timeout || 4000;
                showPopup(text, { type, timeout });
                const el = document.getElementById('qa-status');
                if (el) el.textContent = text;
            }
            //==== Helpers =====
            function isNum(v) { return typeof v === 'number' && !isNaN(v); }
            function fmt1(v) { return isNum(v) ? v.toFixed(1) : 'â€”'; }
            function getNumByKeys(obj, keys) {
                for (const k of keys) {
                    const v = obj?.[k];
                    if (isNum(v)) return v;
                }
                return NaN;
            }
            function setRoomCardsBlank(roomId, isBlank) {
                const tempValEl = document.getElementById(`temp-${roomId}`);
                const rhValEl = document.getElementById(`rh-${roomId}`);
                const tempCard = tempValEl?.parentElement;
                const rhCard = rhValEl?.parentElement;
                const gridWrap = tempCard?.parentElement;
                const uptimeTextWrap = document.getElementById(`uptime-${roomId}`)?.parentElement;
                const uptimeBarWrap = document.getElementById(`uptime-bar-${roomId}`)?.parentElement?.parentElement;
                const chartEl = document.getElementById(`chart-${roomId}`);
                const chartWrap = chartEl?.parentElement;
                const updatedEl = document.getElementById(`updated-${roomId}`);

                if (isBlank) {
                    gridWrap?.classList.add('hidden');
                    tempCard?.classList.add('hidden');
                    rhCard?.classList.add('hidden');
                    uptimeTextWrap?.classList.add('hidden');
                    uptimeBarWrap?.classList.add('hidden');
                    chartWrap?.classList.add('hidden');
                    if (tempValEl) tempValEl.textContent = 'â€”';
                    if (rhValEl) rhValEl.textContent = 'â€”';
                    if (updatedEl) updatedEl.textContent = '';
                    const ch = window._roomCharts?.[`chart-${roomId}`];
                    if (ch) {
                        ch.data.labels = [];
                        ch.data.datasets[0].data = [];
                        ch.update('');
                    }
                } else {
                    gridWrap?.classList.remove('hidden');
                    tempCard?.classList.remove('hidden');
                    rhCard?.classList.remove('hidden');
                    uptimeTextWrap?.classList.remove('hidden');
                    uptimeBarWrap?.classList.remove('hidden');
                    chartWrap?.classList.remove('hidden');
                }
            }
            function mergeIntoChart(chart, newLabels, newSeriesTuples) {
                if (!chart.data.datasets || chart.data.datasets.length === 0) {
                    chart.data.datasets = newSeriesTuples.map(([lbl, arr, style]) => ({
                        label: lbl,
                        data: [],
                        borderWidth: style?.borderWidth ?? 2,
                        tension: style?.tension ?? 0.35,
                        fill: style?.fill ?? false,
                        borderColor: style?.borderColor,
                        backgroundColor: style?.backgroundColor,
                        borderDash: style?.borderDash,
                    }));
                }

                const existing = chart.data.labels || [];
                const posMap = new Map(existing.map((l, i) => [l, i]));

                newLabels.forEach((lbl, i) => {
                    if (!posMap.has(lbl)) {
                        posMap.set(lbl, chart.data.labels.push(lbl) - 1);
                        chart.data.datasets.forEach((ds, dsIdx) => {
                            ds.data.push(newSeriesTuples[dsIdx][1][i] ?? null);
                        });
                    } else {
                        const idx = posMap.get(lbl);
                        chart.data.datasets.forEach((ds, dsIdx) => {
                            ds.data[idx] = newSeriesTuples[dsIdx][1][i] ?? ds.data[idx];
                        });
                    }
                });

                chart.update('none');
            }
            function applyConfigFieldsToUI(data, incomingMac) {
                const currentRoomId = document.getElementById('cfg-room').value;
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const expectedMac = normalizeMAC(roomToMac[currentRoomId] || '');

                // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸²à¸•à¸£à¸‡à¸à¸±à¸šà¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸­à¸¢à¸¹à¹ˆà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
                if (incomingMac !== expectedMac) {
                    console.warn(`[Settings] Dropping stale config data. Expected MAC: ${expectedMac}, but got: ${incomingMac}`);
                    return;
                }

                if (data.ethernet) {
                    document.getElementById('ip').value = data.ethernet.eth_ip || data.ethernet.ip || '';
                    document.getElementById('subnet').value = data.ethernet.eth_subnet || data.ethernet.subnet || '';
                    document.getElementById('gateway').value = data.ethernet.eth_gateway || data.ethernet.gateway || '';
                    document.getElementById('dns').value = data.ethernet.eth_dns || data.ethernet.dns || '';
                }
                if (data.mqtt) {
                    document.getElementById('mqtt-broker').value = data.mqtt.broker || '';
                    document.getElementById('mqtt-port').value = data.mqtt.port || '';
                    document.getElementById('mqtt-user').value = data.mqtt.user || '';
                    document.getElementById('mqtt-pass').value = data.mqtt.password || data.mqtt.pass || '';
                }
                if (data.alerts) {
                    document.getElementById('temp-crit-low').value = data.alerts.temp_crit_low ?? '';
                    document.getElementById('temp-warn-low').value = data.alerts.temp_warn_low ?? '';
                    document.getElementById('temp-warn-high').value = data.alerts.temp_warn_high ?? '';
                    document.getElementById('temp-crit-high').value = data.alerts.temp_crit_high ?? '';

                    document.getElementById('hum-crit-low').value = data.alerts.hum_crit_low ?? '';
                    document.getElementById('hum-warn-low').value = data.alerts.hum_warn_low ?? '';
                    document.getElementById('hum-warn-high').value = data.alerts.hum_warn_high ?? '';
                    document.getElementById('hum-crit-high').value = data.alerts.hum_crit_high ?? '';
                }

                if (data.notifications) {
                    notificationEmails = Array.isArray(data.notifications.emails) ? data.notifications.emails : [];
                    telegramChatIds = Array.isArray(data.notifications.telegram_chat_ids) ? data.notifications.telegram_chat_ids : [];
                    renderEmailList();
                    renderChatIdList();
                }

                const macLabel = document.getElementById('cfg-mac');
                if (macLabel && incomingMac) macLabel.textContent = incomingMac;
                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !(incomingMac && incomingMac !== '--:--:--:--:--:--');
            }

            function initAllRoomsOffline() {
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                for (const roomId of rooms) {
                    const dot = document.getElementById(`status-dot-${roomId}`);
                    if (dot) {
                        setLed(dot, 'led--red');
                    }
                    const updatedEl = document.getElementById(`updated-${roomId}`);
                    if (updatedEl) updatedEl.textContent = '';
                    setRoomCardsBlank(roomId, true);
                    const chartId = `chart-${roomId}`;
                    const ch = window._roomCharts?.[chartId];
                    if (ch) {
                        ch.data.labels = [];
                        ch.data.datasets[0].data = [];
                        ch.update('none');
                    }
                }
            }
            function getSensorStyles(value, type) {
                const thresholds = {
                    temp: { critHigh: 32, warnHigh: 28, warnLow: 20, critLow: 18 },
                    hum: { critHigh: 75, warnHigh: 65, warnLow: 40, critLow: 30 }
                };
                const cfg = thresholds[type];
                const normal = (type === 'temp') ? ['from-green-400', 'to-green-500'] : ['from-blue-400', 'to-blue-500'];
                const offline = ['from-slate-500', 'to-slate-600'];
                const warn = ['from-orange-400', 'to-orange-500'];
                const crit = ['from-red-500', 'to-red-600'];
                if (value === null || isNaN(value)) return { status: 'Offline', classes: offline };
                if (value > cfg.critHigh || value < cfg.critLow) return { status: 'Critical', classes: crit };
                if (value > cfg.warnHigh || value < cfg.warnLow) return { status: 'Warning', classes: warn };
                return { status: 'Normal', classes: normal };
            }
            function parseRoomIdFromTopic(topic) {
                if (!topic || typeof topic !== 'string') return null;
                const m = topic.toLowerCase().match(/(^|\/)(room-[abcd])(?=\/|$)/);
                return m ? m[2] : null;
            }
            // ===== Global header status =====

            function updateDeviceStatus(status, ms) {
                const statusText = document.getElementById('status-text');
                const pingTime = document.getElementById('ping-time');

                if (!statusText) return;

                if (status === 'online') {
                    statusText.textContent = '';

                    if (typeof ms === 'number') {
                        if (pingTime) {
                            pingTime.textContent = `(${ms} ms)`;
                            pingTime.classList.remove('hidden');
                        }
                    } else {
                        if (pingTime) pingTime.classList.add('hidden');
                    }
                } else {
                    statusText.textContent = '';
                    if (pingTime) pingTime.classList.add('hidden');
                }
            }

            // ===== Reset a room to offline UI =====
            function resetRoomUI(roomId) {
                console.warn(`No data received for ${roomId} in ${ROOM_TIMEOUT_MS / 1000}s. Setting UI to offline.`);
                const statusDot = document.getElementById(`status-dot-${roomId}`);
                if (statusDot) {
                    setLed(statusDot, 'led--red');
                }
                const updatedEl = document.getElementById(`updated-${roomId}`);
                if (updatedEl) updatedEl.textContent = '';
                setRoomCardsBlank(roomId, true);
                const chartId = `chart-${roomId}`;
                const ch = window._roomCharts?.[chartId];
                if (ch) {
                    ch.data.labels = [];
                    ch.data.datasets[0].data = [];
                    ch.update('none');
                }
            }

            // ===== Per-room UI update =====
            function updateRoomUI(roomId, data) {
                const roomCardEl = document.querySelector(`.room-card[data-room="${roomId}"]`);
                if (roomCardEl) {
                    roomCardEl.classList.remove('hidden');
                }

                const roomTitleEl = document.querySelector(`.room-card[data-room="${roomId}"] h3`);
                if (roomTitleEl) {
                    roomTitleEl.classList.remove('hidden');
                }

                const statusDot = document.getElementById(`status-dot-${roomId}`);
                const updatedEl = document.getElementById(`updated-${roomId}`);
                const tempValEl = document.getElementById(`temp-${roomId}`);
                const rhValEl = document.getElementById(`rh-${roomId}`);
                const uptimeBar = document.getElementById(`uptime-bar-${roomId}`);
                const uptimeTxt = document.getElementById(`uptime-${roomId}`);
                const tempCard = tempValEl?.parentElement;
                const rhCard = rhValEl?.parentElement;
                const hasData =
                    (data.avg_temp != null && !isNaN(data.avg_temp)) ||
                    (data.avg_hum != null && !isNaN(data.avg_hum)) ||
                    (data.uptime_pct != null);
                if (data.status != null) {
                    if (statusDot) {
                        setLed(statusDot, data.status === 'online' ? 'led--green' : 'led--red');
                    }
                    if (data.status === 'offline') {
                        resetRoomUI(roomId);
                        return;
                    }
                } else {
                    if (hasData && statusDot) {
                        setLed(statusDot, 'led--green');
                    }
                }
                if (!hasData) return;
                setRoomCardsBlank(roomId, false);
                if (data.timestamp != null && updatedEl) {
                    const d = new Date(data.timestamp);
                    updatedEl.textContent = d.toLocaleString('th-TH', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                }
                if (data.avg_temp != null && !isNaN(data.avg_temp)) {
                    const tStyles = getSensorStyles(data.avg_temp, 'temp');
                    if (tempValEl && tempCard) {
                        tempValEl.textContent = `${Number(data.avg_temp).toFixed(1)}Â°C`;
                        const sEl = tempCard.querySelector('p:last-of-type');
                        if (sEl) sEl.textContent = tStyles.status;
                        tempCard.classList.remove(
                            'from-green-400', 'to-green-500', 'from-blue-400', 'to-blue-500',
                            'from-orange-400', 'to-orange-500', 'from-red-500', 'to-red-600',
                            'from-slate-500', 'to-slate-600', 'offline-blank'
                        );
                        tempCard.classList.add(...tStyles.classes);
                    }
                }
                if (data.avg_hum != null && !isNaN(data.avg_hum)) {
                    const hStyles = getSensorStyles(data.avg_hum, 'hum');
                    if (rhValEl && rhCard) {
                        rhValEl.textContent = `${Number(data.avg_hum).toFixed(1)}%`;
                        const sEl = rhCard.querySelector('p:last-of-type');
                        if (sEl) sEl.textContent = hStyles.status;
                        rhCard.classList.remove(
                            'from-green-400', 'to-green-500', 'from-blue-400', 'to-blue-500',
                            'from-orange-400', 'to-orange-500', 'from-red-500', 'to-red-600',
                            'from-slate-500', 'to-slate-600', 'offline-blank'
                        );
                        rhCard.classList.add(...hStyles.classes);
                    }
                }
                if (data.uptime_pct != null && uptimeBar && uptimeTxt) {
                    const up = parseFloat(data.uptime_pct) || 0;
                    uptimeTxt.textContent = `${up.toFixed(1)}%`;
                    uptimeBar.style.width = `${up}%`;
                }
                if (data.avg_temp != null && !isNaN(data.avg_temp)) {
                    const chartId = `chart-${roomId}`;
                    ensureChart(chartId);
                    const ch = window._roomCharts?.[chartId];
                    if (ch) {
                        const x = data.timestamp ? new Date(data.timestamp) : new Date();
                        const y = Number(data.avg_temp);
                        const ds = ch.data.datasets[0];
                        if (ds.data.length > 120) {
                            ds.data.shift();
                            ch.data.labels.shift();
                        }
                        ch.data.labels.push(x.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }));
                        ds.data.push(y);
                        ch.update('none');
                    }
                }
            }
            function resetAllRoomStatuses() {
                console.log('[SYSTEM] All room statuses have been reset due to a device map change.');
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                rooms.forEach(roomId => {
                    resetRoomUI(roomId);
                });
            }
            // ===== Charts =====
            window._roomCharts = window._roomCharts || {};
            function ensureChart(id) {
                if (window._roomCharts[id]) return;
                const ctx = document.getElementById(id);
                if (!ctx) return;
                window._roomCharts[id] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Temp (Â°C)', data: [], borderWidth: 2, fill: false, tension: 0.25 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
                });
            }

            function feedChartsFromRows(rows, withAnimation = true) {
                if (!window._detailCharts?.temp || !window._detailCharts?.rh || !Array.isArray(rows)) {
                    return;
                }

                const show = (k) => document.querySelector(`#series-toggle input[data-series="${k}"]`)?.checked ?? true;

                const createSeries = (pin, field) => {
                    return rows
                        .filter(r => String(r.pin).toUpperCase() === String(pin).toUpperCase() && r.timestamp)
                        .map(r => ({
                            x: new Date(r.timestamp).getTime(),
                            y: (typeof r[field] === 'number' && isFinite(r[field])) ? r[field] : null
                        }))
                        .sort((a, b) => a.x - b.x);
                };

                const t_overall = createSeries('OVERALL', 'avg_temp');
                const t25 = createSeries('25', 'avg_temp');
                const t26 = createSeries('26', 'avg_temp');
                const t32 = createSeries('32', 'avg_temp');
                const t33 = createSeries('33', 'avg_temp');
                const dew = rows.filter(r => String(r.pin).toUpperCase() === 'OVERALL' && r.timestamp).map(r => ({ x: new Date(r.timestamp).getTime(), y: dewPointC_Magnus(r.avg_temp, r.avg_hum) })).sort((a, b) => a.x - b.x);
                const h_overall = createSeries('OVERALL', 'avg_hum');
                const h25 = createSeries('25', 'avg_hum');
                const h26 = createSeries('26', 'avg_hum');
                const h32 = createSeries('32', 'avg_hum');
                const h33 = createSeries('33', 'avg_hum');

                const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                const pinMap = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                const pinLabel = (pin) => (pinMap[`name_pin_${pin}`]?.trim()) || `Pin ${pin}`;


                let tempDatasets = [];
                if (show('overall')) tempDatasets.push({ label: 'Temp (Overall)', data: t_overall, borderColor: 'rgba(239,68,68,1)', backgroundColor: 'rgba(239,68,68,0.2)', borderWidth: 3, fill: false, tension: 0.35, pinId: 'overall', dataType: 'temp' });
                if (show('pin25')) tempDatasets.push({ label: `Temp ${pinLabel('25')}`, data: t25, borderColor: 'rgba(252,165,165,0.9)', backgroundColor: 'rgba(252,165,165,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '25', dataType: 'temp' });
                if (show('pin26')) tempDatasets.push({ label: `Temp ${pinLabel('26')}`, data: t26, borderColor: 'rgba(251,146,60,0.9)', backgroundColor: 'rgba(251,146,60,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '26', dataType: 'temp' });
                if (show('pin32')) tempDatasets.push({ label: `Temp ${pinLabel('32')}`, data: t32, borderColor: 'rgba(250,204,21,0.9)', backgroundColor: 'rgba(250,204,21,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '32', dataType: 'temp' });
                if (show('pin33')) tempDatasets.push({ label: `Temp ${pinLabel('33')}`, data: t33, borderColor: 'rgba(147,51,234,0.9)', backgroundColor: 'rgba(147,51,234,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '33', dataType: 'temp' });
                if (show('dew')) tempDatasets.push({ label: 'Dew Point(Overall)', data: dew, borderColor: 'rgba(34,197,94,1)', backgroundColor: 'rgba(34,197,94,0.15)', borderWidth: 2, fill: false, tension: 0.35, pinId: 'overall', dataType: 'dew' });

                let rhDatasets = [];
                if (show('overall')) rhDatasets.push({ label: 'RH (Overall)', data: h_overall, borderColor: 'rgba(59,130,246,1)', backgroundColor: 'rgba(59,130,246,0.2)', borderWidth: 3, fill: false, tension: 0.35, pinId: 'overall', dataType: 'rh' });
                if (show('pin25')) rhDatasets.push({ label: `RH ${pinLabel('25')}`, data: h25, borderColor: 'rgba(191,219,254,0.95)', backgroundColor: 'rgba(191,219,254,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '25', dataType: 'rh' });
                if (show('pin26')) rhDatasets.push({ label: `RH ${pinLabel('26')}`, data: h26, borderColor: 'rgba(147,197,253,0.95)', backgroundColor: 'rgba(147,197,253,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '26', dataType: 'rh' });
                if (show('pin32')) rhDatasets.push({ label: `RH ${pinLabel('32')}`, data: h32, borderColor: 'rgba(96,165,250,0.95)', backgroundColor: 'rgba(96,165,250,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '32', dataType: 'rh' });
                if (show('pin33')) rhDatasets.push({ label: `RH ${pinLabel('33')}`, data: h33, borderColor: 'rgba(59,130,246,0.85)', backgroundColor: 'rgba(59,130,246,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '33', dataType: 'rh' });

                let minTimestamp = Infinity;
                let maxTimestamp = -Infinity;
                const allPoints = rows.map(r => new Date(r.timestamp).getTime()).filter(t => !isNaN(t));

                if (allPoints.length > 0) {
                    minTimestamp = Math.min(...allPoints);
                    maxTimestamp = Math.max(...allPoints);
                }

                const getThresholdLines = (type) => {
                    const isThresholdsVisible = document.getElementById('toggle-thresholds')?.checked ?? true;
                    if (!isThresholdsVisible) {
                        return [];
                    }
                    const roomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                    if (!roomId) return [];
                    const liveConfig = window.liveAlertSettings?.[roomId];
                    if (!liveConfig || !liveConfig[type]) {
                        return [];
                    }

                    const cfg = liveConfig[type];
                    return [
                        { y: cfg.critHigh, color: '#ef4444', dash: [6, 3], label: `Crit High`, width: 2 },
                        { y: cfg.warnHigh, color: '#f59e0b', dash: [6, 3], label: `Warn High`, width: 1 },
                        { y: cfg.warnLow, color: '#f59e0b', dash: [6, 3], label: `Warn Low`, width: 1 },
                        { y: cfg.critLow, color: '#ef4444', dash: [6, 3], label: `Crit Low`, width: 2 }
                    ].filter(line => typeof line.y === 'number' && !isNaN(line.y));
                };

                const tempChart = window._detailCharts.temp;
                const rhChart = window._detailCharts.rh;

                if (isFinite(minTimestamp) && isFinite(maxTimestamp)) {
                    tempChart.options.plugins.zoom.limits.x.min = minTimestamp;
                    tempChart.options.plugins.zoom.limits.x.max = maxTimestamp;
                    rhChart.options.plugins.zoom.limits.x.min = minTimestamp;
                    rhChart.options.plugins.zoom.limits.x.max = maxTimestamp;
                } else {
                    delete tempChart.options.plugins.zoom.limits.x.min;
                    delete tempChart.options.plugins.zoom.limits.x.max;
                    delete rhChart.options.plugins.zoom.limits.x.min;
                    delete rhChart.options.plugins.zoom.limits.x.max;
                }

                tempChart.data.datasets = tempDatasets;
                tempChart.options.plugins.thresholdPlugin = { lines: getThresholdLines('temp') };

                rhChart.data.datasets = rhDatasets;
                rhChart.options.plugins.thresholdPlugin = { lines: getThresholdLines('hum') };

                const animMode = withAnimation ? 'default' : 'none';
                tempChart.update(animMode);
                rhChart.update(animMode);

                tempChart.resetZoom('none');
                rhChart.resetZoom('none');
            }

            ['chart-room-a', 'chart-room-b', 'chart-room-c', 'chart-room-d'].forEach(ensureChart);
            initAllRoomsOffline();
            initializeDetailCharts();
            initDetailToolbar();



            // ===== KPI/Alerts (optional fields) =====
            function dewPointC_Magnus(Tc, RHpct) {
                const T = Number(Tc), RH = Number(RHpct);
                if (!Number.isFinite(T) || !Number.isFinite(RH)) return null;
                const a = 17.62, b = 243.12; // Â°C
                const gamma = (a * T) / (b + T) + Math.log(RH / 100);
                return (b * gamma) / (a - gamma);
            }

            function stats(arr) {
                const clean = arr.filter(v => typeof v === 'number' && !isNaN(v));
                if (!clean.length) return { min: NaN, avg: NaN, max: NaN };
                const sum = clean.reduce((a, b) => a + b, 0);
                return { min: Math.min(...clean), avg: sum / clean.length, max: Math.max(...clean) };
            }
            function updateKPIs(payload) {
                const online = (payload.devices_online != null) ? payload.devices_online : null;
                const total = (payload.devices_total != null) ? payload.devices_total : 4;
                const activeAlerts = (payload.active_alerts != null) ? payload.active_alerts : null;

                if (document.getElementById('kpi-devices-online') && online != null) {
                    document.getElementById('kpi-devices-online').textContent = `${online}/${total}`;
                }
                if (document.getElementById('kpi-active-alerts') && activeAlerts != null) {
                    document.getElementById('kpi-active-alerts').textContent = `${activeAlerts}`;
                }
                if (document.getElementById('kpi-avg-temp')) {
                    if (payload.avg_temp != null && !isNaN(payload.avg_temp)) {
                        document.getElementById('kpi-avg-temp').textContent = `${Number(payload.avg_temp).toFixed(1)}Â°C`;
                    } else {
                        document.getElementById('kpi-avg-temp').textContent = 'â€”';
                    }
                }
                if (document.getElementById('kpi-avg-rh')) {
                    if (payload.avg_hum != null && !isNaN(payload.avg_hum)) {
                        document.getElementById('kpi-avg-rh').textContent = `${Number(payload.avg_hum).toFixed(1)}%`;
                    } else {
                        document.getElementById('kpi-avg-rh').textContent = 'â€”';
                    }
                }
            }

            function updateAlertCards(payload) {
                const crit = Number(payload.critical_count || 0);
                const warn = Number(payload.warning_count || 0);
                const critEl = document.getElementById('count-critical');
                const warnEl = document.getElementById('count-warning');
                if (critEl) critEl.textContent = String(crit);
                if (warnEl) warnEl.textContent = String(warn);
                const pcCrit = document.getElementById('progress-critical');
                const pcWarn = document.getElementById('progress-warning');
                if (pcCrit) pcCrit.style.width = `${Math.min(100, crit * 10)}%`;
                if (pcWarn) pcWarn.style.width = `${Math.min(100, warn * 10)}%`;
            }
            function uuid() {
                return (crypto?.randomUUID?.() || (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            }
            function lockQA(text) {
                const btns = document.querySelectorAll('#qa-card button');
                btns.forEach(b => { b.disabled = true; b.classList.add('opacity-60', 'cursor-not-allowed'); });
                const old = document.getElementById('qa-status')?.textContent || '';
                const set = (t) => { const el = document.getElementById('qa-status'); if (el) el.textContent = t; };
                set(text || 'à¸à¸³à¸¥à¸±à¸‡à¸—à¸³à¸‡à¸²à¸™â€¦');
                return () => {
                    btns.forEach(b => { b.disabled = false; b.classList.remove('opacity-60', 'cursor-not-allowed'); });
                };
            }
            function waitForAction(actionId, timeoutMs = 8000) {
                return new Promise((resolve) => {
                    let settled = false;
                    const tid = setTimeout(() => {
                        if (!settled) { settled = true; resolve({ ok: false, status: 'timeout', message: 'No response' }); }
                    }, timeoutMs);

                    const key = 'qa_' + actionId;
                    window._qaHandlers = window._qaHandlers || {};
                    window._qaHandlers[key] = (msg) => {
                        const data = msg?.payload || {};
                        if (data.actionId !== actionId) return;
                        if (settled) return;
                        settled = true;
                        clearTimeout(tid);
                        const ok = (data.status === 'ok' || data.status === 'accepted');
                        resolve({ ok, status: data.status, message: data.message });
                        delete window._qaHandlers[key];
                    };
                });
            }
            function _dispatchQA(msg) {
                const t = msg?.topic;
                const p = (typeof msg?.payload === 'string') ? JSON.parse(msg.payload) : (msg?.payload || {});
                const id =
                    p.actionId || p.reqId || p.requestId ||
                    msg.actionId || msg.reqId || msg.requestId;

                if (!id) return;

                const key = 'qa_' + id;
                const handler = window._qaHandlers?.[key];

                if (!handler) return;
                handler(msg);
            }
            async function fetchAndRenderUptime_Server(mac, room, fromISO, toISO) {
                const p = new URLSearchParams();
                if (mac) {
                    p.set('mac', mac);
                } else if (room) {
                    p.set('room', room);
                } else {
                    throw new Error('MAC or Room ID is required for uptime query.');
                }

                if (fromISO) p.set('start', fromISO);
                if (toISO) p.set('end', toISO);

                try {
                    const res = await fetch(`/api/uptime?${p.toString()}`);
                    if (!res.ok) {
                        throw new Error(`Server responded with status ${res.status}`);
                    }
                    const j = await res.json();

                    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹„à¸”à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
                    if (j.uptime_pct == null || j.online_sec == null || j.total_sec == null) {
                        throw new Error('Invalid data received from uptime API');
                    }

                    const pct = Number(j.uptime_pct || 0);
                    const kpi = document.getElementById('kpi-uptime');
                    const bar = document.getElementById('uptime-progress');
                    const hint = document.getElementById('uptime-hint');

                    if (kpi) kpi.textContent = isNaN(pct) ? 'â€”' : pct.toFixed(2) + '%';
                    if (bar) bar.style.setProperty('--val', isNaN(pct) ? '0%' : Math.max(0, Math.min(100, pct)).toFixed(2) + '%');
                    if (hint) hint.textContent = `${Math.round((j.online_sec || 0) / 60)} / ${Math.round((j.total_sec || 0) / 60)} à¸™à¸²à¸—à¸µ`;
                } catch (err) {
                    console.error('Error fetching or rendering uptime:', err);
                    const kpi = document.getElementById('kpi-uptime');
                    const bar = document.getElementById('uptime-progress');
                    const hint = document.getElementById('uptime-hint');
                    if (kpi) kpi.textContent = 'â€”';
                    if (bar) bar.style.setProperty('--val', '0%');
                    if (hint) hint.textContent = 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™';
                }
            }
            async function fetchAndRenderRange() {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl?.dataset.currentRoom;

                if (!roomId) {
                    console.error("fetchAndRenderRange: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸«à¸² roomId à¹„à¸”à¹‰");
                    return;
                }
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const mac = roomToMac[roomId];

                if (!mac) {
                    showPopup(`à¹„à¸¡à¹ˆà¸žà¸š MAC Address à¸ªà¸³à¸«à¸£à¸±à¸š ${roomId} à¹ƒà¸™ Device Map`, { type: 'fail' });
                    console.error(`fetchAndRenderRange: à¹„à¸¡à¹ˆà¸¡à¸µ MAC Address à¸ªà¸³à¸«à¸£à¸±à¸šà¸«à¹‰à¸­à¸‡ ${roomId}`);
                    return;
                }

                const { fromISO, toISO } = getCurrentRangeISO();
                if (!fromISO || !toISO) {
                    console.error("fetchAndRenderRange: à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸«à¸²à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¹„à¸”à¹‰");
                    return;
                }

                try {
                    const res = await fetch(`/api/data?start=${fromISO}&end=${toISO}&mac=${mac}`);
                    if (!res.ok) {
                        throw new Error(`Server responded with status ${res.status}`);
                    }
                    const data = await res.json();
                    window.chartApiData = data;
                    if (data && data.length > 0) {
                        feedChartsFromRows(data, true);
                    } else {
                        window.chartApiData = [];
                        console.log(`à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸«à¸£à¸±à¸šà¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰à¸‚à¸­à¸‡à¸«à¹‰à¸­à¸‡ ${roomId}`);
                        feedChartsFromRows([], true);
                    }

                } catch (err) {
                    showPopup(`à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸£à¸²à¸Ÿà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${err.message}`, { type: 'fail', timeout: 5000 });
                    console.error("Fetch data failed:", err);
                }
            }
            async function sendAction(cmd, payload = {}) {
                if (typeof uibuilder === 'undefined') {
                    console.warn('uibuilder is undefined');
                    return false;
                }
                const actionId = uuid();
                const unlock = lockQA(`à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡ ${cmd}â€¦`);
                uibuilder.send({
                    topic: `actions/${cmd}`,
                    payload: {
                        cmd,
                        actionId,
                        ...payload,
                        meta: { by: 'web', ts: Date.now(), ver: 1 }
                    }
                });
                const res = await waitForAction(actionId, 60000);
                unlock();

                const statusEl = document.getElementById('qa-status');
                if (res.ok) {
                    statusEl.textContent = `âœ… ${cmd} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${res.status}${res.message ? ' â€¢ ' + res.message : ''}`;
                } else {
                    statusEl.textContent = `âŒ ${cmd} à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: ${res.status}${res.message ? ' â€¢ ' + res.message : ''}`;
                }
                return res.ok;
            }
            function getCommonChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false, labels: { color: '#fff' } },
                        tooltip: { enabled: false, external: customTooltip, mode: 'index', intersect: false, titleColor: '#fff', bodyColor: '#fff' },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,.05)' },
                            ticks: { color: '#fff' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,.10)' },
                            ticks: { color: '#fff' }
                        }
                    },
                    elements: { point: { radius: 1 } }
                };
            }




            function updateAllDetailUI(roomData) {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl.dataset.currentRoom;
                const statusLed = document.getElementById('detail-room-status-led');
                const mainStatusDot = document.getElementById(`status-dot-${roomId}`);
                const statusClass = mainStatusDot ? Array.from(mainStatusDot.classList).find(c => c.startsWith('led--')) : 'led--red';

                if (statusLed && statusClass) {
                    setLed(statusLed, statusClass);
                }

                updateDetailKPIs(roomData.history);
                updateSensorList(roomData.live, roomId);
            }
            function updateDetailKPIs(history) {
                const set = (id, val) => {
                    const el = document.getElementById(id);
                    el && (el.textContent = (isNaN(val) ? 'â€”' : Number(val).toFixed(1)));
                };

                if (!history || history.length === 0) {
                    ['kpi-temp-min', 'kpi-temp-avg', 'kpi-temp-max',
                        'kpi-rh-min', 'kpi-rh-avg', 'kpi-rh-max', 'kpi-dew-avg'
                    ].forEach(id => set(id, NaN));
                    return;
                }

                const latest = history[history.length - 1];
                const hasPayloadMinMax =
                    [latest.min_temp, latest.max_temp, latest.min_hum, latest.max_hum]
                        .every(v => typeof v === 'number' && !isNaN(v));

                if (hasPayloadMinMax) {
                    set('kpi-temp-min', latest.min_temp);
                    set('kpi-temp-avg', latest.temp_overall);
                    set('kpi-temp-max', latest.max_temp);

                    set('kpi-rh-min', latest.min_hum);
                    set('kpi-rh-avg', latest.rh_overall);
                    set('kpi-rh-max', latest.max_hum);

                    set('kpi-dew-avg', dewPointC_Magnus(latest.temp_overall, latest.rh_overall));
                    return;
                }

                const nums = a => a.filter(v => typeof v === 'number' && !isNaN(v));
                const T = nums(history.map(h => h.temp_overall));
                const H = nums(history.map(h => h.rh_overall));
                const D = nums(history.map(h => dewPointC_Magnus(h.temp_overall, h.rh_overall)));

                const stat = arr => arr.length ? ({
                    min: Math.min(...arr),
                    avg: arr.reduce((s, v) => s + v, 0) / arr.length,
                    max: Math.max(...arr),
                }) : { min: NaN, avg: NaN, max: NaN };

                const t = stat(T), h = stat(H), d = stat(D);

                set('kpi-temp-min', t.min); set('kpi-temp-avg', t.avg); set('kpi-temp-max', t.max);
                set('kpi-rh-min', h.min); set('kpi-rh-avg', h.avg); set('kpi-rh-max', h.max);
                set('kpi-dew-avg', d.avg);
            }

            function updateSensorList(liveData, roomId) {
                const listEl = document.getElementById('detail-sensor-list');
                if (!listEl) return;

                // --- roomId fallback ---
                roomId = roomId || document.getElementById('detail-room-name')?.dataset?.currentRoom || null;

                listEl.innerHTML = '';
                const pins = ['25', '26', '32', '33'];

                if (!liveData || Object.keys(liveData).length === 0) {
                    listEl.innerHTML = '<li class="text-center text-[var(--muted)] mt-4">Waiting for live data...</li>';
                    return;
                }

                const isNum = v => typeof v === 'number' && Number.isFinite(v);
                const fmt1 = v => isNum(v) ? v.toFixed(1) : 'â€”';
                const get = (o, keys) => { for (const k of keys) { const v = o?.[k]; if (isNum(v)) return v; } return NaN; };

                // ---- à¸ˆà¸¸à¸”à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚ ----
                // 1. à¸«à¸² MAC address à¸ˆà¸²à¸ roomId
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                // 2. à¹ƒà¸Šà¹‰ MAC address à¹„à¸›à¸”à¸¶à¸‡à¸Šà¸·à¹ˆà¸­ Pin à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸ˆà¸²à¸à¸•à¸±à¸§à¹à¸›à¸£à¹ƒà¸«à¸¡à¹ˆ
                const pinNames = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                // -------------------

                pins.forEach(pin => {
                    const pkt = liveData[pin] || {};

                    // --- à¸ªà¸–à¸²à¸™à¸°à¸žà¸´à¸™ (à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¹à¸šà¸šà¸•à¹ˆà¸­à¸«à¹‰à¸­à¸‡à¹à¸¥à¸°à¹à¸šà¸š Global) ---
                    const s1 = window.pinStatuses?.[roomId]?.[pin];
                    const s2 = window.pinStatuses?.[pin];
                    const status = (s1 || s2 || 'OFFLINE');
                    const isOffline = String(status).toUpperCase() === 'OFFLINE';

                    // --- à¸•à¸±à¸§à¹€à¸¥à¸‚ ---
                    const tmin = get(pkt, ['min_temp', 'tmin']);
                    const tavg = get(pkt, ['avg_temp', 'tavg', 'temp']);
                    const tmax = get(pkt, ['max_temp', 'tmax']);
                    const hmin = get(pkt, ['min_hum', 'hmin', 'min_rh']);
                    const havg = get(pkt, ['avg_hum', 'havg', 'rh']);
                    const hmax = get(pkt, ['max_hum', 'hmax', 'max_rh']);

                    // --- à¸Šà¸·à¹ˆà¸­à¸žà¸´à¸™ (à¹ƒà¸Šà¹‰ pinNames à¸—à¸µà¹ˆà¸”à¸¶à¸‡à¸¡à¸²à¸ˆà¸²à¸ MAC address) ---
                    const customName = pinNames[`name_pin_${pin}`] || `Pin ${pin}`;

                    const li = document.createElement('li');
                    li.className = 'live-row text-sm p-3 bg-[var(--panel)] rounded-md border border-[var(--border)]';

                    li.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="led ${isOffline ? 'led--red' : 'led--green'}"></span>
                <span class="text-[var(--muted)] font-medium">${customName}</span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-right live-values">
                <div class="flex items-center justify-end gap-2">
                    <span class="badge-chip badge-temp text-xs">Temperature</span>
                    <span class="font-bold text-base">
                        <span class="text-sky-400">${isOffline ? 'â€”' : fmt1(tmin)}</span>
                        <span class="live-sep">/</span>
                        <span>${isOffline ? 'â€”' : fmt1(tavg)}</span>
                        <span class="live-sep">/</span>
                        <span class="text-red-400">${isOffline ? 'â€”' : fmt1(tmax)}</span>
                    </span>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <span class="badge-chip badge-hum text-xs">Humidity</span>
                    <span class="font-bold text-base">
                        <span class="text-sky-400">${isOffline ? 'â€”' : fmt1(hmin)}</span>
                        <span class="live-sep">/</span>
                        <span>${isOffline ? 'â€”' : fmt1(havg)}</span>
                        <span class="live-sep">/</span>
                        <span class="text-red-400">${isOffline ? 'â€”' : fmt1(hmax)}</span>
                    </span>
                </div>
            </div>
        `;

                    listEl.appendChild(li);
                });
            }

            // ===== Modals & Actions =====
            function openModal(id) {
                const el = document.getElementById(id);
                if (!el) return;

                el.classList.remove('hidden');

                if (el.classList.contains('config-overlay')) {
                    el.classList.add('active');
                }

                const centerIds = new Set(['modal-reboot', 'modal-export', 'modal-device-map', 'modal-settings', 'modal-room-detail', 'modal-pin-map']);
                if (centerIds.has(id)) {
                    el.classList.add('centered');
                }
            }

            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (!el) return;

                el.classList.remove('active');
                el.classList.remove('centered');
                el.classList.add('hidden');

                if (document.activeElement?.blur) document.activeElement.blur();
            }
            async function openRoomDetailModal(roomId) {
                const roomToMacMap = {};
                Object.entries(window.MAC_TO_ROOM_MAP || {}).forEach(([mac, rId]) => {
                    roomToMacMap[rId] = mac;
                });
                const mac = roomToMacMap[roomId];
                const defaultName = roomId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                const finalName = window.ROOM_NAMES?.[roomId] || defaultName;

                if (window._detailCharts.temp && window._detailCharts.rh) {
                    console.log(`Clearing charts before loading new room: ${roomId}`);
                    window._detailCharts.temp.data.datasets = [];
                    window._detailCharts.rh.data.datasets = [];
                    window._detailCharts.temp.update('none');
                    window._detailCharts.rh.update('none');
                }
                updateDetailKPIs([]);
                const sensorList = document.getElementById('detail-sensor-list');
                if (sensorList) sensorList.innerHTML = '<li class="text-center text-[var(--muted)] mt-4">Loading data...</li>';
                const detailRoomNameEl = document.getElementById('detail-room-name');
                detailRoomNameEl.textContent = `${finalName}`;
                detailRoomNameEl.dataset.currentRoom = roomId;
                applyPinNames(roomId);
                window.currentCfgRoom = roomId;
                const cfgRoomSelect = document.getElementById('cfg-room');
                if (cfgRoomSelect) {
                    cfgRoomSelect.value = roomId;
                }

                delete window.liveAlertSettings[roomId];
                try {
                    console.log(`Attempting to fetch live config for ${roomId}...`);
                    const config = await fetchConfigFromDevice(roomId);
                    console.log(`Successfully fetched config for ${roomId}`, config);
                    if (config && config.alerts) {
                        window.liveAlertSettings[roomId] = {
                            temp: {
                                critLow: config.alerts.temp_crit_low,
                                warnLow: config.alerts.temp_warn_low,
                                warnHigh: config.alerts.temp_warn_high,
                                critHigh: config.alerts.temp_crit_high
                            },
                            hum: {
                                critLow: config.alerts.hum_crit_low,
                                warnLow: config.alerts.hum_warn_low,
                                warnHigh: config.alerts.hum_warn_high,
                                critHigh: config.alerts.hum_crit_high
                            }
                        };
                    }
                } catch (error) {
                    console.warn(`Could not fetch live config for ${roomId}:`, error.message);
                    showPopup(`à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸„à¹ˆà¸²à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ ${finalName} à¹„à¸”à¹‰, à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¹à¸—à¸™`, { type: 'warn' });
                }
                const roomData = window.roomDataStore[roomId];
                if (roomData) {
                    updateAllDetailUI(roomData);
                }
                const now = new Date().toISOString();
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();

                await fetchAndRenderUptime_Server(mac, roomId, yesterday, now);
                setDefault24hRange();
                openModal('modal-room-detail');
                fetchAndRenderRange();
            }
            function showPopup(message, opts = {}) {
                const type = opts.type || 'info';
                const timeout = (typeof opts.timeout === 'number') ? opts.timeout : 4000;
                let existing = document.getElementById('qa-popup-overlay');
                if (existing) {
                    const msgEl = existing.querySelector('.qa-msg');
                    if (msgEl) msgEl.textContent = message;
                    clearTimeout(existing._timeoutId);
                    existing._timeoutId = setTimeout(() => {
                        existing && existing.remove();
                    }, timeout);
                    return;
                }

                const overlay = document.createElement('div');
                overlay.id = 'qa-popup-overlay';
                overlay.className = 'qa-popup-overlay';

                const panel = document.createElement('div');
                panel.className = 'qa-popup-panel';

                const icon = document.createElement('div');
                icon.className = `qa-icon ${type}`;
                icon.innerHTML = (type === 'success') ? 'âœ…' : (type === 'warn') ? 'âš ï¸' : (type === 'fail') ? 'âŒ' : 'â„¹ï¸';

                const msg = document.createElement('div');
                msg.className = 'qa-msg';
                msg.textContent = message;

                const closeBtn = document.createElement('div');
                closeBtn.className = 'qa-close';
                closeBtn.innerHTML = '<button class="btn" aria-label="close">Close</button>';
                closeBtn.addEventListener('click', () => { overlay.remove(); });

                panel.appendChild(icon);
                panel.appendChild(msg);
                panel.appendChild(closeBtn);
                overlay.appendChild(panel);
                overlay.addEventListener('click', (ev) => {
                    if (ev.target === overlay) overlay.remove();
                });

                document.body.appendChild(overlay);
                overlay._timeoutId = setTimeout(() => {
                    overlay.remove();
                }, timeout);
            }
            document.addEventListener('click', e => { const id = e.target?.dataset?.close; if (id) closeModal(id); });
            document.getElementById('qa-reboot')?.addEventListener('click', () => openModal('modal-reboot'));
            document.getElementById('detail-btn-export')?.addEventListener('click', () => {
                openModal('modal-export');
            });

            document.getElementById('detail-btn-settings')?.addEventListener('click', () => {
                const roomId = document.getElementById('detail-room-name').dataset.currentRoom;
                if (!roomId) return;
                if (window.chartApiData) feedChartsFromRows(window.chartApiData, false);
                window.currentCfgRoom = roomId;
                const cfgRoomSelect = document.getElementById('cfg-room');
                if (cfgRoomSelect) {
                    cfgRoomSelect.value = roomId;
                    cfgRoomSelect.dispatchEvent(new Event('change'));
                }
                showConfigPopup();
            });
            document.getElementById('detail-btn-reboot')?.addEventListener('click', () => {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl.dataset.currentRoom;
                const rebootModal = document.getElementById('modal-reboot');
                const rebootSelect = rebootModal.querySelector('select[name="target"]');
                if (rebootSelect && roomId) {
                    rebootSelect.value = roomId;
                }
                openModal('modal-reboot');
            });
            document.getElementById('qa-export')?.addEventListener('click', () => openModal('modal-export'));
            document.getElementById('open-device-map')?.addEventListener('click', () => {
                loadMapForm();
                openModal('modal-device-map');
            });

            document.getElementById('form-reboot')?.addEventListener('submit', e => {
                e.preventDefault();
                const form = e.currentTarget;
                const roomId = new FormData(form).get('target') || 'room-a';

                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const statusEl = document.getElementById('qa-status');
                const safeClose = () => { try { closeModal('modal-reboot'); } catch { } };

                if (roomId === 'all') {
                    const mac_list = ['room-a', 'room-b', 'room-c', 'room-d']
                        .map(r => normalizeMAC(roomToMac[r] || ''))
                        .filter(Boolean);

                    if (!mac_list.length) {
                        if (statusEl) statusEl.textContent = 'âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² MAC à¹ƒà¸™ Device Map';
                        return;
                    }
                    safeClose();
                    sendAction('reboot_all', { mac_list });
                    return;
                }
                const mac = normalizeMAC(roomToMac[roomId] || '');
                if (!mac) {
                    if (statusEl) statusEl.textContent = `âŒ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² MAC à¹ƒà¸«à¹‰ ${roomId} (à¹€à¸›à¸´à¸” Device Map à¹€à¸žà¸·à¹ˆà¸­à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²)`;
                    return;
                }
                safeClose();
                sendAction('reboot', { room_id: roomId, mac });
            });

            document.querySelector('#form-export select[name="range"]')?.addEventListener('change', e => {
                const block = document.getElementById('export-custom');
                if (block) block.classList.toggle('hidden', e.target.value !== 'custom');
            });
            document.getElementById('form-export')?.addEventListener('submit', e => {
                e.preventDefault();
                const fd = new FormData(e.currentTarget);
                const room = fd.get('room') || 'all';
                const type = fd.get('type');
                const from = fd.get('from') ? new Date(fd.get('from')).toISOString() : null;
                const to = fd.get('to') ? new Date(fd.get('to')).toISOString() : null;

                if (from && to && from >= to) {
                    showQAStatus('âŒ Error: Start date must be before end date.');
                    return;
                }

                if (typeof uibuilder !== 'undefined') {
                    uibuilder.send({
                        topic: `reports/${room}/export`,
                        payload: {
                            command: 'export',
                            room: room,
                            type,
                            from,
                            to
                        }
                    });
                }
                showQAStatus(`âœ… à¸ªà¹ˆà¸‡à¸„à¸³à¸‚à¸­ Export à¸ªà¸³à¸«à¸£à¸±à¸š ${room.toUpperCase()} à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢`);
                closeModal('modal-export');
            });
            document.getElementById('form-device-map')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const ok = await saveDeviceMapToServer(new FormData(e.currentTarget));
                if (ok) {
                    resetAllRoomStatuses();
                    closeModal('modal-device-map');
                    location.reload();
                }
            });
            document.getElementById('open-pin-map')?.addEventListener('click', () => {
                const detailModal = document.getElementById('modal-room-detail');
                const roomId = detailModal.querySelector('#detail-room-name')?.dataset.currentRoom;
                if (!roomId) {
                    showPopup('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¸«à¹‰à¸­à¸‡à¹„à¸”à¹‰', { type: 'fail' });
                    return;
                }

                const pinMapModal = document.getElementById('modal-pin-map');
                pinMapModal.dataset.currentRoom = roomId;
                const form = document.getElementById('form-pin-map');
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                const roomPinNames = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};

                if (form) {
                    form.name_pin_25.value = roomPinNames.name_pin_25 || '';
                    form.name_pin_26.value = roomPinNames.name_pin_26 || '';
                    form.name_pin_32.value = roomPinNames.name_pin_32 || '';
                    form.name_pin_33.value = roomPinNames.name_pin_33 || '';
                }
                openModal('modal-pin-map');
            });
            document.getElementById('form-pin-map')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const modal = e.currentTarget.closest('#modal-pin-map');
                const roomId = modal?.dataset.currentRoom;

                if (!roomId) {
                    showPopup('à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: à¹„à¸¡à¹ˆà¸žà¸š Room ID', { type: 'fail' });
                    return;
                }

                const ok = await savePinMapToServer(roomId, new FormData(e.currentTarget));
                if (ok) {
                    closeModal('modal-pin-map');
                    const currentRoomData = window.roomDataStore[roomId];
                    if (currentRoomData) {
                        updateSensorList(currentRoomData.live, roomId);
                    }
                    if (window.chartApiData) {
                        feedChartsFromRows(window.chartApiData, false);
                    }
                }
            });
            if (typeof uibuilder !== 'undefined') {
                uibuilder.onChange('msg', function (msg) {
                    let data = msg ? msg.payload : null;
                    let topic = msg?.topic;
                    if (topic === 'config_response' && data && data.requestId) {
                        const promiseHandler = window._configPromises[data.requestId];
                        if (promiseHandler) {
                            console.log(`[Config] Received response for request ID: ${data.requestId}`);
                            promiseHandler.resolve(data.payload);
                        }
                        return;
                    }
                    if (topic === 'uibuilder') return;
                    if (data && data.status === 'error' && data.message && data.message.includes('missing actionId')) return;
                    if (typeof data === 'string') { try { data = JSON.parse(data); } catch { return; } }
                    if (!data || typeof data !== 'object') return;
                    if (data.actionId || topic === 'actions/ack') {
                        _dispatchQA(msg);
                        return;
                    }
                    if (msg.topic === 'pin_status_update') {
                        const statuses = Array.isArray(msg.payload) ? msg.payload : [];
                        let changed = false;
                        statuses.forEach(s => {
                            if (window.pinStatuses[s.pin] !== s.status) {
                                window.pinStatuses[s.pin] = s.status;
                                changed = true;
                            }
                        });

                        if (changed) {
                            const detailModal = document.getElementById('modal-room-detail');
                            const currentRoom = document.getElementById('detail-room-name')?.dataset.currentRoom;
                            if (!detailModal.classList.contains('hidden') && currentRoom && window.roomDataStore[currentRoom]) {
                                updateSensorList(window.roomDataStore[currentRoom].live, currentRoom);
                            }
                        }
                        return;
                    }
                    if (!window._gotFirstMsg) window._gotFirstMsg = true;
                    if (data.status) updateDeviceStatus(data.status, data.ping_ms);
                    const macKey_live = normalizeMAC(data.mac);
                    const roomId_live = window.MAC_TO_ROOM_MAP[macKey_live];


                    if (roomId_live) {
                        const store = window.roomDataStore[roomId_live];
                        const pinVal = (typeof data.pin === 'number' || /^\d+$/.test(data.pin)) ? Number(data.pin) : data.pin;

                        store.live[pinVal] = data;

                        if (pinVal === 'OVERALL') {
                            const last = store.history.length ? store.history[store.history.length - 1] : {};

                            const newHistoryEntry = {
                                timestamp: data.timestamp,
                                temp_overall: data.avg_temp,
                                rh_overall: data.avg_hum,
                                temp_pin25: store.live[25]?.avg_temp ?? last.temp_pin25,
                                temp_pin26: store.live[26]?.avg_temp ?? last.temp_pin26,
                                temp_pin32: store.live[32]?.avg_temp ?? last.temp_pin32,
                                temp_pin33: store.live[33]?.avg_temp ?? last.temp_pin33,
                                rh_pin25: store.live[25]?.avg_hum ?? last.rh_pin25,
                                rh_pin26: store.live[26]?.avg_hum ?? last.rh_pin26,
                                rh_pin32: store.live[32]?.avg_hum ?? last.rh_pin32,
                                rh_pin33: store.live[33]?.avg_hum ?? last.rh_pin33,
                                min_temp: data.min_temp,
                                max_temp: data.max_temp,
                                min_hum: data.min_hum,
                                max_hum: data.max_hum,
                            };

                            store.history.push(newHistoryEntry);
                            if (store.history.length > 100) store.history.shift();
                            const detailModal = document.getElementById('modal-room-detail');
                            const detailRoomNameEl = document.getElementById('detail-room-name');
                            if (!detailModal.classList.contains('hidden') &&
                                detailRoomNameEl.dataset.currentRoom === roomId_live) {
                                if (window.chartApiData && newHistoryEntry) {
                                    window.chartApiData.push(newHistoryEntry);
                                }
                                feedChartsFromRows(window.chartApiData, false);
                                updateAllDetailUI(store);
                                updateDetailKPIs(store.history);
                                updateSensorList(store.live);
                            }
                        }
                    }
                    if (topic && topic.startsWith('esp32/response/') && topic.endsWith('/config')) {
                        const incomingId = (data?.requestId || '').toString();
                        const promiseHandler = window._configPromises[incomingId];
                        if (promiseHandler) {
                            console.log(`[Config] Received response for Promise-based request: ${incomingId}`);
                            promiseHandler.resolve(data);

                        } else {
                            console.log(`[Config] Received a config message with an unknown or unawaited requestId: ${incomingId}`);
                        }
                        return;
                    }

                    let roomId = null;

                    const macMap = (window.MAC_TO_ROOM_MAP || {});
                    let macKeyRaw = '';
                    if (topic) {
                        const m = topic.match(/esp32\/response\/([0-9A-F]{12})\/config/i);
                        if (m && m[1]) macKeyRaw = m[1];
                    }
                    if (!macKeyRaw) {
                        macKeyRaw = findMACInObject(data) || '';
                    }
                    const macKey = normalizeMAC(macKeyRaw);
                    const mappedRoom = macKey ? macMap[macKey] : null;
                    let payloadRoom = null;
                    if (typeof data.room_id === 'string') {
                        const rid = data.room_id.trim().toLowerCase();
                        if (['room-a', 'room-b', 'room-c', 'room-d'].includes(rid)) payloadRoom = rid;
                    }
                    const topicRoom = parseRoomIdFromTopic(topic);
                    roomId = mappedRoom || payloadRoom || topicRoom;

                    const candidateFromMsg = payloadRoom || topicRoom;
                    if (mappedRoom && candidateFromMsg && mappedRoom !== candidateFromMsg) {
                        console.warn('Drop telemetry: MAC->room mismatch', { macKey, mappedRoom, payloadRoom, topicRoom });
                        return;
                    }
                    if (!roomId) {
                        console.warn('Drop message: no room resolved.', { map: window.MAC_TO_ROOM_MAP, macKey, topic, sample: data });
                        return;
                    }

                    const p = (data.pin == null ? 'OVERALL' : String(data.pin));
                    if (!window.RoomStore) window.RoomStore = {};
                    if (!RoomStore[roomId]) {
                        RoomStore[roomId] = { selectedPin: 'OVERALL', sensors: {} };
                    }
                    RoomStore[roomId].sensors[p] = data;

                    updateRoomUI(roomId, data);
                    updateRoomSelectorStatus();
                    if (!window._roomTimeouts) window._roomTimeouts = {};
                    if (window._roomTimeouts[roomId]) clearTimeout(window._roomTimeouts[roomId]);
                    window._roomTimeouts[roomId] = setTimeout(() => { resetRoomUI(roomId); }, ROOM_TIMEOUT_MS);

                    console.log('Resolved:', { roomId, macKey, topic, pin: p });
                    updateKPIs(data);
                    updateAlertCards(data);
                });
            }
            document.getElementById('btn-copy-mac')?.addEventListener('click', handleCopyMac);
            function copyTextFallback(text) {
                const ta = document.createElement('textarea');
                ta.value = text; ta.setAttribute('readonly', '');
                ta.style.position = 'absolute'; ta.style.left = '-9999px';
                document.body.appendChild(ta); ta.select();
                let ok = false; try { ok = document.execCommand('copy'); } catch { }
                document.body.removeChild(ta); return ok;
            }

            async function handleCopyMac() {
                const macEl = document.getElementById('cfg-mac');
                const btn = document.getElementById('btn-copy-mac');
                const mac = (macEl?.textContent || '').trim();
                if (!mac || mac === '--:--:--:--:--:--') return;

                const originalHTML = btn.innerHTML;
                const showOK = () => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i><span></span>';
                    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 1400);
                };
                const showFail = () => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-xmark"></i><span>Retry</span>';
                    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 1400);
                };

                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(mac);
                        showOK();
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = mac; ta.setAttribute('readonly', '');
                        ta.style.position = 'absolute'; ta.style.left = '-9999px';
                        document.body.appendChild(ta); ta.select();
                        const ok = document.execCommand('copy');
                        document.body.removeChild(ta);
                        ok ? showOK() : showFail();
                    }
                } catch {
                    showFail();
                }
            }
            (function bindKeyOnce() {
                if (window.__modalKeyBound) return;
                window.__modalKeyBound = true;

                document.addEventListener('keydown', (e) => {
                    const m = findOpenModal();
                    if (!m) return;

                    if (e.key === 'Escape' || e.key === 'Esc') {
                        e.preventDefault(); e.stopPropagation();
                        closeModal(m);
                        return;
                    }

                    if (e.key === 'Enter') {
                        const tag = document.activeElement?.tagName?.toLowerCase();
                        if (tag === 'textarea') return;
                        e.preventDefault(); e.stopPropagation();
                        clickPrimary(m);
                    }
                }, { capture: true });
                applyRoomNames();
                initAllRoomsOffline();
            })();
            function isVisible(el) {
                if (!el) return false;
                const st = getComputedStyle(el);
                if (st.display === 'none' || st.visibility === 'hidden' || st.opacity === '0') return false;
                return el.offsetWidth > 0 || el.offsetHeight > 0;
            }

            function findOpenModal() {
                const cands = Array.from(document.querySelectorAll(
                    '[data-modal], [role="dialog"], .modal, [id^="modal-"], .fixed.inset-0'
                ));
                const visible = cands.filter(el => !el.classList.contains('hidden') && isVisible(el));
                return visible[0] || null;
            }

            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('active');
                el.classList.remove('centered');
                el.classList.add('hidden');
                if (document.activeElement?.blur) document.activeElement.blur();
            }
            function clickPrimary(modalEl) {
                if (!modalEl) return;
                const selectors = [
                    '#btn-save-settings',
                    'button[data-primary="true"]',
                    'button.btn-primary:not([disabled])',
                    'button[type="submit"]:not([disabled])',
                ];
                for (const sel of selectors) {
                    const btn = modalEl.querySelector(sel);
                    if (btn) { btn.click(); return; }
                }
            }
            window.DetailUI = {
                series: { overall: true, pin25: true, pin26: true, pin32: true, pin33: true, dew: true },
                range: { mode: '24h', start: null, end: null }
            };

            function initDetailToolbar() {
                document.querySelectorAll('#detail-toolbar [data-range]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        window.DetailUI.range = { mode: btn.dataset.range, start: null, end: null };
                        fetchAndRenderRange();
                    });
                });
                document.getElementById('btn-apply-range')?.addEventListener('click', () => {
                    fetchAndRenderRange();
                });
                document.getElementById('series-toggle')?.addEventListener('change', (e) => {
                    if (!e.target.matches('input[type="checkbox"][data-series]')) return;

                    const key = e.target.dataset.series;
                    const isChecked = e.target.checked;
                    window.DetailUI.series[key] = isChecked;
                    if (key === 'overall' && !isChecked) {
                        const dewCheckbox = document.querySelector('input[data-series="dew"]');
                        if (dewCheckbox) {
                            dewCheckbox.checked = false;
                            window.DetailUI.series['dew'] = false;
                        }
                    }
                    feedChartsFromRows(window.chartApiData, false);
                });
                document.getElementById('toggle-thresholds')?.addEventListener('change', () => {
                    feedChartsFromRows(window.chartApiData, false);
                });
            }

            document.addEventListener('click', (e) => {
                const closeTarget = e.target?.closest?.('[data-close]');
                if (!closeTarget) return;
                const val = closeTarget.getAttribute('data-close');
                if (val === 'this') {
                    const m = findOpenModal();
                    if (m) closeModal(m);
                } else if (val) {
                    closeModal(val);
                }
            }, { capture: true });
            // ==== RANGE HELPERS ====
            function toLocalDatetimeInputValue(d) {
                const pad = n => String(n).padStart(2, '0');
                const y = d.getFullYear();
                const m = pad(d.getMonth() + 1);
                const day = pad(d.getDate());
                const hh = pad(d.getHours());
                const mm = pad(d.getMinutes());
                return `${y}-${m}-${day}T${hh}:${mm}`;
            }
            function setDefault24hRange() {
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                document.getElementById('range-start').value = toLocalDatetimeInputValue(start);
                document.getElementById('range-end').value = toLocalDatetimeInputValue(end);
            }
            function getCurrentRangeISO() {
                const fromISO = getIsoFromInput('range-start');
                const toISO = getIsoFromInput('range-end');
                return { fromISO, toISO };
            }
            function getIsoFromInput(id) {
                const v = document.getElementById(id).value;
                if (!v) return null;
                const dt = new Date(v);
                if (isNaN(dt)) return null;
                return dt.toISOString();
            }
            (function initRangeOnce() {
                const rs = document.getElementById('range-start');
                const re = document.getElementById('range-end');
                if (rs && re) setDefault24hRange();
            })();
            async function fetchSeriesForCurrentRoom() {
                const detailTitle = document.getElementById('detail-room-name');
                const roomId = detailTitle?.dataset?.currentRoom;
                if (!roomId) throw new Error('No current room');
                const roomToMac = {};
                Object.entries(window.MAC_TO_ROOM_MAP || {}).forEach(([mac, r]) => { roomToMac[r] = mac; });
                const mac = roomToMac[roomId];
                if (!mac) throw new Error('No MAC mapped for room ' + roomId);
                const startISO = getIsoFromInput('range-start');
                const endISO = getIsoFromInput('range-end');
                if (!startISO || !endISO) throw new Error('Start/End is missing');
                const pins = ['OVERALL', '25', '26', '32', '33'];
                const qs = new URLSearchParams({
                    mac,
                    start: startISO,
                    end: endISO,
                    pins: pins.join(',')
                });

                const res = await fetch(`/api/data?${qs.toString()}`);
                if (!res.ok) throw new Error('API failed');
                const rows = await res.json();
                return rows;
            }
            document.getElementById('btn-apply-range')?.addEventListener('click', async () => {
                try {
                    const rows = await fetchSeriesForCurrentRoom();
                    feedChartsFromRows(rows, true);
                } catch (e) {
                    showPopup('à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ' + e.message, { type: 'fail' });
                }
            });
            document.getElementById('btn-reset-range')?.addEventListener('click', async () => {
                setDefault24hRange();
                await fetchAndRenderRange();
            });
            loadDeviceMapFromServer();

        });

    </script>
</body>

</html>