<!DOCTYPE html>
<html lang="th">

<head>
    <script
        src="https://cdn.jsdelivr.net/npm/node-red-contrib-uibuilder@7.4.3/front-end/uibuilder.iife.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Server Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .fa,
        .fas,
        .far,
        .fal,
        .fab,
        .fa-solid {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transform: translateZ(0);
        }

        html {
            font-size: 19px;
            color-scheme: dark;
        }

        :root {
            --bg: #0b1220;
            --panel: #121a2b;
            --panel-2: #0f172a;
            --border: #1f2a44;
            --text: #cbd5e1;
            --muted: #94a3b8;
            --accent: #3b82f6;
            --chart-padding: 10px;
            --icon-gap: .5rem;
            --icon-w: 1.1rem;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            scrollbar-width: thin;
            scrollbar-color: var(--border) var(--bg);
        }

        .main-content {
            position: fixed;
            inset: 0;
            transition: transform .05s ease-in-out;
            will-change: transform;
        }

        @media (max-width:1023px) {
            .main-content {
                transform: none !important;
            }
        }

        #sidebar,
        #mainContent,
        #sidebar *,
        #mainContent * {
            caret-color: transparent;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #sidebar img,
        #mainContent img,
        #sidebar svg,
        #mainContent svg,
        #mainContent canvas {
            -webkit-user-drag: none;
        }

        .copyable {
            -webkit-user-select: text !important;
            user-select: text !important;
        }

        .kpi-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
            padding: .75rem 1rem;
        }

        .kpi-title {
            color: var(--muted);
            font-size: .8rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .progress {
            height: 8px;
            background: var(--panel-2);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress>span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            width: var(--val, 0%);
        }

        .card-chart {
            width: 100%;
            height: clamp(60px, 12vh, 80px);
            min-height: 60px;
            max-height: 80px;
            overflow: hidden;
            display: block;
            position: relative;
            padding: 0 var(--chart-padding);
            border-radius: .75rem;
            box-sizing: border-box;
        }

        .card-chart>canvas {
            position: relative !important;
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
        }

        .hidden-card {
            display: none !important;
        }

        @media (max-width:640px) {
            .card-chart {
                height: 85px !important;
                min-height: 85px !important;
                max-height: 100px !important;
            }
        }

        @media (min-width:1280px) {
            .card-chart {
                min-height: 90px;
                max-height: 120px;
            }

            .flex-1.overflow-auto.p-6 {
                padding-right: 1rem;
            }
        }

        @media (min-width:1280px) {

            .flex-1.overflow-auto.p-6>.grid,
            .grid.grid-cols-1.xl\:grid-cols-\[1fr_22rem\] {
                grid-template-columns: minmax(0, 1fr) 22rem !important;
            }
        }

        :focus {
            outline: none;
        }

        :focus-visible {
            outline: 2px solid rgba(59, 130, 246, .7);
            outline-offset: 2px;
        }

        .offline-blank {
            background: var(--panel) !important;
            border: 1px solid var(--border) !important;
        }

        .offline-blank * {
            visibility: hidden !important;
        }

        .offline-hide {
            display: none !important;
        }

        .config-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
            background: rgba(0, 0, 0, .5);
            display: none;
            z-index: 50;
        }

        .config-overlay.active {
            display: block;
        }

        .config-panel {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            width: 26rem;
            max-width: 95vw;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: .75rem;
            color: var(--text);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 3rem);
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            --cfg-gap: .75rem;
            --cfg-radius: .65rem;
        }

        .config-header {
            padding: .75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
            border-top-left-radius: .75rem;
            border-top-right-radius: .75rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            justify-content: space-between;
        }

        .config-header h5 {
            font-size: 1rem;
            font-weight: 600;
        }

        .config-body {
            flex-grow: 1;
            max-height: none;
            overflow-y: auto;
            overflow: visible;
            padding: 1rem;
        }

        .config-footer {
            padding: .75rem 1rem;
            border-top: 1px solid var(--border);
            background: var(--panel-2);
            border-bottom-left-radius: .75rem;
            border-bottom-right-radius: .75rem;
        }

        .config-tabs {
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap;
            width: 100%;
            border-bottom: none;
            gap: .75rem;
        }

        .config-tab {
            flex: 1;
            text-align: center;
            padding: .5rem .25rem;
            border: none;
            border-radius: 0;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: .85rem;
            margin-bottom: 0;
        }

        .config-tab.active {
            color: var(--accent);
            font-weight: 600;
            box-shadow: inset 0 -2px 0 0 var(--accent);
        }

        .config-section {
            display: none;
            margin-top: .75rem;
        }

        .config-section.active {
            display: block;
        }

        .config-label {
            font-size: .875rem;
            color: var(--muted);
            margin-bottom: .35rem;
            display: block;
        }

        .config-input,
        .config-select,
        input[type="datetime-local"] {
            width: 100%;
            padding: .5rem .75rem;
            border-radius: var(--cfg-radius);
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid var(--border);
            transition: border-color 0.05s ease-in-out;
        }

        .config-input::placeholder {
            color: #9aa6b2;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: .75rem;
        }

        .btn {
            padding: .5rem .75rem;
            border-radius: .55rem;
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            cursor: pointer;
            height: 50px;
            font-size: .9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            border-color: var(--accent);
            color: white;
            filter: brightness(1.2);
        }

        .btn-primary {
            border-color: var(--accent);
        }

        .btn-danger {
            color: #fda4af;
            border-color: #7f1d1d;
        }

        .btn i {
            margin-right: .4rem;
        }

        .small-muted {
            font-size: .8rem;
            color: var(--muted);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: .5rem;
            padding: .4rem .6rem;
        }

        .remove-item-btn {
            color: #ef4444;
        }

        #modal-room-detail {
            z-index: 55;
        }

        #modal-room-detail canvas {
            user-select: auto;
            -webkit-user-select: auto;
            -webkit-user-drag: auto;
        }

        #modal-reboot,
        #modal-export,
        #modal-device-map,
        #modal-settings {
            z-index: 60;
        }

        #modal-reboot.centered,
        #modal-export.centered,
        #modal-device-map.centered,
        #modal-settings.centered {
            z-index: 70 !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div,
        #modal-recipients.centered>div,
        #modal-settings.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
            max-width: min(92vw, 32rem) !important;
        }

        #modal-summary-detail.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            max-width: min(92vw, 32rem) !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div {
            width: min(92vw, 26rem);
        }

        #modal-reboot.centered,
        #modal-export.centered,
        #modal-device-map.centered,
        #modal-recipients.centered,
        #modal-settings.centered {
            display: block;
            background: rgba(0, 0, 0, .38);
        }

        .config-body::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .config-body::-webkit-scrollbar-track {
            background: var(--panel-2);
            border-radius: 10px;
        }

        .config-body::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
            border: 2px solid var(--panel-2);
        }

        .config-body::-webkit-scrollbar-thumb:hover {
            background-color: var(--muted);
        }

        body::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        body::-webkit-scrollbar-track {
            background: var(--bg);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background-color: var(--muted);
        }

        #modal-settings.centered .config-panel {
            width: clamp(24rem, 32vw, 44rem) !important;
            max-width: 96vw !important;
            height: clamp(520px, 78vh, 720px) !important;
        }

        @media (max-width:640px) {
            #modal-settings.centered .config-panel {
                width: 96vw !important;
                height: 90vh !important;
            }
        }

        #modal-settings .config-panel.fullscreen {
            width: 96vw !important;
            height: 94vh !important;
        }

        #btn-copy-mac:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        #btn-copy-mac {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            padding: 0;
        }

        #btn-copy-mac i {
            margin-right: 0 !important;
            line-height: 1;
        }

        #btn-copy-mac .icon {
            margin-right: 0 !important;
            width: auto !important;
        }

        #modal-settings .cfg-mac-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--cfg-gap);
            padding: .6rem .75rem;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: var(--cfg-radius);
            margin-bottom: .5rem;
        }

        #modal-settings .cfg-mac-left {
            display: flex;
            align-items: center;
            gap: .6rem;
            min-width: 0;
        }

        #modal-settings .cfg-mac-label {
            font-size: .875rem;
            color: var(--muted);
        }

        #modal-settings .cfg-mac-value {
            font-size: .95rem;
            letter-spacing: .04em;
            white-space: nowrap;
        }

        .config-row.mqtt {
            display: grid;
            grid-template-columns: 1fr 11rem;
            gap: var(--cfg-gap, .75rem);
        }

        @media (max-width:640px) {
            .config-row.mqtt {
                grid-template-columns: 1fr;
            }
        }

        .cfg-field {
            display: flex;
            flex-direction: column;
            gap: .35rem;
        }

        .cfg-label-row {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: .9rem;
            color: var(--muted);
            font-weight: 600;
        }

        #modal-settings .config-input,
        #modal-settings .config-select {
            height: 44px !important;
            line-height: 44px !important;
            font-size: .95rem;
            padding-top: 0;
            padding-bottom: 0;
        }

        #modal-settings section#tab-alerts h6 {
            font-size: .9rem;
            margin-bottom: .25rem;
        }

        #modal-settings .config-section h5 .icon,
        #modal-settings .config-section h6 .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .config-section .config-label>.icon,
        #modal-settings .cfg-label-row .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .cfg-mac-left .icon,
        #modal-settings .btn .icon {
            display: inline-block;
            width: var(--icon-w);
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .config-tabs .config-tab i {
            margin-right: var(--icon-gap);
            vertical-align: middle;
        }

        #modal-settings .icon>i {
            display: block;
            line-height: 1;
        }

        .config-label .icon,
        .cfg-mac-left .icon,
        #btn-copy-mac .icon,
        .btn .icon {
            display: inline-block !important;
            align-items: unset !important;
            justify-content: unset !important;
        }

        .config-icon {
            width: var(--icon-w, 1.25rem);
            height: var(--icon-w, 1.25rem);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .config-icon>i {
            line-height: 1;
        }

        .led {
            --led: #22c55e;
            position: relative;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            background: radial-gradient(circle at 35% 35%, #ffffff80 0%, var(--led) 40%, var(--led) 100%);
            box-shadow:
                inset 0 0 2px rgba(0, 0, 0, .35),
                0 0 4px 1px color-mix(in srgb, var(--led) 70%, transparent),
                0 0 8px 3px color-mix(in srgb, var(--led) 30%, transparent);
            animation: ledPulse 5s ease-in-out infinite;
        }

        .led--green {
            --led: #22c55e;
        }

        .led--red {
            --led: #ef4444;
        }

        .led--yellow {
            --led: #f59e0b;
        }

        .led--gray {
            --led: #94a3b8;
        }

        @keyframes ledPulse {

            0%,
            100% {
                box-shadow:
                    inset 0 0 2px rgba(0, 0, 0, .35),
                    0 0 4px 1px color-mix(in srgb, var(--led) 55%, transparent),
                    0 0 8px 3px color-mix(in srgb, var(--led) 25%, transparent);
                filter: brightness(1);
            }

            50% {
                box-shadow:
                    inset 0 0 2px rgba(0, 0, 0, .35),
                    0 0 6px 2px color-mix(in srgb, var(--led) 80%, transparent),
                    0 0 10px 4px color-mix(in srgb, var(--led) 40%, transparent);
                filter: brightness(1.15);
            }
        }

        .icon-ring {
            width: 5rem;
            height: 5rem;
            border-radius: 9999px;
            display: grid;
            place-items: center;
            background: rgba(255, 255, 255, .18);
            box-shadow:
                inset 0 1px 2px rgba(255, 255, 255, .25),
                0 6px 18px rgba(0, 0, 0, .18);
            backdrop-filter: blur(2px);
            margin: 0 auto 0.5rem;
        }

        .icon-ring img {
            width: 2.6rem;
            height: 2.6rem;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, .18));
        }

        .metric-title {
            font-weight: 700;
            font-size: clamp(1.2rem, 1.2vw, 1.05rem);
        }

        .metric-value {
            font-weight: 800;
            font-size: clamp(1.6rem, 3vw, 2rem);
            line-height: 1.05;
        }

        .metric-status {
            font-weight: 600;
            font-size: clamp(.80rem, 1.1vw, 1rem);
            opacity: .95;
        }

        .main-content {
            padding: 1rem !important;
        }

        .room-card {
            transition: transform 0.05s ease-in-out, box-shadow 0.05s ease-in-out;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            border-color: var(--accent);
            color: white;
            filter: brightness(1.2);
        }

        #modal-room-detail .config-header .btn {
            transition: background-color 0.05s ease, border-color 0.05s ease;
        }

        #modal-room-detail .config-header button[data-close="modal-room-detail"]:hover {
            background-color: rgba(239, 68, 68, 0.25) !important;
            border-color: rgba(239, 68, 68, 0.8) !important;
        }

        #modal-reboot.centered>div,
        #modal-export.centered>div,
        #modal-device-map.centered>div,
        #modal-settings.centered .config-panel,
        #modal-room-detail.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
        }

        #modal-room-detail.centered .config-panel {
            width: calc(100vw - 4rem);
            height: calc(100vh - 4rem);
            max-width: initial;
        }

        .detail-card {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: .75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .detail-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: .75rem;
            flex-shrink: 0;
        }

        .detail-card-content {
            flex-grow: 1;
            position: relative;
        }

        .live-row {
            display: grid;
            grid-template-columns: 7.5rem 1fr;
            align-items: center;
        }

        @media (max-width:480px) {
            .live-row {
                grid-template-columns: 6.25rem 1fr;
            }
        }

        .live-values {
            font-variant-numeric: tabular-nums;
            letter-spacing: .01em;
        }

        .badge-chip {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: .35rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
        }

        .badge-temp {
            background: rgba(244, 63, 94, .12);
            color: #fda4af;
        }

        .badge-hum {
            background: rgba(59, 130, 246, .12);
            color: #93c5fd;
        }

        .live-sep {
            opacity: .45;
            margin: 0 .2rem;
        }

        .detail-card {
            display: flex;
            flex-direction: column;
        }

        .detail-card .detail-card-content {
            flex: 1 1 auto;
            min-height: 0;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.7rem;
            line-height: 1;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.05s;
        }

        .legend-item.hidden {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .legend-box {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
        }

        .modal-detail-room {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .card-chart,
        #detail-uptime-chart-container {
            overflow: visible !important;
        }

        #modal-room-detail .config-body {
            overflow-y: auto !important;
            overflow-x: hidden;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #modal-pin-map {
            z-index: 65;
        }

        #modal-sensor-rules {
            z-index: 65;
        }

        #modal-pin-map.centered>div {
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
            width: min(92vw, 32rem);
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(1) brightness(0.6);
            opacity: 0.9;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        input[type="datetime-local"],
        input[type="date"],
        input[type="time"],
        input[type="month"] {
            color: var(--text);
        }

        .schedule-input::-webkit-calendar-picker-indicator {
            display: none;
        }

        .custom-tooltip {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            transform: translate(-50%, -110%);
            transition: opacity 0.15s ease;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            font-size: 0.8rem;
            width: max-content;
            z-index: 100;
        }

        .custom-tooltip-header {
            font-weight: bold;
            margin-bottom: 6px;
        }

        .custom-tooltip-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tooltip-line {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tooltip-color-box {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .chart-legend .legend-item {
            cursor: default;
            pointer-events: none;
        }

        .chart-legend .legend-box {
            opacity: 1;
            border: 0 !important;
        }

        #detail-uptime-chart-container+div>* {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        #detail-uptime-pct {
            color: #000000;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
        }

        .btn-close-custom {
            background-color: rgba(239, 68, 68, 0.12);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
            transition: all 0s ease-in-out;
        }

        .btn-close-custom:hover {
            background-color: rgba(239, 68, 68, 0.25);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.4);
        }

        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .toast-notification {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 2.5rem 0.75rem 1.25rem;
            border-radius: 0.5rem;
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            width: max-content;
            max-width: 350px;
            animation: slideInRight 0.05s ease-out forwards;
            transition: border-color 0.05s ease-in-out;
        }

        .toast-fade-out {
            animation: fadeOut 0.4s ease-out forwards !important;
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }

            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .qa-popup-panel {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .qa-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .qa-msg {
            flex-grow: 1;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text);
        }

        .qa-close button.btn {
            height: auto;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            background: var(--panel-2);
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: none;
            color: transparent;
            opacity: 0;
        }

        input[type="datetime-local"] {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zM5 20V7h14V6l.002 14H5z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
        }

        .config-input:hover,
        .config-select:hover,
        input[type="datetime-local"]:hover {
            border-color: var(--accent);
        }

        .room-card {
            transition: transform 0.05s ease-in-out, box-shadow 0.05s ease-in-out, border-color 0.05s ease-in-out;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--accent);
        }

        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-close-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0.25rem 0.5rem;
            transition: color 0.2s ease;
        }

        .toast-close-btn:hover {
            color: var(--text);
        }

        .toast-notification {
            transition: border-color 0.2s ease-in-out;
        }

        .toast-notification:hover {
            border-color: var(--accent);
        }

        .weekday-btn {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border: 1px solid var(--border);
            background: var(--panel-2);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 0.8rem;
            text-align: center;
        }

        .weekday-btn:hover {
            border-color: var(--muted);
        }

        .weekday-btn.active {
            background-color: var(--accent);
            border-color: var(--accent);
            color: white;
            font-weight: 600;
        }

        .btn.action-delete {
            background-color: rgba(239, 68, 68, 0.2) !important;
            border-color: rgba(239, 68, 68, 0.7) !important;
            color: #f87171 !important;
        }

        .custom-dropdown-container {
            position: relative;
            z-index: 80;
        }

        .dropdown-panel {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--cfg-radius);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.15s;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background-color: var(--accent);
            color: white;
        }

        .item-delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1rem;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
            opacity: 0.7;
        }

        .dropdown-item:hover .item-delete-btn {
            color: white;
            opacity: 1;
        }

        .schedule-time-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: .5rem;
            padding: .6rem .75rem;
            font-variant-numeric: tabular-nums;
        }

        .schedule-time-item .time-text {
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: .05em;
        }

        .schedule-time-item .actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--muted);
            font-size: 1rem;
            padding: 0 .25rem;
            margin-left: 0.75rem;
            opacity: 0.7;
            transition: all 0.05s ease-in-out;
        }

        .schedule-time-item .actions button:hover {
            color: var(--text);
            opacity: 1;
        }

        .schedule-time-item .actions .remove-item-btn:hover {
            color: #ef4444;
        }

        .btn,
        #qa-card .grid button {
            padding: .5rem .75rem;
            border-radius: .55rem;
            border: 1px solid var(--border);
            background: var(--panel-2);
            color: var(--text);
            cursor: pointer;
            height: 50px;
            font-size: .9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.05s ease-in-out;
        }

        #qa-card .grid button {
            height: auto;
            padding: 0.75rem;
        }

        .btn,
        .room-card,
        #qa-card .grid button,
        .config-input,
        .config-select,
        .weekday-btn,
        .config-tab,
        .custom-dropdown-container .flex-1.config-input,
        #series-dropdown-btn {
            transition: all 0.05s ease-in-out;
        }

        .btn,
        .room-card,
        #qa-card .grid button,
        .config-input,
        .config-select,
        .weekday-btn,
        .config-tab,
        .custom-dropdown-container .flex-1.config-input,
        #series-dropdown-btn,
        [id^="recipient-action-"],
        .dropdown-item {
            transition: all 0.05s ease-in-out;
        }

        .room-card:hover,
        .room-card:focus-visible {
            color: var(--text);
            border-color: transparent !important;
        }

        .config-input:hover,
        .config-select:hover,
        input[type="datetime-local"]:hover,
        .config-input:focus-visible,
        .config-select:focus-visible,
        input[type="datetime-local"]:focus-visible {
            border-color: transparent;
        }

        .btn:hover i,
        .btn:focus-visible i {
            color: var(--accent);
        }

        .btn:hover {
            color: var(--text);
            filter: none;
            border-color: var(--border);
        }

        .weekday-btn.active:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
            box-shadow:
                inset 0 0 0 1.5px rgba(255, 255, 255, 0.8),
                0 0 12px 0 rgba(59, 130, 246, 0.6);
        }

        .dropdown-item:hover {
            background-color: transparent;
            color: var(--accent);
        }

        [id^="recipient-action-"]:hover .config-icon {
            color: var(--accent);
        }

        .btn:hover,
        .btn:focus-visible,
        .room-card:hover,
        .room-card:focus-visible,
        #qa-card .grid button:hover,
        #qa-card .grid button:focus-visible,
        .config-input:hover,
        .config-input:focus-visible,
        .config-select:hover,
        .config-select:focus-visible,
        input[type="datetime-local"]:hover,
        input[type="datetime-local"]:focus-visible,
        .weekday-btn:hover,
        .weekday-btn:focus-visible,
        .config-tab:hover,
        .config-tab:focus-visible,
        .custom-dropdown-container .config-input:hover,
        .custom-dropdown-container .config-input:focus-visible,
        #series-dropdown-btn:hover,
        #series-dropdown-btn:focus-visible,
        [id^="recipient-action-"]:hover,
        [id^="recipient-action-"]:focus-visible,
        .dropdown-item:hover,
        .dropdown-item:focus-visible,
        .clickable-sensor-row:hover,
        .clickable-sensor-row:focus-visible,
        #qa-alert-card:hover,
        #qa-alert-card:focus-visible,
        #card-critical:hover,
        #card-critical:focus-visible,
        #card-warning:hover,
        #card-warning:focus-visible {
            &:where(:not(.btn-close-custom):not(:disabled)) {
                transform: translateY(-2px);
                box-shadow:
                    0 0 12px 0 rgba(59, 130, 246, 0.4),
                    inset 0 0 0 1.5px var(--accent);
            }
        }

        .btn:hover,
        .btn:focus-visible {
            color: var(--text);
        }

        .dropdown-item:hover,
        .dropdown-item:focus-visible {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--text);
        }

        .config-tab:hover,
        .config-tab:focus-visible {
            color: var(--accent);
            background-color: rgba(59, 130, 246, 0.1);
        }

        .weekday-btn:hover,
        .weekday-btn:focus-visible {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .weekday-btn.active:hover,
        .weekday-btn.active:focus-visible {
            filter: brightness(1.2);
            box-shadow:
                inset 0 0 0 1.5px rgba(255, 255, 255, 0.8),
                0 0 12px 0 rgba(59, 130, 246, 0.6);
        }

        .config-input:hover,
        .config-input:focus-visible,
        .config-select:hover,
        .config-select:focus-visible,
        input[type="datetime-local"]:hover,
        input[type="datetime-local"]:focus-visible {
            border-color: transparent;
        }

        .badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }

        .badge-critical {
            color: #fca5a5;
            background-color: rgba(239, 68, 68, 0.2);
        }

        .badge-warning {
            color: #fcd34d;
            background-color: rgba(251, 191, 36, 0.15);
        }

        #modal-alert-center:not(.hidden) {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        #modal-alert-center {
            background-color: rgba(11, 18, 32, 0.7);
            transition: opacity 0.05s ease-in-out;
        }

        #modal-alert-center .alert-center-panel {
            max-height: calc(100vh - 3rem);
            height: calc(100vh - 3rem);
        }

        #alert-table-body tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .side-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 28rem;
            max-width: 90vw;
            height: 100%;
            background: var(--panel);
            border-left: 1px solid var(--border);
            z-index: 70;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.05s ease-in-out;
        }

        .side-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
        }

        .drawer-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .drawer-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border);
            background: var(--panel-2);
        }

        .effective-rule-box {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.8rem;
        }

        .effective-rule-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        .origin-badge {
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .origin-sensor {
            background-color: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        .origin-room {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .origin-system {
            background-color: rgba(147, 51, 234, 0.2);
            color: #c4b5fd;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--panel-2);
            border: 1px solid var(--border);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: var(--muted);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--accent);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        .clickable-sensor-row {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: pointer;
        }

        .clickable-sensor-row:hover {
            background-color: var(--panel-2);
            border-color: var(--accent);
        }

        #modal-sensor-rules.centered .config-panel {
            right: auto !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            transition: transform 160ms ease, opacity 160ms ease;
            width: 60rem;
            max-width: 90vw !important;
        }

        #qa-alert-card,
        #card-critical,
        #card-warning {
            transition: transform 0.05s ease-in-out, box-shadow 0.05s ease-in-out, border-color 0.05s ease-in-out;
        }

        #qa-alert-card:hover,
        #card-critical:hover,
        #card-warning:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }

        #detail-alert-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-top: 4px;
        }

        .alert-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 500;
            line-height: 1.2;
            border: 1px solid transparent;
        }

        .alert-chip-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .alert-chip-info strong {
            font-weight: 700;
            opacity: 0.9;
        }

        .alert-chip .icon {
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .btn-ack-chip {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #93c5fd;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.05s ease-in-out;
        }

        .btn-ack-chip:hover {
            background-color: rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.8);
            color: #fff;
            transform: scale(1.05);
        }

        .alert-chip-critical {
            background-color: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }

        .alert-chip-warning {
            background-color: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.4);
            color: #fcd34d;
        }

        .flash-update {
            animation: flash 0.7s ease-out;
        }

        @keyframes flash {
            0% {
                background-color: rgba(253, 224, 71, 0.25);
                border-color: rgba(253, 224, 71, 0.6);
                box-shadow: 0 0 12px rgba(253, 224, 71, 0.3);
            }

            100% {
                background-color: transparent;
                border-color: var(--border);
                box-shadow: none;
            }
        }

        .flash-update-row {
            animation: flash-row 0.8s ease-out;
        }

        @keyframes flash-row {

            0%,
            100% {
                background-color: var(--panel);
            }

            50% {
                background-color: var(--border);
            }
        }

        .btn.btn-confirm {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
            font-weight: 600;
        }

        .btn.btn-confirm:hover:not(:disabled) {
            background-color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: none !important;
        }

        .btn.btn-reset {
            background-color: #7f1d1d;
            border-color: #991b1b;
            color: #fca5a5;
            font-weight: 600;
        }

        .btn.btn-reset:hover:not(:disabled) {
            background-color: #991b1b;
            border-color: #b91c1c;
            color: white;
            transform: translateY(-2px);
            box-shadow: none !important;
        }

        #modal-confirm:not(.hidden) {
            display: flex;
        }

        #modal-confirm .qa-popup-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem;
            animation: fadeInScale 0.2s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #btn-confirm-yes {
            font-weight: 600;
            transition: all 0.05s ease-in-out;
        }

        #btn-confirm-yes.btn-confirm {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        #btn-confirm-yes.btn-confirm:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        #btn-confirm-yes.btn-reset {
            background-color: #dc2626;
            border-color: #dc2626;
            color: white;
        }

        #btn-confirm-yes.btn-reset:hover {
            background-color: #b91c1c;
            border-color: #b91c1c;
        }

        .confirm-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            margin-top: 0.5rem;
        }

        .config-overlay,
        [id^="modal-"]:not(#modal-confirm) {
            background-color: rgba(11, 18, 32, 0.7);
            backdrop-filter: blur(4px);
            transition: opacity 0.05s ease-out;
        }

        #modal-reboot>div,
        #modal-export>div,
        #modal-device-map>div,
        #modal-pin-map>div,
        #modal-recipients>div,
        #modal-ack .config-panel,
        #modal-settings .config-panel,
        #modal-room-detail .config-panel,
        #modal-alert-center .alert-center-panel,
        #modal-sensor-rules .config-panel {
            transition: transform 0.05s ease-out, opacity 0.05s ease-out;
        }

        .modal-initial-state,
        .modal-is-exiting>div,
        .modal-is-exiting .config-panel,
        .modal-is-exiting .alert-center-panel {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        .modal-is-exiting {
            opacity: 0;
        }

        [id^="modal-"] {
            background-color: rgba(11, 18, 32, 0.7);
            backdrop-filter: blur(4px);
            transition: opacity 0.05s ease-out;
            opacity: 1;
        }

        [id^="modal-"]>div,
        [id^="modal-"] .config-panel,
        [id^="modal-"] .alert-center-panel {
            transition: transform 0.0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.0.5s ease-out;
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-is-entering {
            opacity: 0;
        }

        .modal-is-entering>div,
        .modal-is-entering .config-panel,
        .modal-is-entering .alert-center-panel {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        .modal-is-exiting {
            opacity: 0;
        }

        .modal-is-exiting>div,
        .modal-is-exiting .config-panel,
        .modal-is-exiting .alert-center-panel {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        .settings-locked .config-body fieldset,
        .settings-locked .config-body .cfg-mac-row,
        .settings-locked .config-body label {
            opacity: 0.7;
            transition: opacity 0.05s ease-in-out;
        }

        .settings-locked .config-body input,
        .settings-locked .config-body select {
            pointer-events: none;
            cursor: not-allowed;
        }

        #summary-card-temp-max,
        #summary-card-hum-max,
        #summary-card-temp-rise,
        #summary-card-dew-max {
            transition: transform 0.05s ease-in-out, box-shadow 0.05s ease-in-out, border-color 0.05s ease-in-out;
        }

        #summary-card-temp-max:hover,
        #summary-card-hum-max:hover,
        #summary-card-temp-rise:hover,
        #summary-card-dew-max:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }

        #recovery-fab {
            opacity: 0;
            transform: scale(0.5);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.2s ease-out,
                box-shadow 0.2s ease-out;
            cursor: grab;
        }

        #recovery-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(2, 132, 255, 0.4);
        }

        #recovery-fab:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        #recovery-fab.fab-visible {
            opacity: 1;
            transform: scale(1);
        }

        .unseen-recovery {
            background-color: rgba(59, 130, 246, 0.15) !important;
            border-left: 3px solid var(--accent) !important;
        }

        .unseen-recovery:hover {
            background-color: rgba(59, 130, 246, 0.25) !important;
        }

        #modal-alert-center .config-input,
        #modal-alert-center .config-select {
            height: 50px;
        }
    </style>
</head>

<body class="relative h-screen overflow-hidden">
    <main id="mainContent" class="main-content flex flex-col">
        <div class="flex-1 overflow-auto p-6 h-full">
            <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,1fr)_22rem] gap-6 items-stretch h-full">
                <div class="flex flex-col h-full">
                    <section
                        class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6 items-stretch auto-rows-fr flex-1 h-full">
                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-a">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-a" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room A</h3>
                                </div>
                                <span id="updated-room-a" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-a">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-a">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-b">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-b" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room B</h3>
                                </div>
                                <span id="updated-room-b" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-b">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-b">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-c">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-c" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room C</h3>
                                </div>
                                <span id="updated-room-c" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-c">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-c">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-[var(--panel)] border border-[var(--border)] p-5 rounded-2xl flex flex-col h-full room-card cursor-pointer"
                            data-room="room-d">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <span id="status-dot-room-d" class="w-3 h-3 rounded-full bg-red-400 mr-2"></span>
                                    <h3 class="text-xl font-bold hidden">Room D</h3>
                                </div>
                                <span id="updated-room-d" class="text-base text-[var(--muted)]"></span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4 flex-1">
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-green-400 to-green-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Temperature.png" alt="Temperature Icon"></div>
                                    <h4 class="metric-title">Temperature</h4>
                                    <p class="metric-value" id="temp-room-d">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                                <div
                                    class="metric-card rounded-xl shadow p-4 bg-gradient-to-r from-blue-400 to-blue-500 text-white text-center flex flex-col justify-center hidden">
                                    <div class="icon-ring"><img src="Humidity.png" alt="Humidity Icon"></div>
                                    <h4 class="metric-title">Humidity</h4>
                                    <p class="metric-value" id="rh-room-d">—</p>
                                    <p class="metric-status">Offline</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                <!-- Sidebar -->
                <aside class="self-stretch h-full">
                    <div class="space-y-4 pr-1 flex flex-col h-full">
                        <div id="qa-alert-card"
                            class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)] cursor-pointer">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold">🔔 Alerts</h4>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div id="card-critical"
                                    class="p-4 rounded-lg border border-[var(--border)] bg-opacity-60 cursor-pointer">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="text-xs text-[var(--muted)]">Critical</div>
                                            <div id="count-critical" class="text-3xl font-extrabold text-red-400">0
                                            </div>
                                        </div>
                                        <div
                                            class="w-10 h-10 rounded-full bg-[rgba(248,113,113,0.08)] flex items-center justify-center">
                                            <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                                        </div>
                                    </div>
                                    <ul id="list-critical"
                                        class="text-sm text-[var(--muted)] space-y-1 max-h-24 overflow-y-auto mt-3">
                                    </ul>
                                </div>
                                <div id="card-warning"
                                    class="p-4 rounded-lg border border-[var(--border)] bg-opacity-60 cursor-pointer">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="text-xs text-[var(--muted)]">Warning</div>
                                            <div id="count-warning" class="text-3xl font-extrabold text-yellow-400">0
                                            </div>
                                        </div>
                                        <div
                                            class="w-10 h-10 rounded-full bg-[rgba(251,191,36,0.06)] flex items-center justify-center">
                                            <i class="fa-solid fa-triangle-exclamation text-yellow-400"></i>
                                        </div>
                                    </div>
                                    <ul id="list-warning"
                                        class="text-sm text-[var(--muted)] space-y-1 max-h-24 overflow-y-auto mt-3">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)] flex flex-col flex-1">
                            <h4 class="text-lg font-semibold mb-3">📈 System Summary</h4>
                            <div class="grid grid-cols-2 gap-3 h-full grid-rows-2">
                                <div id="summary-card-temp-max"
                                    class="rounded-lg border border-[var(--border)] p-3 bg-red-500/10 flex flex-col justify-between items-center text-center cursor-pointer">
                                    <div class="text-sm text-red-300/80">Highest Temp</div>
                                    <div class="text-3xl font-extrabold leading-tight text-red-400"
                                        id="kpi-pro-temp-max">—</div>
                                    <div class="text-xs text-red-400/70" id="kpi-pro-temp-max-room"></div>
                                </div>
                                <div id="summary-card-hum-max"
                                    class="rounded-lg border border-[var(--border)] p-3 bg-blue-500/10 flex flex-col justify-between items-center text-center cursor-pointer">
                                    <div class="text-sm text-blue-300/80">Highest Humidity</div>
                                    <div class="text-3xl font-extrabold leading-tight text-blue-400"
                                        id="kpi-pro-hum-max">—</div>
                                    <div class="text-xs text-blue-400/70" id="kpi-pro-hum-max-room"></div>
                                </div>
                                <div id="summary-card-dew-max"
                                    class="rounded-lg border border-[var(--border)] p-3 bg-teal-500/10 flex flex-col justify-between items-center text-center cursor-pointer">
                                    <div class="text-sm text-teal-300/80">Highest Dew Point</div>
                                    <div class="text-3xl font-extrabold leading-tight text-teal-400"
                                        id="kpi-pro-dew-max">—</div>
                                    <div class="text-xs text-teal-400/70" id="kpi-pro-dew-max-room"></div>
                                </div>
                                <div id="summary-card-temp-rise"
                                    class="rounded-lg border border-[var(--border)] p-3 bg-amber-500/10 flex flex-col justify-between items-center text-center cursor-pointer hover:border-[var(--accent)] transition-all">
                                    <div class="text-sm text-amber-300/80">Fastest Temp Rise</div>
                                    <div class="text-3xl font-extrabold leading-tight text-amber-400"
                                        id="kpi-pro-temp-rise">—</div>
                                    <div class="text-xs text-amber-400/70" id="kpi-pro-temp-rise-room"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Actions -->
                        <div id="qa-card" class="bg-[var(--panel)] p-4 rounded-xl border border-[var(--border)]">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold">⚡ Quick Actions</h4>
                            </div>
                            <!-- 2 แถว 3 คอลัมน์ -->
                            <div class="grid grid-cols-3 gap-2">
                                <!-- Reboot -->
                                <button id="qa-reboot"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-white/5"
                                    title="Reboot">
                                    <i class="fa-solid fa-power-off"></i>
                                </button>
                                <!-- Export -->
                                <button id="qa-export"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-white/5"
                                    title="Export">
                                    <i class="fa-solid fa-file-arrow-down"></i>
                                </button>
                                <!-- Settings -->
                                <button id="qa-settings"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-white/5"
                                    title="Settings">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                                <!-- Device Map -->
                                <button id="qa-device-map"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-white/5"
                                    title="Device Map">
                                    <i class="fa-solid fa-diagram-project"></i>
                                </button>
                                <!-- Recipients (ใหม่ แยกเป็นโมดัลของตัวเอง) -->
                                <button id="qa-recipients"
                                    class="px-3 py-2 rounded-lg border border-[var(--border)] hover:bg-white/5"
                                    title="Recipients">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                                <div aria-hidden="true"></div>
                            </div>
                            <p id="qa-status" class="mt-3 text-xs text-[var(--muted)]"></p>
                        </div>
                    </div>
            </div>
        </div>
        <div id="modal-room-detail" class="config-overlay hidden">
            <div class="config-panel">
                <div class="config-header">
                    <div class="flex items-center gap-4">
                        <span id="detail-room-status-led" class="led led--red"></span>
                        <h5 id="detail-room-name" class="font-semibold text-lg">Room Details</h5>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="detail-btn-reboot" class="btn"><i
                                class="fa-solid fa-power-off mr-2"></i>Reboot</button>
                        <button id="detail-btn-export" class="btn"><i
                                class="fa-solid fa-file-arrow-down mr-2"></i>Export</button>
                        <button id="detail-btn-settings" class="btn"><i
                                class="fa-solid fa-gear mr-2"></i>Settings</button>
                        <button id="open-pin-map" class="btn"><i class="fa-solid fa-tags mr-2"></i>Sensor Name</button>
                        <button data-close="modal-room-detail"
                            class="w-11 h-11 flex items-center justify-center rounded-lg btn-close-custom"><i
                                class="fa-solid fa-xmark text-xl"></i></button>
                    </div>
                </div>
                <div class="config-body grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">
                    <div class="flex flex-col gap-4 h-full min-h-0">
                        <!-- Room Alerts -->
                        <div class="detail-card flex-1 min-h-0" id="detail-card-alerts">
                            <h6 class="detail-card-title">🔔 Room Alerts</h6>
                            <div class="detail-card-content overflow-y-auto">
                                <ul id="detail-alert-list">
                                    <li class="text-center text-[var(--muted)] mt-4">No active alerts</li>
                                </ul>
                            </div>
                        </div>
                        <div class="detail-card">
                            <h6 class="detail-card-title">📡 Live data</h6>
                            <!-- KPIs -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center">
                                <!-- Temperature -->
                                <div class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)]">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Temperature (°C)</div>
                                    <div class="mt-3 grid grid-cols-3 gap-3 items-end">
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MIN</div>
                                            <div id="kpi-temp-min" class="text-2xl font-extrabold text-sky-400">—</div>
                                            <div class="h-1 rounded bg-sky-500/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">AVG</div>
                                            <div id="kpi-temp-avg" class="text-2xl font-extrabold">—</div>
                                            <div class="h-1 rounded bg-slate-300/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MAX</div>
                                            <div id="kpi-temp-max" class="text-2xl font-extrabold text-red-400">—</div>
                                            <div class="h-1 rounded bg-red-500/30 mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Humidity -->
                                <div class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)]">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Humidity (%)</div>
                                    <div class="mt-3 grid grid-cols-3 gap-3 items-end">
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MIN</div>
                                            <div id="kpi-rh-min" class="text-2xl font-extrabold text-sky-400">—</div>
                                            <div class="h-1 rounded bg-sky-500/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">AVG</div>
                                            <div id="kpi-rh-avg" class="text-2xl font-extrabold">—</div>
                                            <div class="h-1 rounded bg-slate-300/30 mt-1"></div>
                                        </div>
                                        <div>
                                            <div class="text-[10px] text-[var(--muted)]">MAX</div>
                                            <div id="kpi-rh-max" class="text-2xl font-extrabold text-red-400">—</div>
                                            <div class="h-1 rounded bg-red-500/30 mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Dew Point -->
                                <div
                                    class="bg-[var(--panel)] p-4 rounded-lg border border-[var(--border)] flex flex-col items-center justify-center">
                                    <div class="text-sm text-[var(--muted)] font-semibold">Dew Point (°C)</div>
                                    <div id="kpi-dew-avg" class="text-3xl font-extrabold text-emerald-400 mt-2">—</div>
                                    <div class="h-1 w-16 rounded bg-emerald-500/30 mt-2"></div>
                                </div>
                            </div>
                            <div class="relative mt-4">
                                <div id="detail-uptime-chart-container" class="h-8 bg-[var(--panel-2)] rounded-lg">
                                    <canvas id="detail-uptime-chart-canvas"></canvas>
                                </div>
                                <div
                                    class="absolute inset-x-0 top-1/2 -translate-y-1/2 transform flex justify-between items-center px-4 pointer-events-none">
                                    <h6 class="detail-card-title !mb-0 text-sm text-slate-300 flex items-center">
                                    </h6>
                                    <span id="detail-uptime-pct"
                                        class="hidden font-bold text-lg text-white drop-shadow-md flex items-center">
                                        — %
                                    </span>
                                </div>
                            </div>
                            <!-- divider -->
                            <div class="border-t border-[var(--border)] my-4"></div>
                            <!-- Live sensors merged in -->
                            <div class="detail-card-content overflow-y-auto">
                                <ul id="detail-sensor-list" class="space-y-2">
                                    <li class="text-center text-[var(--muted)] mt-4"></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 h-full min-h-0">
                        <div id="detail-toolbar" class="detail-card p-3">
                            <div id="range-controls"
                                class="mb-3 grid grid-cols-1 md:grid-cols-[1fr_1fr_auto_auto] gap-2 items-end">
                                <label class="text-xs text-[var(--muted)]">
                                    Start
                                    <input id="range-start" type="datetime-local"
                                        class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2 text-sm">
                                </label>
                                <label class="text-xs text-[var(--muted)]">
                                    End
                                    <input id="range-end" type="datetime-local"
                                        class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2 text-sm">
                                </label>
                                <button id="btn-apply-range" class="btn btn-confirm h-10 px-4">Apply</button>
                                <button id="btn-reset-range" class="btn btn-reset h-10 px-4">Reset</button>
                            </div>
                            <div class="mt-3 relative text-sm">
                                <button id="series-dropdown-btn"
                                    class="btn h-10 px-4 w-full text-left flex justify-between items-center">
                                    <span>Select Series & Options</span>
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                </button>
                                <div id="series-dropdown-panel"
                                    class="hidden absolute z-10 mt-1 w-full bg-[var(--panel)] border border-[var(--border)] rounded-lg shadow-lg p-3">
                                    <div id="series-toggle" class="grid grid-cols-3 gap-x-4 gap-y-2 text-sm">
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="overall" checked> Overall</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin25"> Pin 25</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin33"> Pin 33</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="dew" checked> Dew Point(Overall)</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin26"> Pin 26</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                data-series="pin32"> Pin 32</label>
                                        <label class="inline-flex items-center gap-2"><input type="checkbox"
                                                id="toggle-thresholds"> Thresholds</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-card flex-1 min-h-0">
                            <div class="flex justify-between items-center mb-2">
                                <h6 class="detail-card-title !mb-0">Temperature (°C)</h6>
                                <div id="legend-container-temp" class="chart-legend"></div>
                            </div>
                            <div class="detail-card-content">
                                <canvas id="detail-chart-temp" class="w-full h-full"></canvas>
                            </div>
                        </div>
                        <div class="detail-card flex-1 min-h-0">
                            <div class="flex justify-between items-center mb-2">
                                <h6 class="detail-card-title !mb-0">Humidity (%)</h6>
                                <div id="legend-container-rh" class="chart-legend"></div>
                            </div>
                            <div class="detail-card-content">
                                <canvas id="detail-chart-rh" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="modal-summary-detail" class="config-overlay hidden centered">
            <div class="config-panel" style="width: 32rem; max-width: 90vw;">
                <div class="config-header">
                    <h5 id="summary-detail-title" class="font-semibold text-lg">Metric Details</h5>
                    <button data-close="modal-summary-detail"
                        class="w-11 h-11 flex items-center justify-center rounded-lg btn-close-custom">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="config-body p-4">
                    <ul id="summary-detail-list" class="space-y-3">
                    </ul>
                </div>
            </div>
        </div>
        </div>
        <div id="modal-ack" class="fixed inset-0 z-[70] hidden">
            <div class="absolute inset-0 bg-transparent" data-close="modal-ack"></div>
            <div class="config-panel w-[30rem] max-w-[95vw]"
                style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
                <div class="config-header">
                    <h5 class="font-semibold text-lg">Acknowledge Alert</h5>
                    <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                        data-close="modal-ack">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="config-body">
                    <form id="form-ack" class="space-y-4">
                        <div>
                            <label for="ack-by-input" class="config-label">Acknowledged By <span
                                    class="text-red-400">*</span></label>
                            <input type="text" id="ack-by-input" class="config-input" required
                                placeholder="Enter your name">
                            <p id="ack-by-error" class="text-red-400 text-sm mt-1 hidden">This field is required.</p>
                        </div>
                        <div>
                            <label for="ack-note-input" class="config-label">Note (Optional)</label>
                            <textarea id="ack-note-input" class="config-input" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="config-footer flex justify-end">
                    <button id="btn-confirm-ack" class="btn btn-primary"><i
                            class="fa-solid fa-check mr-2"></i>Confirm</button>
                </div>
            </div>
        </div>
        <div id="modal-alert-center" class="fixed inset-0 z-[60] hidden">
            <div class="absolute inset-0 bg-transparent"></div>
            <div class="alert-center-panel w-[80rem] max-w-[95vw] bg-[var(--panel)] border border-[var(--border)] rounded-xl flex flex-col max-h-[90vh]"
                onclick="event.stopPropagation()">
                <div class="flex-shrink-0 p-4 border-b border-[var(--border)] flex justify-between items-center">
                    <h5 class="font-semibold text-lg">Alerts Center</h5>
                    <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                        data-close="modal-alert-center">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="flex-shrink-0 p-4 border-b border-[var(--border)]">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="alert-filter-search"
                                class="text-sm font-medium text-slate-400 mb-1 block">Search</label>
                            <input type="text" id="alert-filter-search" class="config-input"
                                placeholder="Search MAC, Sensor, Note...">
                        </div>
                        <div>
                            <label for="alert-filter-level"
                                class="text-sm font-medium text-slate-400 mb-1 block">Level</label>
                            <select id="alert-filter-level" class="config-select">
                                <option value="">All Levels</option>
                                <option value="critical">Critical</option>
                                <option value="warning">Warning</option>
                            </select>
                        </div>
                        <div>
                            <label for="alert-filter-status"
                                class="text-sm font-medium text-slate-400 mb-1 block">Status</label>
                            <select id="alert-filter-status" class="config-select">
                                <option value="open,ack">Active(Open/ACK)</option>
                                <option value="open">Open</option>
                                <option value="ack">Acknowledged</option>
                                <option value="closed">Closed (History)</option>
                            </select>
                        </div>
                        <div>
                            <label for="alert-filter-start-date"
                                class="text-sm font-medium text-slate-400 mb-1 block">Start</label>
                            <input type="datetime-local" id="alert-filter-start-date" class="config-input">
                        </div>
                        <div>
                            <label for="alert-filter-end-date"
                                class="text-sm font-medium text-slate-400 mb-1 block">End</label>
                            <input type="datetime-local" id="alert-filter-end-date" class="config-input">
                        </div>
                        <div class="lg:col-start-4 flex gap-2">
                            <button id="alert-filter-apply" class="btn btn-confirm w-full">Apply</button>
                            <button id="alert-filter-reset" class="btn btn-reset w-full">Reset</button>
                        </div>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="sticky top-0 bg-[var(--panel-2)] z-10">
                            <tr>
                                <th class="p-3 text-center w-12"><input type="checkbox" id="ack-all-checkbox"></th>
                                <th class="p-3">Time</th>
                                <th class="p-3">Room</th>
                                <th class="p-3">Sensor</th>
                                <th class="p-3">Metric</th>
                                <th class="p-3">Level</th>
                                <th class="p-3">Value</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Ack By</th>
                                <th class="p-3">Note</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alert-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="flex-shrink-0 p-3 border-t border-[var(--border)] flex items-center gap-4">
                    <button id="btn-bulk-ack" class="btn btn-primary" disabled><i
                            class="fa-solid fa-check-double mr-2"></i>Acknowledge Selected</button>
                </div>
            </div>
        </div>
        <div id="modal-sensor-rules" class="config-overlay hidden">
            <div class="config-panel">
                <div class="config-header">
                    <div>
                        <h5 class="font-semibold text-lg">Edit Sensor Rules</h5>
                        <p id="drawer-sensor-subtitle" class="text-sm text-[var(--muted)]">Room A / Sensor S1</p>
                    </div>
                    <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                        data-close="modal-sensor-rules">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="config-body grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-[var(--panel-2)] rounded-lg">
                            <label for="toggle-override" class="font-semibold">Enable Sensor-specific Override</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="toggle-override">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="sensor-rule-form-fields" class="space-y-4">
                            <fieldset class="border border-[var(--border)] rounded-lg p-3">
                                <legend class="px-2 font-semibold text-base text-red-400">Temperature (°C)</legend>
                                <div class="grid grid-cols-2 gap-3 mt-2">
                                    <label class="config-label">Critical Low<input id="rule-temp-crit-low" type="number"
                                            step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Warning Low<input id="rule-temp-warn-low" type="number"
                                            step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Warning High<input id="rule-temp-warn-high"
                                            type="number" step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Critical High<input id="rule-temp-crit-high"
                                            type="number" step="0.1" class="config-input mt-1"></label>
                                </div>
                            </fieldset>
                            <fieldset class="border border-[var(--border)] rounded-lg p-3">
                                <legend class="px-2 font-semibold text-base text-blue-400">Humidity (%)</legend>
                                <div class="grid grid-cols-2 gap-3 mt-2">
                                    <label class="config-label">Critical Low<input id="rule-hum-crit-low" type="number"
                                            step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Warning Low<input id="rule-hum-warn-low" type="number"
                                            step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Warning High<input id="rule-hum-warn-high" type="number"
                                            step="0.1" class="config-input mt-1"></label>
                                    <label class="config-label">Critical High<input id="rule-hum-crit-high"
                                            type="number" step="0.1" class="config-input mt-1"></label>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <div>
                        <h6 class="font-semibold mb-2">Effective Rules (read-only)</h6>
                        <div id="effective-rule-display" class="effective-rule-box space-y-1">
                        </div>
                    </div>
                </div>
                <div class="config-footer flex justify-between">
                    <button id="btn-reset-rule" class="btn btn-reset">Reset to Default</button>
                    <button id="btn-save-rule" class="btn btn-confirm">Save Rules</button>
                </div>
            </div>
        </div>
    </main>
    <div id="modal-reboot" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-transparent" data-close="modal-reboot"></div>
        <div class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[22rem]">
            <div class="flex items-center justify-between mb-3">
                <h5 class="font-semibold">Reboot device</h5>
                <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                    data-close="modal-reboot" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="form-reboot" class="space-y-3">
                <label class="block text-sm">Select room
                    <select name="target"
                        class="config-select mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                        <option value="room-a">Room A</option>
                        <option value="room-b">Room B</option>
                        <option value="room-c">Room C</option>
                        <option value="room-d">Room D</option>
                        <option value="all">All Devices</option>
                    </select>
                </label>
                <div class="flex items-center justify-end pt-1">
                    <button type="submit" class="px-6 py-3 rounded-lg font-semibold
                   bg-blue-600 text-white
                   hover:bg-blue-700
                   focus:outline-none focus:ring-2 focus:ring-blue-400
                   transition">
                        <i class="fa-solid fa-rotate-right mr-2"></i>Confirm
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-export" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-transparent" data-close="modal-export"></div>
        <div class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[26rem]">
            <!-- Header + ปุ่มกากบาท -->
            <div class="flex items-center justify-between mb-3">
                <h5 class="font-semibold">Generate Report</h5>
                <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                    data-close="modal-export" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="form-export" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <label class="block text-sm">Select room
                        <select name="room"
                            class="config-select mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                            <option value="room-a">Room A</option>
                            <option value="room-b">Room B</option>
                            <option value="room-c">Room C</option>
                            <option value="room-d">Room D</option>
                            <option value="all">All Rooms</option>
                        </select>
                    </label>
                    <label class="block text-sm">Type
                        <select name="type"
                            class="config-select mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                            <option value="csv">CSV</option>
                        </select>
                    </label>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <label class="block text-sm">Start
                        <input type="datetime-local" name="from"
                            class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                    </label>
                    <label class="block text-sm">End
                        <input type="datetime-local" name="to"
                            class="mt-1 w-full bg-[var(--panel-2)] border border-[var(--border)] rounded-lg p-2">
                    </label>
                </div>
                <div class="pt-1">
                    <label class="block text-sm mb-2 text-[var(--muted)]">Select Sensors</label>
                    <div id="export-sensor-list"
                        class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 p-3 rounded-lg bg-[var(--panel-2)] border border-[var(--border)] max-h-36 overflow-y-auto">
                        <span class="text-xs text-[var(--muted)] col-span-full text-center">Please select a single room
                            to see sensors</span>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-1">
                    <button type="submit" class="px-6 py-3 rounded-lg font-semibold
                       bg-blue-600 text-white
                       hover:bg-blue-700
                       focus:outline-none focus:ring-2 focus:ring-blue-400
                       transition">
                        <i class="fa-solid fa-check mr-2"></i>Confirm
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-settings" class="config-overlay">
        <div class="config-panel">
            <div class="config-header">
                <div class="flex items-center gap-2">
                    <h5 class="font-semibold">Settings</h5>
                    <select id="cfg-room" class="config-select" style="width:9rem">
                        <option value="room-a">Room A</option>
                        <option value="room-b">Room B</option>
                        <option value="room-c">Room C</option>
                        <option value="room-d">Room D</option>
                    </select>
                </div>
                <button class="flex items-center justify-center h-11 w-11 rounded-lg btn-close-custom"
                    data-close="modal-settings" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="config-body">
                <div class="config-tabs">
                    <button class="config-tab active" data-tab="alerts"><i
                            class="fa-solid fa-bell mr-2 opacity-80"></i>Alerts</button>
                    <button class="config-tab" data-tab="ethernet"><i
                            class="fa-solid fa-ethernet mr-2 opacity-80"></i>Ethernet</button>
                    <button class="config-tab" data-tab="mqtt"><i
                            class="fa-solid fa-server mr-2 opacity-80"></i>MQTT</button>
                </div>
                <!-- ALERTS -->
                <section id="tab-alerts" class="config-section active">
                    <h6 class="mb-2 font-semibold">
                        <span class="icon text-red-400"><i class="fa-solid fa-temperature-half"
                                aria-hidden="true"></i></span>Temperature (°C)
                    </h6>
                    <div class="config-row">
                        <label class="config-label">
                            <span class="icon text-red-400"><i class="fa-solid fa-arrow-down"
                                    aria-hidden="true"></i></span>Critical Low
                            <input id="temp-crit-low" type="number" step="0.1" class="config-input mt-1">
                        </label>
                        <label class="config-label">
                            <span class="icon text-amber-400"><i class="fa-solid fa-arrow-down"
                                    aria-hidden="true"></i></span>Warning Low
                            <input id="temp-warn-low" type="number" step="0.1" class="config-input mt-1">
                        </label>
                    </div>
                    <div class="config-row" style="margin-top:.75rem">
                        <label class="config-label">
                            <span class="icon text-amber-400"><i class="fa-solid fa-arrow-up"
                                    aria-hidden="true"></i></span>Warning High
                            <input id="temp-warn-high" type="number" step="0.1" class="config-input mt-1">
                        </label>
                        <label class="config-label">
                            <span class="icon text-red-400"><i class="fa-solid fa-arrow-up"
                                    aria-hidden="true"></i></span>Critical High
                            <input id="temp-crit-high" type="number" step="0.1" class="config-input mt-1">
                        </label>
                    </div>
                    <h6 class="mt-4 mb-2 font-semibold">
                        <span class="icon text-blue-400"><i class="fa-solid fa-droplet"
                                aria-hidden="true"></i></span>Humidity (%)
                    </h6>
                    <div class="config-row">
                        <label class="config-label">
                            <span class="icon text-red-400"><i class="fa-solid fa-arrow-down"
                                    aria-hidden="true"></i></span>Critical Low
                            <input id="hum-crit-low" type="number" step="0.1" class="config-input mt-1">
                        </label>
                        <label class="config-label">
                            <span class="icon text-amber-400"><i class="fa-solid fa-arrow-down"
                                    aria-hidden="true"></i></span>Warning Low
                            <input id="hum-warn-low" type="number" step="0.1" class="config-input mt-1">
                        </label>
                    </div>
                    <div class="config-row" style="margin-top:.75rem">
                        <label class="config-label">
                            <span class="icon text-amber-400"><i class="fa-solid fa-arrow-up"
                                    aria-hidden="true"></i></span>Warning High
                            <input id="hum-warn-high" type="number" step="0.1" class="config-input mt-1">
                        </label>
                        <label class="config-label">
                            <span class="icon text-red-400"><i class="fa-solid fa-arrow-up"
                                    aria-hidden="true"></i></span>Critical High
                            <input id="hum-crit-high" type="number" step="0.1" class="config-input mt-1">
                        </label>
                    </div>
                </section>
                <!-- ETHERNET -->
                <section id="tab-ethernet" class="config-section space-y-3">
                    <div class="cfg-mac-row">
                        <div class="cfg-mac-left">
                            <span class="icon text-sky-400"><i class="fa-solid fa-network-wired"
                                    aria-hidden="true"></i></span>
                            <span class="cfg-mac-label">MAC :</span>
                            <span id="cfg-mac" class="cfg-mac-value">--:--:--:--:--:--</span>
                        </div>
                        <button id="btn-copy-mac" class="btn flex items-center justify-center w-9 h-9 p-0"
                            aria-label="Copy MAC">
                            <span class="config-icon"><i class="fa-regular fa-copy"></i></span>
                        </button>
                    </div>
                    <label class="config-label">
                        <span class="icon text-emerald-400"><i class="fa-solid fa-microchip"
                                aria-hidden="true"></i></span>IP Address
                        <input id="ip" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-indigo-400"><i class="fa-solid fa-sitemap"
                                aria-hidden="true"></i></span>Subnet Mask
                        <input id="subnet" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-purple-400"><i class="fa-solid fa-route"
                                aria-hidden="true"></i></span>Gateway
                        <input id="gateway" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-blue-400"><i class="fa-solid fa-globe" aria-hidden="true"></i></span>DNS
                        <input id="dns" class="config-input mt-1" placeholder="">
                    </label>
                </section>
                <!-- MQTT -->
                <section id="tab-mqtt" class="config-section space-y-3">
                    <label class="config-label">
                        <span class="icon text-sky-400">
                            <i class="fa-solid fa-server" aria-hidden="true"></i>
                        </span>
                        Broker
                        <input id="mqtt-broker" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-amber-400">
                            <i class="fa-solid fa-diagram-project" aria-hidden="true"></i>
                        </span>
                        Port
                        <input id="mqtt-port" type="number" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-emerald-400">
                            <i class="fa-solid fa-user" aria-hidden="true"></i>
                        </span>
                        Username
                        <input id="mqtt-user" class="config-input mt-1" placeholder="">
                    </label>
                    <label class="config-label">
                        <span class="icon text-rose-400">
                            <i class="fa-solid fa-key" aria-hidden="true"></i>
                        </span>
                        Password
                        <input id="mqtt-pass" type="password" class="config-input mt-1" placeholder="">
                    </label>
                </section>
            </div>
            <div class="config-footer">
                <div class="flex items-center justify-end gap-3"> <button id="btn-edit-settings"
                        class="btn btn-confirm">
                        <i class="fa-solid fa-pencil mr-2"></i> Edit
                    </button>
                    <button id="btn-cancel-settings" class="btn hidden"> <i class="fa-solid fa-xmark mr-2"></i> Cancel
                    </button>
                    <button id="btn-save-settings" class="btn btn-confirm hidden"> <i class="fa-solid fa-save mr-2"></i>
                        Save & Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-pin-map" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-transparent" data-close="modal-pin-map"></div>
        <div class="absolute bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[32rem] max-w-[95vw]">
            <div class="flex items-center justify-between mb-4">
                <h5 class="font-semibold text-lg">Sensor Name</h5>
                <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                    data-close="modal-pin-map" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="form-pin-map" class="space-y-3">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin
                            25</label>
                        <input name="name_pin_25" placeholder="" class="config-input mt-1" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin
                            26</label>
                        <input name="name_pin_26" placeholder="" class="config-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin
                            32</label>
                        <input name="name_pin_32" placeholder="" class="config-input mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-[var(--muted)]">Sensor Pin
                            33</label>
                        <input name="name_pin_33" placeholder="" class="config-input mt-1">
                    </div>
                </div>
                <div class="flex items-center justify-end pt-2">
                    <button type="submit"
                        class="px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        <i class="fa-solid fa-check mr-2"></i>Confirm
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Device Map (MAC ↔ Room) -->
    <div id="modal-device-map" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-transparent" data-close="modal-device-map"></div>
        <div
            class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-4 w-[32rem] max-w-[95vw]">
            <div class="flex items-center justify-between mb-4">
                <h5 class="font-semibold text-lg">Device Map</h5>
                <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                    data-close="modal-device-map" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <form id="form-device-map" class="space-y-3">
                <div class="grid grid-cols-2">
                    <div class="pr-6 pb-6 border-r border-b border-dashed border-[var(--border)]">
                        <div class="space-y-3">
                            <div>
                                <label for="name_room_a" class="block text-xs font-medium text-[var(--muted)] mb-1">Room
                                    name</label>
                                <input type="text" id="name_room_a" name="name_room_a" placeholder=""
                                    class="config-input">
                            </div>
                            <div>
                                <label for="mac_room_a" class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                    Address</label>
                                <input type="text" id="mac_room_a" name="mac_room_a" placeholder=""
                                    class="config-input copyable">
                            </div>
                        </div>
                    </div>
                    <div class="pl-6 pb-6 border-b border-dashed border-[var(--border)]">
                        <div class="space-y-3">
                            <div>
                                <label for="name_room_b" class="block text-xs font-medium text-[var(--muted)] mb-1">Room
                                    name</label>
                                <input type="text" id="name_room_b" name="name_room_b" placeholder=""
                                    class="config-input">
                            </div>
                            <div>
                                <label for="mac_room_b" class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                    Address</label>
                                <input type="text" id="mac_room_b" name="mac_room_b" placeholder=""
                                    class="config-input copyable">
                            </div>
                        </div>
                    </div>
                    <div class="pr-6 pt-6 border-r border-dashed border-[var(--border)]">
                        <div class="space-y-3">
                            <div>
                                <label for="name_room_c" class="block text-xs font-medium text-[var(--muted)] mb-1">Room
                                    name</label>
                                <input type="text" id="name_room_c" name="name_room_c" placeholder=""
                                    class="config-input">
                            </div>
                            <div>
                                <label for="mac_room_c" class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                    Address</label>
                                <input type="text" id="mac_room_c" name="mac_room_c" placeholder=""
                                    class="config-input copyable">
                            </div>
                        </div>
                    </div>
                    <div class="pl-6 pt-6">
                        <div class="space-y-3">
                            <div>
                                <label for="name_room_d" class="block text-xs font-medium text-[var(--muted)] mb-1">Room
                                    name</label>
                                <input type="text" id="name_room_d" name="name_room_d" placeholder=""
                                    class="config-input">
                            </div>
                            <div>
                                <label for="mac_room_d" class="block text-xs font-medium text-[var(--muted)] mb-1">MAC
                                    Address</label>
                                <input type="text" id="mac_room_d" name="mac_room_d" placeholder=""
                                    class="config-input copyable">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-end pt-2">
                    <button type="submit"
                        class="px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        <i class="fa-solid fa-check mr-2"></i>Confirm
                    </button>
                </div>
                <p id="map-status" class="mt-2 text-xs text-[var(--muted)]"></p>
            </form>
        </div>
    </div>
    <div id="modal-recipients" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-transparent" data-close="modal-recipients"></div>
        <div
            class="absolute right-6 top-6 bg-[var(--panel)] border border-[var(--border)] rounded-xl p-0 w-[48rem] max-w-[95vw] flex flex-col max-h-[calc(100vh-3rem)]">
            <div class="config-header flex-shrink-0">
                <h5 class="font-semibold text-lg">Notification Settings</h5>
                <button class="flex items-center justify-center h-10 w-10 rounded-lg btn-close-custom"
                    data-close="modal-recipients" aria-label="Close">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="config-body flex-grow overflow-y-auto pr-2 space-y-6">
                <section>
                    <h6 class="font-semibold text-base mb-3 text-slate-300">
                        <i class="fa-solid fa-users w-5 mr-1 text-sky-400"></i>Recipients
                    </h6>
                    <div class="grid grid-cols-1 gap-y-6">
                        <div>
                            <label class="block mb-2 font-medium text-sm text-slate-400">Email Addresses</label>
                            <div class="custom-dropdown-container">
                                <div class="flex gap-2">
                                    <input id="recipient-input-email" type="email"
                                        placeholder="Add or select an email..." class="flex-1 config-input">
                                    <button id="recipient-action-email"
                                        class="w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-lg bg-[var(--panel-2)] border border-[var(--border)] text-emerald-400 hover:border-emerald-500">
                                        <span class="config-icon"><i class="fa-solid fa-plus"></i></span>
                                    </button>
                                </div>
                                <div id="email-dropdown-panel" class="dropdown-panel hidden"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block mb-2 font-medium text-sm text-slate-400">Telegram Chat IDs</label>
                            <div class="custom-dropdown-container">
                                <div class="flex gap-2">
                                    <input id="recipient-input-telegram" type="text"
                                        placeholder="Add or select a Chat ID..." class="flex-1 config-input">
                                    <button id="recipient-action-telegram"
                                        class="w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-lg bg-[var(--panel-2)] border border-[var(--border)] text-emerald-400 hover:border-emerald-500">
                                        <span class="config-icon"><i class="fa-solid fa-plus"></i></span>
                                    </button>
                                </div>
                                <div id="telegram-dropdown-panel" class="dropdown-panel hidden"></div>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <h6 class="font-semibold text-base mb-3 text-slate-300">
                        <i class="fa-solid fa-calendar-day w-5 mr-1 text-amber-400"></i>Daily Report Notifications
                    </h6>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 font-medium text-sm text-slate-400">Days of the Week to
                                Send</label>
                            <div id="schedule-weekdays" class="flex justify-between items-center gap-1">
                            </div>
                        </div>
                        <div>
                            <label class="block mb-2 font-medium text-sm text-slate-400">Report Schedules</label>
                            <div id="schedule-list" class="space-y-3">
                            </div>
                            <button id="schedule-add-btn" class="btn h-10 text-xs px-3 w-full mt-3">
                                <i class="fa-solid fa-plus mr-2"></i>Add Schedule
                            </button>
                        </div>
                    </div>
                </section>
                <div class="border-t border-dashed border-[var(--border)] my-2"></div>
            </div>
            <div class="config-footer mt-auto flex-shrink-0">
                <div class="flex items-center justify-between gap-2">
                    <button id="btn-save-notification-settings"
                        class="w-full px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                        <i class="fa-solid fa-save mr-2"></i>Save Settings
                    </button>
                </div>
                <p id="recipients-status" class="mt-2 text-xs text-[var(--muted)] text-right"></p>
            </div>
        </div>
    </div>
    <div id="modal-confirm" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 p-4">
        <div class="qa-popup-panel w-full max-w-md">
            <div class="flex items-center gap-4">
                <div id="confirm-icon" class="qa-icon text-2xl text-amber-400">
                    <i class="fa-solid fa-circle-question"></i>
                </div>
                <div class="qa-msg">
                    <h5 id="confirm-title" class="font-bold text-lg mb-1">Confirm Action</h5>
                    <p id="confirm-message" class="text-sm opacity-90">Are you sure you want to proceed?</p>
                </div>
            </div>
            <div class="confirm-footer">
                <button id="btn-confirm-no" class="btn h-auto px-6 py-2">Cancel</button>
                <button id="btn-confirm-yes" class="btn h-auto px-6 py-2">Confirm</button>
            </div>
        </div>
    </div>
    <div id="alert-lifecycle-tooltip" class="custom-tooltip" style="pointer-events: none; white-space: pre-line;"></div>
    <!-- Scripts at the end -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadDeviceMapFromServer(), loadPinMapFromServer()]);
            if (typeof applyRoomNames === 'function') applyRoomNames?.();
            if (typeof applyPinNames === 'function') applyPinNames?.();
            const exportModal = document.getElementById('modal-export');
            const exportRoomSelect = exportModal.querySelector('select[name="room"]');
            const exportSensorList = document.getElementById('export-sensor-list');
            const exportForm = document.getElementById('form-export');
            const CFG_REQUEST_TIMEOUT_MS = 3000;
            async function populateSensorCheckboxes(roomId) {
                if (!exportSensorList) return;
                if (!roomId || roomId === 'all') {
                    exportSensorList.innerHTML = '<span class="text-xs text-[var(--muted)] col-span-full text-center">Sensor selection is available for a single room.</span>';
                    return;
                }
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) {
                    exportSensorList.innerHTML = '<span class="text-xs text-[var(--muted)] col-span-full text-center">This room is not configured.</span>';
                    return;
                }
                const pinMap = window.MAC_PIN_NAMES?.[mac] || {};
                const sensorPins = ['25', '26', '32', '33'];
                exportSensorList.innerHTML = '';
                const createCheckbox = (value, text, isChecked = true, isBold = false) => {
                    const label = document.createElement('label');
                    label.className = `inline-flex items-center gap-2 text-sm ${isBold ? 'font-semibold' : ''}`;
                    label.innerHTML = `<input type="checkbox" name="sensors" value="${value}" class="form-checkbox" ${isChecked ? 'checked' : ''}> ${text}`;
                    return label;
                };
                const allLabel = createCheckbox('all', 'Select All', true, true);
                allLabel.querySelector('input').id = 'export-select-all-sensors';
                exportSensorList.appendChild(allLabel);
                exportSensorList.appendChild(createCheckbox('OVERALL', 'Overall Avg.', true));
                sensorPins.forEach(pin => {
                    const sensorName = pinMap[pin] || `Pin ${pin}`;
                    exportSensorList.appendChild(createCheckbox(pin, sensorName, true));
                });
                exportSensorList.querySelector('#export-select-all-sensors').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    exportSensorList.querySelectorAll('input[name="sensors"]').forEach(chk => {
                        chk.checked = isChecked;
                    });
                });
            }
            exportRoomSelect.addEventListener('change', () => {
                populateSensorCheckboxes(exportRoomSelect.value);
            });
            document.getElementById('qa-export')?.addEventListener('click', () => {
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                exportForm.from.value = toLocalDatetimeInputValue(start);
                exportForm.to.value = toLocalDatetimeInputValue(end);
                populateSensorCheckboxes(exportRoomSelect.value);
                openModal('modal-export');
            });
            exportForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fd = new FormData(exportForm);
                const room = fd.get('room');
                const type = fd.get('type').toLowerCase();
                const from = fd.get('from') ? new Date(fd.get('from')).toISOString() : null;
                const to = fd.get('to') ? new Date(fd.get('to')).toISOString() : null;
                const selectedSensors = Array.from(exportForm.querySelectorAll('input[name="sensors"]:checked')).map(cb => cb.value).join(',');
                const roomName = exportRoomSelect.options[exportRoomSelect.selectedIndex].text;
                if (!from || !to) {
                    showPopup('Please select a start and end date', { type: 'fail' });
                    return;
                }
                if (room !== 'all' && !selectedSensors) {
                    showPopup('Please select at least one sensor', { type: 'fail' });
                    return;
                }
                const confirmed = await showConfirmationModal(
                    `Confirm ${type.toUpperCase()} Export`,
                    `Generate a <strong>${type.toUpperCase()}</strong> report for <strong>${roomName}</strong>?`,
                    {
                        confirmText: `Yes, Export ${type.toUpperCase()}`,
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-file-arrow-down',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                const params = new URLSearchParams({
                    room: room,
                    type: type,
                    from: from,
                    to: to,
                    sensors: selectedSensors
                });
                window.open(`/api/export?${params.toString()}`);
                showPopup(`Generating your ${type.toUpperCase()} report...`, { type: 'success' });
                closeModal('modal-export');
            });
            uibuilder.start();
            initAllRoomsOffline();
            fetchAlertSummaryAndRender();
            fetch('/unseen_recoveries')
                .then(res => res.ok ? res.json() : Promise.reject('Failed to fetch'))
                .then(eventIds => {
                    console.log('DEBUG 1: Fetched Unseen Recovery IDs:', eventIds);
                    eventIds.forEach(id => unseenRecoveryIds.add(id));
                    updateRecoveryBadge();
                    console.log(`[RecoveryBell] Initialized with ${unseenRecoveryIds.size} unseen items.`);
                })
                .catch(err => console.error('[RecoveryBell] Failed to fetch unseen recoveries:', err));
            setInterval(fetchAlertSummaryAndRender, 5000);
            console.log('[System] 🚀 Starting initial config fetch for all online devices...');
            const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
            const fetchPromises = rooms.map(async (roomId) => {
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (mac) {
                    await fetchConfigWithRetry(roomId, mac);
                } else {
                    console.warn(`[System] ⚠️ Room ${roomId} has no MAC address mapped. Skipping config fetch.`);
                }
            });
            const htmlLegendPlugin = {
                id: 'htmlLegend',
                afterUpdate(chart, args, options) {
                    if (!options || options === true || !options.containerID) return;
                    const ul = getOrCreateLegendList(chart, options.containerID);
                    if (!ul) return;
                    while (ul.firstChild) ul.firstChild.remove();
                    const gen = chart.options?.plugins?.legend?.labels?.generateLabels;
                    const items = typeof gen === 'function' ? gen(chart) : [];
                    for (const item of items) {
                        const li = document.createElement('li');
                        li.classList.add('legend-item');
                        if (item.hidden) li.classList.add('hidden');
                        const boxSpan = document.createElement('span');
                        boxSpan.classList.add('legend-box');
                        boxSpan.style.background = item.strokeStyle || '#9aa6b2';
                        boxSpan.style.borderWidth = '0';
                        const textContainer = document.createElement('span');
                        if (item.fontColor) textContainer.style.color = item.fontColor;
                        if (item.hidden) textContainer.style.textDecoration = 'line-through';
                        textContainer.appendChild(document.createTextNode(item.text || ''));
                        li.appendChild(boxSpan);
                        li.appendChild(textContainer);
                        li.onclick = () => {
                            const { type } = chart.config;
                            if (type === 'pie' || type === 'doughnut') {
                                chart.toggleDataVisibility(item.index);
                            } else {
                                const di = item.datasetIndex ?? item.index ?? 0;
                                chart.setDatasetVisibility(di, !chart.isDatasetVisible(di));
                            }
                            chart.update();
                        };
                        ul.appendChild(li);
                    }
                }
            };
            const UptimeLabelPlugin = {
                id: 'uptimeLabel',
                afterDatasetsDraw(chart, args, opts) {
                    if (chart.hideUptimeLabel) { return; }
                    const meta = chart.getDatasetMeta(0);
                    const el = meta?.data?.[0];
                    if (!el) return;
                    const { y } = el.getProps(['y'], true);
                    const { right } = chart.chartArea;
                    const label = (opts?.text ?? '').toString();
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    ctx.font = 'bold 20px Inter, system-ui, sans-serif';
                    ctx.fillStyle = '#fff';
                    ctx.fillText(label, right - 8, y);
                    ctx.restore();
                }
            };
            const ThresholdPlugin = {
                id: 'thresholdPlugin',
                afterDatasetsDraw(chart, args, pluginOpts) {
                    const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                    const lines = pluginOpts?.lines || [];
                    ctx.save();
                    lines.forEach(l => {
                        if (typeof l.y !== 'number') return;
                        const py = y.getPixelForValue(l.y);
                        if (py < top || py > bottom) return;
                        ctx.beginPath();
                        if (Array.isArray(l.dash)) ctx.setLineDash(l.dash);
                        ctx.lineWidth = l.width || 1;
                        ctx.strokeStyle = l.color || 'rgba(255,255,255,0.3)';
                        ctx.moveTo(left, py);
                        ctx.lineTo(right, py);
                        ctx.stroke();
                        if (l.label) {
                            ctx.fillStyle = l.color || 'rgba(255,255,255,0.7)';
                            ctx.font = '10px sans-serif';
                            ctx.fillText(l.label, left + 6, py - 4);
                        }
                    });
                    ctx.restore();
                }
            };
            function fmtDate(t, locale = 'th-TH') {
                if (!t) return '-';
                try {
                    return new Date(t).toLocaleString(locale, {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false, timeZone: 'Asia/Bangkok'
                    }).replace(',', '');
                } catch (e) {
                    return 'Invalid Date';
                }
            }
            function buildLifecycleTooltipHTML(row, currentTab) {
                const opened = fmtDate(row.opened_at);
                const acked = fmtDate(row.ack_at);
                const closed = fmtDate(row.closed_at);
                const who = row.ack_by && row.ack_by !== 'system' ? row.ack_by : (row.ack_by ? row.ack_by : null);
                const note = row.ack_note && row.ack_note.trim() ? row.ack_note.trim() : null;
                const ackLine = (() => {
                    if (!acked || acked === '-') return `<strong>ACKed:</strong> -`;
                    if (who && note) return `<strong>ACKed:</strong> ${acked} (by ${who}, note: "${note}")`;
                    if (who && !note) return `<strong>ACKed:</strong> ${acked} (by ${who})`;
                    if (!who && note) return `<strong>ACKed:</strong> ${acked} (note: "${note}")`;
                    return `<strong>ACKed:</strong> ${acked}`;
                })();
                let lines = [`<div><strong>Opened:</strong> ${opened}</div>`];
                if (currentTab === 'ack' || currentTab === 'closed' || (currentTab.includes('open,ack') && row.status === 'ack')) {
                    lines.push(`<div>${ackLine}</div>`);
                }
                if (currentTab === 'closed') {
                    lines.push(`<div><strong>Closed:</strong> ${closed}</div>`);
                }
                return `<div class="custom-tooltip-body">${lines.join('')}</div>`;
            }
            function resolvePrimaryTime(row, currentTab) {
                if (currentTab === 'closed') return row.closed_at || row.opened_at;
                if (currentTab === 'ack') return row.ack_at || row.opened_at;
                if (row.status === 'ack') return row.ack_at || row.opened_at;
                return row.opened_at;
            }
            const getOrCreateLegendList = (chart, containerID) => {
                const container = document.getElementById(containerID);
                if (!container) return null;
                let listContainer = container.querySelector('ul');
                if (!listContainer) {
                    listContainer = document.createElement('ul');
                    listContainer.style.display = 'flex';
                    listContainer.style.flexDirection = 'row';
                    listContainer.style.margin = '0';
                    listContainer.style.padding = '0';
                    listContainer.style.gap = '0.75rem';
                    container.appendChild(listContainer);
                }
                return listContainer;
            };
            if (window.ChartZoom && Chart?.register) {
                Chart.register(window.ChartZoom);
            } else {
                console.warn('[Chart.js] chartjs-plugin-zoom not available');
            }
            async function refreshVisibleAlertViews() {
                console.log('[Real-time] Alert event occurred. Refreshing visible modals...');
                const detailModal = document.getElementById('modal-room-detail');
                if (detailModal && !detailModal.classList.contains('hidden')) {
                    const roomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                    if (roomId) {
                        console.log(`[Real-time] Refreshing Detail Modal for '${roomId}'...`);
                        const alerts = await fetchAlertsForRoom(roomId);
                        renderDetailAlerts(alerts, roomId);
                    }
                }
                const alertCenterModal = document.getElementById('modal-alert-center');
                if (alertCenterModal && !alertCenterModal.classList.contains('hidden')) {
                    console.log('[Real-time] Refreshing Alert Center...');
                    await loadAndCacheAlerts();
                }
            }
            Chart.register(ThresholdPlugin, htmlLegendPlugin, UptimeLabelPlugin);;
            const css = getComputedStyle(document.documentElement);
            Chart.defaults.color = '#ffffff';
            Chart.defaults.borderColor = 'rgba(255,255,255,.08)';
            Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
            window.DEVICE_MAP_DATA = {};
            window.ROOM_PIN_NAMES = {};
            window.pinStatuses = {};
            window.MAC_TO_ROOM_MAP = {};
            window.ROOM_TO_MAC_MAP = {};
            window._gotFirstMsg = false;
            window._detailCharts = { temp: null, rh: null };
            window.chartApiData = [];
            window.roomDataStore = {
                'room-a': { history: [], live: {} },
                'room-b': { history: [], live: {} },
                'room-c': { history: [], live: {} },
                'room-d': { history: [], live: {} },
            };
            document.querySelectorAll('.detail-card-title').forEach(el => {
                if (el.textContent && el.textContent.includes('Key Indicators')) {
                    el.textContent = '📊 System summary';
                }
            });
            function formatDuration(seconds) {
                if (seconds < 60) return `${Math.round(seconds)}s`;
                const d = Math.floor(seconds / 86400);
                const h = Math.floor((seconds % 86400) / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                let str = '';
                if (d > 0) str += `${d}d `;
                if (h > 0) str += `${h}h `;
                if (m > 0) str += `${m}m `;
                if (s > 0) str += `${s}s`;
                return str.trim();
            }
            function showConfirmationModal(title, message, options = {}) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-confirm');
                    const titleEl = document.getElementById('confirm-title');
                    const messageEl = document.getElementById('confirm-message');
                    const iconEl = document.getElementById('confirm-icon');
                    const confirmBtn = document.getElementById('btn-confirm-yes');
                    const cancelBtn = document.getElementById('btn-confirm-no');
                    titleEl.textContent = title;
                    messageEl.innerHTML = message;
                    confirmBtn.className = 'btn h-auto px-8 py-3';
                    iconEl.className = 'qa-icon text-2xl';
                    confirmBtn.textContent = options.confirmText || 'Confirm';
                    if (options.confirmClass) {
                        confirmBtn.classList.add(options.confirmClass);
                    }
                    if (options.iconClass) {
                        iconEl.innerHTML = `<i class="fa-solid ${options.iconClass}"></i>`;
                    } else {
                        iconEl.innerHTML = '<i class="fa-solid fa-circle-question"></i>';
                    }
                    if (options.iconColorClass) {
                        iconEl.classList.add(options.iconColorClass);
                    } else {
                        iconEl.classList.add('text-amber-400');
                    }
                    const cleanupAndResolve = (value) => {
                        modal.classList.add('hidden');
                        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                        modal.removeEventListener('click', overlayClickHandler);
                        resolve(value);
                    };
                    const confirmClickHandler = () => cleanupAndResolve(true);
                    const cancelClickHandler = () => cleanupAndResolve(false);
                    const overlayClickHandler = (e) => {
                        if (e.target === modal) {
                            cleanupAndResolve(false);
                        }
                    };
                    document.getElementById('btn-confirm-yes').addEventListener('click', confirmClickHandler);
                    document.getElementById('btn-confirm-no').addEventListener('click', cancelClickHandler);
                    modal.addEventListener('click', overlayClickHandler);
                    modal.classList.remove('hidden');
                });
            }
            function getOrCreateUptimeTooltip(canvasId) {
                let el = document.getElementById(`uptip-${canvasId}`);
                if (!el) {
                    el = document.createElement('div');
                    el.id = `uptip-${canvasId}`;
                    el.className = 'custom-tooltip';
                    document.body.appendChild(el);
                }
                return el;
            }
            function uptimeTooltipExternal(context, canvasId) {
                const tooltip = context.tooltip;
                const el = getOrCreateUptimeTooltip(canvasId);
                if (!tooltip || tooltip.opacity === 0) {
                    el.style.opacity = 0;
                    return;
                }
                const lines = (tooltip.dataPoints || []).map(dp => {
                    const [xs, xe] = dp.raw.x;
                    const start = new Date(xs);
                    const end = new Date(xe);
                    const durSec = (xe - xs) / 1000;
                    const status = dp.raw?.status || 'Unknown';
                    const displayStatus = status.charAt(0).toUpperCase() + status.slice(1);
                    const color = dp.raw?.c || '#999';
                    const options = {
                        year: 'numeric',
                        month: 'long',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Bangkok',
                    };
                    const fromDate = start.toLocaleString('en-GB', options).replace(',', ' at');
                    const toDate = end.toLocaleString('en-GB', options).replace(',', ' at');
                    return `
            <div class="tooltip-line">
                <span class="tooltip-color-box" style="background-color:${color}"></span>
                <span><strong>Status:</strong> ${displayStatus}</span>
            </div>
            <div>From: ${fromDate}</div>
            <div>To:   ${toDate}</div>
            <div>Duration: ${formatDuration(durSec)}</div>
        `;
                }).join('<hr style="margin:4px 0;border-color:rgba(255,255,255,0.2)">');
                el.innerHTML = `
        <div class="custom-tooltip-body" style="color:#fff">
            ${lines}
        </div>
    `;
                const rect = context.chart.canvas.getBoundingClientRect();
                el.style.left = `${rect.left + window.pageXOffset + tooltip.caretX}px`;
                el.style.top = `${rect.top + window.pageYOffset + tooltip.caretY}px`;
                el.style.opacity = 1;
            }
            async function fetchAndRenderUptimeChart(roomId, targetCanvasId, targetPctId) {
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) { console.warn(`[Uptime] No MAC for room ${roomId}`); return; }
                const canvas = document.getElementById(targetCanvasId);
                const pctEl = document.getElementById(targetPctId);
                if (!canvas || !pctEl) { console.error(`[Uptime] Canvas or Percentage element not found.`); return; }
                if (window._uptimeCharts && window._uptimeCharts[targetCanvasId]) {
                    window._uptimeCharts[targetCanvasId].destroy();
                    delete window._uptimeCharts[targetCanvasId];
                }
                if (!window._uptimeCharts) window._uptimeCharts = {};
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                const startMS = start.getTime();
                const endMS = end.getTime();
                const startISO = start.toISOString();
                const endISO = end.toISOString();
                const ROW_KEY = 'Status';
                const normStatus = (v) => {
                    const s = String(v ?? '').trim().toLowerCase();
                    if (['online', 'on', '1', 'true', 'up'].includes(s)) return 'online';
                    if (['offline', 'off', '0', 'false', 'down'].includes(s)) return 'offline';
                    return s || 'offline';
                };
                const clampRange = (s, e) => {
                    const ss = Math.max(startMS, s);
                    const ee = Math.min(endMS, e);
                    return ee > ss ? [ss, ee] : null;
                };
                try {
                    const res = await fetch(`/api/uptime-history?mac=${mac}&start=${startISO}&end=${endISO}`);
                    if (!res.ok) throw new Error(`Server returned ${res.status}`);
                    const data = await res.json();
                    const points = [];
                    if (!data.segments || data.segments.length === 0) {
                        const full = [startMS, endMS];
                        const isOnline = (data.uptime_pct ?? 0) > 0;
                        const color = isOnline ? '#22c55e' : '#ef4444';
                        const status = isOnline ? 'online' : 'offline';
                        points.push({ y: ROW_KEY, x: full, c: color, status: status });
                    } else {
                        for (const seg of data.segments) {
                            const s = new Date(seg.startTime).getTime();
                            const e = new Date(seg.endTime).getTime();
                            if (!isFinite(s) || !isFinite(e) || e <= s) continue;
                            const rng = clampRange(s, e);
                            if (!rng) continue;
                            const st = normStatus(seg.status);
                            const color = st === 'online' ? '#22c55e' : '#ef4444';
                            points.push({ y: ROW_KEY, x: rng, c: color, status: st });
                        }
                    }
                    points.sort((a, b) => a.x[0] - b.x[0]);
                    const ctx = canvas.getContext('2d');
                    window._uptimeCharts[targetCanvasId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            datasets: [{
                                label: 'Uptime',
                                data: points,
                                backgroundColor: (ctx) => ctx.raw?.c || '#999',
                                borderWidth: 0,
                                borderSkipped: false,
                                barPercentage: 1.0,
                                categoryPercentage: 1.0,
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                            plugins: {
                                htmlLegend: false,
                                legend: { display: false },
                                tooltip: {
                                    enabled: false,
                                    external: (ctx) => uptimeTooltipExternal(ctx, targetCanvasId)
                                },
                                zoom: {
                                    pan: { enabled: true, mode: 'x' },
                                    zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                                    limits: { x: { min: startMS, max: endMS, minRange: 5 * 60 * 1000 } }
                                },
                                uptimeLabel: { text: `${(data.uptime_pct ?? 0).toFixed(2)} %` }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    position: 'top',
                                    min: startMS,
                                    max: endMS,
                                    stacked: false,
                                    ticks: { display: false },
                                    grid: { display: false, drawBorder: false }
                                },
                                y: {
                                    stacked: false,
                                    ticks: { display: false },
                                    grid: { display: false, drawBorder: false }
                                }
                            }
                        }
                    });
                    const theChart = window._uptimeCharts[targetCanvasId];
                    if (theChart) {
                        theChart.canvas.addEventListener('mouseenter', () => {
                            theChart.hideUptimeLabel = true;
                            theChart.update('none');
                        });
                        theChart.canvas.addEventListener('mouseleave', () => {
                            theChart.hideUptimeLabel = false;
                            theChart.update('none');
                        });
                    }
                } catch (err) {
                    console.error(`[Uptime] Failed to fetch/render chart for ${roomId}:`, err);
                    pctEl.textContent = 'Error';
                }
            }
            const MAP_STORAGE_KEY = 'room_mac_map_v1';
            let currentCfgRoom = 'room-a';
            window._uptimeCharts = {};
            window._cfgReqs = window._cfgReqs || {};
            window._lastReqPerRoom = window._lastReqPerRoom || {};
            window._configPromises = {};
            window.liveAlertSettings = {};
            async function fetchConfigWithRetry(roomId, mac, retries = 5) {
                if (!mac) return;
                const requestId = uuid();
                uibuilder.send({
                    topic: `esp32/control/${mac}/request_config`,
                    payload: { command: "get_config", room: roomId, mac, requestId }
                });
                console.log(`[ConfigFetcher] Sent request ID: ${requestId} to MAC: ${mac} (Room: ${roomId})`);
                let handler;
                const timeoutPromise = new Promise((_, reject) =>
                    setTimeout(() => {
                        if (handler) {
                            uibuilder.onChange('msg', handler, false);
                        }
                        reject(new Error('timeout'));
                    }, CFG_REQUEST_TIMEOUT_MS)
                );
                const responsePromise = new Promise((resolve, reject) => {
                    handler = (msg) => {
                        try {
                            if (msg?.payload && msg.payload.requestId === requestId && msg.payload.mac_address === mac) {
                                uibuilder.onChange('msg', handler, false);
                                resolve(msg.payload);
                            }
                        } catch (e) {
                            console.error("Error inside uibuilder message handler:", e);
                            uibuilder.onChange('msg', handler, false);
                            reject(e);
                        }
                    };
                    uibuilder.onChange('msg', handler);
                });
                try {
                    const config = await Promise.race([responsePromise, timeoutPromise]);
                    if (config) {
                        console.log(`[ConfigFetcher] ✅ Config for ${roomId} received!`);
                        if (config.alerts) {
                            window.liveAlertSettings[roomId] = {
                                temp: { critLow: config.alerts.temp_crit_low, warnLow: config.alerts.temp_warn_low, warnHigh: config.alerts.temp_warn_high, critHigh: config.alerts.temp_crit_high },
                                hum: { critLow: config.alerts.hum_crit_low, warnLow: config.alerts.hum_warn_low, warnHigh: config.alerts.hum_warn_high, critHigh: config.alerts.hum_crit_high }
                            };
                        }
                    }
                } catch (error) {
                    console.warn(`[ConfigFetcher] 👎 No config for ${roomId}. ${retries} retries left. Reason: ${error.message}`);
                    if (retries > 0) {
                        setTimeout(() => fetchConfigWithRetry(roomId, mac, retries - 1), 5000);
                    } else {
                        console.error(`[ConfigFetcher] ❌ Failed to fetch config for ${roomId} after multiple retries.`);
                    }
                }
            }
            function canonicalRoomKey(k) {
                const m = String(k).match(/^room([ABCD])$/i);
                return m ? `room-${m[1].toLowerCase()}` : null;
            }
            function updateMainDashboardUI() {
                console.log('[UI Update] Refreshing main dashboard cards based on device map...');
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                const roomToMac = window.ROOM_TO_MAC_MAP || {};
                rooms.forEach(roomId => {
                    const card = document.querySelector(`.room-card[data-room="${roomId}"]`);
                    if (!card) return;
                    const hasMac = !!roomToMac[roomId];
                    if (hasMac) {
                        card.classList.remove('opacity-50', 'cursor-not-allowed');
                        card.style.pointerEvents = 'auto';
                    } else {
                        card.classList.add('opacity-50', 'cursor-not-allowed');
                        card.style.pointerEvents = 'none';
                        const statusDot = document.getElementById(`status-dot-${roomId}`);
                        if (statusDot) setLed(statusDot, 'led--red');
                        setRoomCardsBlank(roomId, true);
                    }
                });
            }
            function animateValue(element, start, end, duration, unit = '') {
                if (!element) return;
                if (start === end) {
                    element.textContent = `${end.toFixed(1)}${unit}`;
                    return;
                }
                const range = end - start;
                let startTime = null;
                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const currentVal = start + progress * range;
                    element.textContent = `${currentVal.toFixed(1)}${unit}`;
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                }
                window.requestAnimationFrame(step);
            }
            async function saveDeviceMapToServer(formData) {
                const dataToSave = {
                    roomA: normalizeMAC(formData.get('mac_room_a')),
                    nameA: formData.get('name_room_a')?.trim() || '',
                    roomB: normalizeMAC(formData.get('mac_room_b')),
                    nameB: formData.get('name_room_b')?.trim() || '',
                    roomC: normalizeMAC(formData.get('mac_room_c')),
                    nameC: formData.get('name_room_c')?.trim() || '',
                    roomD: normalizeMAC(formData.get('mac_room_d')),
                    nameD: formData.get('name_room_d')?.trim() || ''
                };
                const macs = Object.values(dataToSave).filter(v => typeof v === 'string' && v.includes(':'));
                const uniqueMacs = new Set(macs);
                if (macs.length !== uniqueMacs.size) {
                    showPopup('Conflicting MAC Address', { type: 'fail' });
                    return false;
                }
                try {
                    const response = await fetch('/api/device-map', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSave)
                    });
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.error || 'Unknown error');
                    window.DEVICE_MAP_DATA = dataToSave;
                    updateGlobalMappings(dataToSave);
                    applyRoomNames();
                    updateMainDashboardUI();
                    showPopup('Device Map saved successfully', { type: 'success' });
                    return true;
                } catch (error) {
                    console.error('[Device Map] Error saving to server:', error);
                    showPopup(`Failed to save Device Map: ${error.message}`, { type: 'fail' });
                    return false;
                }
            }
            function showPopup(message, opts = {}) {
                const type = opts.type || 'info';
                const timeout = (typeof opts.timeout === 'number') ? opts.timeout : 4000;
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                const icon = document.createElement('div');
                icon.className = 'toast-icon';
                icon.innerHTML = (type === 'success') ? '✅' : (type === 'warn') ? '⚠️' : (type === 'fail') ? '❌' : 'ℹ️';
                const msg = document.createElement('div');
                msg.className = 'qa-msg';
                msg.textContent = message;
                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.setAttribute('aria-label', 'Close');
                toast.appendChild(icon);
                toast.appendChild(msg);
                toast.appendChild(closeBtn);
                container.prepend(toast);
                const removeToast = () => {
                    toast.classList.add('toast-fade-out');
                    toast.addEventListener('animationend', () => {
                        if (toast.parentElement) {
                            toast.remove();
                            if (container && !container.hasChildNodes()) {
                                container.remove();
                            }
                        }
                    });
                };
                const timeoutId = setTimeout(removeToast, timeout);
                closeBtn.addEventListener('click', () => {
                    clearTimeout(timeoutId);
                    removeToast();
                });
            }
            async function loadPinMapFromServer() {
                try {
                    const res = await fetch('/api/pin-map', { cache: 'no-store' });
                    if (!res.ok) throw new Error('Failed to fetch pin map');
                    window.MAC_PIN_NAMES = await res.json();
                    console.log('[pin-map] loaded', window.MAC_PIN_NAMES);
                } catch (err) {
                    console.warn('Could not load pin names:', err);
                    window.MAC_PIN_NAMES = {};
                }
                applyPinNames?.();
            }
            function pinLabel(pin) {
                const roomEl = document.getElementById('detail-room-name');
                const roomId =
                    roomEl?.dataset?.currentRoom ||
                    window.currentRoomId ||
                    document.getElementById('cfg-room')?.value ||
                    'room-a';
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                const map = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                const v = map[pin];
                return (v && String(v).trim()) || `Pin ${pin}`;
            }
            function getPinLabel(pin) {
                const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                if (!currentRoomId) return `Pin ${pin}`;
                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                if (!mac) return `Pin ${pin}`;
                const map = window.MAC_PIN_NAMES?.[mac] || {};
                const v = map[pin];
                return (v && String(v).trim()) || `Pin ${pin}`;
            }
            function applyPinNames(roomId) {
                const currentRoomId = roomId || window.currentCfgRoom || document.getElementById('cfg-room')?.value || 'room-a';
                if (!window.ROOM_TO_MAC_MAP || !window.MAC_PIN_NAMES) return;
                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                const map = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                document.querySelectorAll('#series-toggle input[data-series]').forEach(input => {
                    const ds = input.dataset.series;
                    if (ds.startsWith('pin')) {
                        const pin = ds.replace('pin', '');
                        const name = map[pin] || `Pin ${pin}`;
                        const labelNode = input.parentNode.childNodes;
                        labelNode.forEach(node => {
                            if (node.nodeType === Node.TEXT_NODE) node.nodeValue = ` ${name}`;
                        });
                    }
                });
                updateSeriesSummary?.();
            }
            const seriesBtn = document.getElementById('series-dropdown-btn');
            const seriesPanel = document.getElementById('series-dropdown-panel');
            seriesBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                seriesPanel.classList.toggle('hidden');
            });
            function getLabelTextFrom(el) {
                const label = el.closest('label');
                if (!label) return '';
                return Array.from(label.childNodes)
                    .filter(n => n.nodeType === Node.TEXT_NODE)
                    .map(n => n.nodeValue.trim())
                    .join(' ')
                    .replace(/\s{2,}/g, ' ')
                    .trim();
            }
            function summarizeList(list, maxChars = 48) {
                const joined = list.join(', ');
                if (joined.length <= maxChars) return joined;
                let out = '', used = 0;
                for (const item of list) {
                    const next = out ? ', ' + item : item;
                    if ((out + next).length > maxChars) break;
                    out += next; used++;
                }
                const remain = list.length - used;
                return out + (remain > 0 ? ` +${remain} more` : '');
            }
            function updateSeriesSummary() {
                const btn = document.getElementById('series-dropdown-btn');
                if (!btn) return;
                const textSpan = btn.querySelector('span');
                const cbs = document.querySelectorAll('#series-toggle input[type="checkbox"][data-series]');
                const selectedLabels = [];
                cbs.forEach(cb => {
                    if (cb.checked) {
                        selectedLabels.push(getLabelTextFrom(cb));
                    }
                });
                const thresholdsOn = !!document.getElementById('toggle-thresholds')?.checked;
                let summary;
                if (selectedLabels.length === 0) {
                    summary = 'Select Series & Options';
                } else {
                    summary = `Selected (${selectedLabels.length}): ${summarizeList(selectedLabels, 44)}`;
                }
                if (thresholdsOn) summary += ' · Thresholds';
                textSpan.textContent = summary;
            }
            document.addEventListener('click', (e) => {
                if (!seriesBtn.contains(e.target) && !seriesPanel.contains(e.target)) {
                    seriesPanel.classList.add('hidden');
                }
            });
            document.querySelectorAll('#series-toggle input[type="checkbox"]').forEach(inp => {
                inp.addEventListener('change', updateSeriesSummary);
            });
            seriesBtn.addEventListener('click', () => {
                updateSeriesSummary();
            });
            updateSeriesSummary();
            function updateGlobalMappings(data) {
                window.DEVICE_MAP_DATA = data || {};
                const mac2room = {};
                const room2mac = {};
                const roomNames = {};
                for (const [k, v] of Object.entries(window.DEVICE_MAP_DATA)) {
                    const roomKey = canonicalRoomKey(k);
                    if (!roomKey) continue;
                    const mac = normalizeMAC(v);
                    if (mac) {
                        mac2room[mac] = roomKey;
                        room2mac[roomKey] = mac;
                    }
                }
                roomNames['room-a'] = data.nameA || 'Room A';
                roomNames['room-b'] = data.nameB || 'Room B';
                roomNames['room-c'] = data.nameC || 'Room C';
                roomNames['room-d'] = data.nameD || 'Room D';
                window.MAC_TO_ROOM_MAP = mac2room;
                window.ROOM_TO_MAC_MAP = room2mac;
                window.ROOM_NAMES = roomNames;
                console.log('[Device Map] mac->room', mac2room);
                console.log('[Device Map] room->mac', room2mac);
                console.log('[Device Map] room->name', roomNames);
            }
            async function loadDeviceMapFromServer() {
                const res = await fetch('/api/device-map', { cache: 'no-store' });
                if (!res.ok) throw new Error('fetch /api/device-map failed');
                updateGlobalMappings(await res.json());
                updateMainDashboardUI();
            }
            function getRoomToMacFromStorage() {
                return window.ROOM_TO_MAC_MAP || {};
            }
            async function fetchConfigFromDevice(roomId, timeoutMs = 10000) {
                if (typeof uibuilder === 'undefined') {
                    throw new Error('uibuilder is not available');
                }
                const roomToMac = getRoomToMacFromStorage();
                const mac = normalizeMAC(roomToMac?.[roomId] || '');
                if (!mac) {
                    throw new Error(`No MAC address mapped for ${roomId}`);
                }
                const requestId = uuid();
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        delete window._configPromises[requestId];
                        reject(new Error(`Config request for ${roomId} timed out after ${timeoutMs}ms`));
                    }, timeoutMs);
                    window._configPromises[requestId] = {
                        resolve: (data) => {
                            clearTimeout(timeoutId);
                            resolve(data);
                            delete window._configPromises[requestId];
                        },
                        reject: (err) => {
                            clearTimeout(timeoutId);
                            reject(err);
                            delete window._configPromises[requestId];
                        }
                    };
                    uibuilder.send({
                        topic: `esp32/control/${roomId}/request_config`,
                        payload: { command: "get_config", room: roomId, mac, requestId }
                    });
                    console.log(`[ConfigFetch] Sent config request for ${roomId} with ID: ${requestId}`);
                });
            }
            function clearSettingsFormFor(room, mac) {
                document.getElementById('cfg-mac').textContent = mac || '';
                const macLabel = document.getElementById('cfg-mac');
                if (macLabel) macLabel.textContent = mac || '';
                const ids = [
                    'ip', 'subnet', 'gateway', 'dns',
                    'mqtt-broker', 'mqtt-port', 'mqtt-user', 'mqtt-pass',
                    'temp-crit-low', 'temp-warn-low', 'temp-warn-high', 'temp-crit-high',
                    'hum-crit-low', 'hum-warn-low', 'hum-warn-high', 'hum-crit-high'
                ];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !(mac && mac !== '—');
            }
            function setLed(el, colorClass) {
                if (!el) return;
                el.classList.remove('led--green', 'led--red', 'led--gray');
                el.classList.add('led', colorClass);
            }
            async function showConfigPopup() {
                updateRoomSelectorStatus();
                const el = document.getElementById('modal-settings');
                if (!el) return;
                openModal('modal-settings');
                const sel = document.getElementById('cfg-room');
                if (sel) sel.value = currentCfgRoom;
                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');
                clearSettingsFormFor(currentCfgRoom, mac);
                lockSettingsForm();
                const dot = document.getElementById(`status-dot-${currentCfgRoom}`);
                const isOnline = dot && dot.classList.contains('led--green');
                btnEditSettings.disabled = !isOnline;
                if (isOnline) {
                    try {
                        await requestConfigFromDevice(currentCfgRoom);
                    } catch (err) {
                        console.warn('[Settings] requestConfigFromDevice failed:', err);
                        scheduleLocalFallback(currentCfgRoom);
                    }
                } else {
                    console.log(`[Settings] Room ${currentCfgRoom} is offline. Form will remain empty.`);
                }
            }
            function hideConfigPopup() {
                closeModal('modal-settings');
            }
            document.querySelectorAll('.room-card').forEach(card => {
                card.addEventListener('click', () => {
                    if (card.classList.contains('cursor-not-allowed') || card.style.pointerEvents === 'none') {
                        console.log(`[UI] Click on disabled room card '${card.dataset.room}' was blocked.`);
                        return;
                    }
                    const roomId = card.dataset.room;
                    if (roomId) openRoomDetailModal(roomId);
                });
            });
            document.getElementById('qa-settings')?.addEventListener('click', showConfigPopup);
            document.addEventListener('click', e => {
                if (e.target?.dataset?.close === 'modal-settings') hideConfigPopup();
            });
            document.querySelectorAll('.config-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    const name = btn.dataset.tab;
                    document.querySelectorAll('.config-tab').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.config-section').forEach(s => s.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + name)?.classList.add('active');
                });
            });
            document.getElementById('cfg-room')?.addEventListener('change', e => {
                currentCfgRoom = e.target.value;
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const mac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');
                clearSettingsFormFor(currentCfgRoom, mac);
                const dot = document.getElementById(`status-dot-${currentCfgRoom}`);
                const isOnline = dot && dot.classList.contains('led--green');
                const saveBtn = document.getElementById('btn-save-settings');
                if (isOnline) {
                    if (saveBtn) saveBtn.disabled = false;
                    (async () => {
                        try {
                            await requestConfigFromDevice(currentCfgRoom);
                        } catch (err) {
                            console.warn('[Settings] requestConfigFromDevice failed:', err);
                            scheduleLocalFallback(currentCfgRoom);
                        }
                    })();
                } else {
                    if (saveBtn) saveBtn.disabled = true;
                }
            });
            function updateRoomSelectorStatus() {
                const roomSelector = document.getElementById('cfg-room');
                if (!roomSelector) return;
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                let firstOnlineRoom = null;
                rooms.forEach(roomId => {
                    const option = roomSelector.querySelector(`option[value="${roomId}"]`);
                    const statusDot = document.getElementById(`status-dot-${roomId}`);
                    const isOnline = statusDot && statusDot.classList.contains('led--green');
                    console.log(roomId, { option, statusDot, isOnline });
                });
                const currentSelectedOption = roomSelector.querySelector(`option[value="${roomSelector.value}"]`);
                if (currentSelectedOption && currentSelectedOption.disabled && firstOnlineRoom) {
                    console.log(`[Settings] Current room '${roomSelector.value}' is offline. Switching to first available: '${firstOnlineRoom}'`);
                    roomSelector.value = firstOnlineRoom;
                    currentCfgRoom = firstOnlineRoom;
                    const roomToMac = Object.fromEntries(
                        Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                    );
                    const newMac = normalizeMAC(roomToMac?.[currentCfgRoom] || '');
                    clearSettingsFormFor(currentCfgRoom, newMac);
                    requestConfigFromDevice(currentCfgRoom);
                    scheduleLocalFallback(currentCfgRoom);
                }
            }
            async function loadAllConfigs(room) {
                const cfg = await fetchConfig(room);
                document.getElementById('ip').value = cfg.ethernet?.ip || '';
                document.getElementById('subnet').value = cfg.ethernet?.mask || '';
                document.getElementById('gateway').value = cfg.ethernet?.gw || '';
                document.getElementById('dns').value = cfg.ethernet?.dns || '';
                document.getElementById('mqtt-broker').value = cfg.mqtt?.broker || '';
                document.getElementById('mqtt-port').value = cfg.mqtt?.port || '';
                document.getElementById('mqtt-user').value = cfg.mqtt?.user || '';
                document.getElementById('mqtt-pass').value = cfg.mqtt?.pass || '';
                const a = cfg.alerts || getAlertDefaults();
                document.getElementById('temp-crit-low').value = a.temp.critLow;
                document.getElementById('temp-warn-low').value = a.temp.warnLow;
                document.getElementById('temp-warn-high').value = a.temp.warnHigh;
                document.getElementById('temp-crit-high').value = a.temp.critHigh;
                document.getElementById('hum-crit-low').value = a.hum.critLow;
                document.getElementById('hum-warn-low').value = a.hum.warnLow;
                document.getElementById('hum-warn-high').value = a.hum.warnHigh;
                document.getElementById('hum-crit-high').value = a.hum.critHigh;
            }
            function scheduleLocalFallback(room) {
                const lastId = (window._lastReqPerRoom || {})[room];
                setTimeout(async () => {
                    if (!lastId) return;
                    if ((window._lastReqPerRoom || {})[room] !== lastId) return;
                    const hasAnyValue = ['ip', 'subnet', 'gateway', 'dns', 'mqtt-broker', 'mqtt-port', 'mqtt-user', 'mqtt-pass']
                        .some(id => (document.getElementById(id)?.value || '').trim() !== '');
                    if (!hasAnyValue) {
                        console.warn(`[Settings] fallback: no response for ${room} after ${CFG_REQUEST_TIMEOUT_MS}ms — load local values`);
                        await (room);
                    }
                    delete window._cfgReqs[lastId];
                    window._lastReqPerRoom[room] = null;
                    const sel = document.getElementById('cfg-room');
                    if (sel) { sel.disabled = false; sel.classList.remove('opacity-60', 'cursor-not-allowed'); }
                }, CFG_REQUEST_TIMEOUT_MS + 300);
            }
            async function loadAllForRoom(room) {
                const dot = document.getElementById(`status-dot-${room}`);
                const isOnline = !!(dot && dot.classList.contains('led--green'));
                if (!isOnline) {
                    clearSettingsFormFor(room, '');
                    return;
                }
                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[room] || '');
                const macEl = document.getElementById('cfg-mac');
                if (macEl) macEl.textContent = mac || '—';
                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !mac;
                await loadAllConfigs(room);
            }
            document.getElementById('btn-save-settings')?.addEventListener('click', async () => {
                const room = currentCfgRoom;
                const roomName = window.ROOM_NAMES?.[room] || room;
                const confirmed = await showConfirmationModal(
                    'Confirm Save Settings',
                    `Are you sure you want to save and apply these settings to <strong>${roomName}</strong>?`,
                    {
                        confirmText: 'Save & Apply',
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-save',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                const saveBtn = document.getElementById('btn-save-settings');
                const cancelBtn = document.getElementById('btn-cancel-settings');
                if (saveBtn) saveBtn.disabled = true;
                if (cancelBtn) cancelBtn.disabled = true;
                const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                const mac = normalizeMAC(roomToMac?.[room] || '');
                if (!mac) {
                    showPopup(`No MAC assigned for Room ${room.toUpperCase()} (set it in Device Map)`, { type: 'fail' });
                    if (saveBtn) saveBtn.disabled = false;
                    if (cancelBtn) cancelBtn.disabled = false;
                    return;
                }
                const v1 = validateEthernet(room); if (!v1.ok) { showPopup(v1.msg); if (saveBtn) saveBtn.disabled = false; if (cancelBtn) cancelBtn.disabled = false; return; }
                const v2 = validateMqtt(); if (!v2.ok) { showPopup(v2.msg); if (saveBtn) saveBtn.disabled = false; if (cancelBtn) cancelBtn.disabled = false; return; }
                const v3 = validateAlerts(); if (!v3.ok) { showPopup(v3.msg); if (saveBtn) saveBtn.disabled = false; if (cancelBtn) cancelBtn.disabled = false; return; }
                const settings = collectAllSettings(room);
                const alertRules = [
                    { scope: "room", mac: mac, sensor_name: "overall", metric: "temp", active: 1, crit_min: settings.alerts.temp.critLow, warn_min: settings.alerts.temp.warnLow, warn_max: settings.alerts.temp.warnHigh, crit_max: settings.alerts.temp.critHigh },
                    { scope: "room", mac: mac, sensor_name: "overall", metric: "hum", active: 1, crit_min: settings.alerts.hum.critLow, warn_min: settings.alerts.hum.warnLow, warn_max: settings.alerts.hum.warnHigh, crit_max: settings.alerts.hum.critHigh }
                ];
                try {
                    const mqttPayload = { command: "set_config", room, mac, requestId: uuid(), settings };
                    uibuilder.send({ topic: `esp32/control/${mac}/set_config`, payload: mqttPayload });
                    const response = await fetch('/api/alert-rules', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(alertRules)
                    });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || "Failed to save rules to database.");
                    }
                    showPopup(`Configuration saved successfully!`, { type: 'success' });
                    closeModal('modal-settings');
                    lockSettingsForm();
                } catch (error) {
                    console.error("Failed to save settings:", error);
                    showPopup(`Failed to save configuration: ${error.message}`, { type: 'fail' });
                } finally {
                    if (!settingsModalPanel.classList.contains('settings-locked')) {
                        if (saveBtn) saveBtn.disabled = false;
                        if (cancelBtn) cancelBtn.disabled = false;
                    }
                }
            });
            function collectAllSettings(room) {
                const ethernet = {
                    ip: document.getElementById('ip').value.trim(),
                    subnet: document.getElementById('subnet').value.trim(),
                    gateway: document.getElementById('gateway').value.trim(),
                    dns: document.getElementById('dns').value.trim()
                };
                const mqtt = {
                    broker: document.getElementById('mqtt-broker').value.trim(),
                    port: document.getElementById('mqtt-port').value.trim(),
                    user: document.getElementById('mqtt-user').value.trim(),
                    pass: document.getElementById('mqtt-pass').value.trim()
                };
                const alerts = {
                    temp: {
                        critLow: parseFloat(document.getElementById('temp-crit-low').value) || null,
                        warnLow: parseFloat(document.getElementById('temp-warn-low').value) || null,
                        warnHigh: parseFloat(document.getElementById('temp-warn-high').value) || null,
                        critHigh: parseFloat(document.getElementById('temp-crit-high').value) || null,
                    },
                    hum: {
                        critLow: parseFloat(document.getElementById('hum-crit-low').value) || null,
                        warnLow: parseFloat(document.getElementById('hum-warn-low').value) || null,
                        warnHigh: parseFloat(document.getElementById('hum-warn-high').value) || null,
                        critHigh: parseFloat(document.getElementById('hum-crit-high').value) || null,
                    }
                };
                return { ethernet, mqtt, alerts, room };
            }
            async function requestConfigFromDevice(room) {
                const sel = document.getElementById('cfg-room');
                if (sel) { sel.disabled = true; sel.classList.add('opacity-60', 'cursor-not-allowed'); }
                try {
                    console.log(`[Settings] Requesting config for ${room} using the Promise-based fetcher.`);
                    const configData = await fetchConfigFromDevice(room);
                    const roomToMac = (typeof getRoomToMacFromStorage === 'function') ? getRoomToMacFromStorage() : {};
                    const mac = normalizeMAC(roomToMac?.[room] || '');
                    applyConfigFieldsToUI(configData, mac);
                } catch (error) {
                    console.warn(`[Settings] Could not fetch live config for ${room}. Error: ${error.message}`);
                    showPopup(`Unable to fetch data from ${room}. The device may be offline.`, { type: 'warn' });
                } finally {
                    if (sel) { sel.disabled = false; sel.classList.remove('opacity-60', 'cursor-not-allowed'); }
                }
            }
            function normalizeMAC(s) {
                if (!s) return '';
                const hex = String(s).toUpperCase().replace(/[^0-9A-F]/g, '');
                if (hex.length !== 12) return '';
                return hex.match(/.{2}/g).join(':');
            }
            async function fetchConfig(room) {
                const res = await fetch(`/api/config?roomId=${encodeURIComponent(room)}`);
                if (!res.ok) throw new Error('โหลด config ไม่ได้');
                return (await res.json()) || {};
            }
            async function persistConfig(room, config) {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId: room, config })
                });
                const data = await res.json();
                if (!data.ok) throw new Error('บันทึก config ไม่สำเร็จ');
            }
            function findMACInObject(obj) {
                const seen = new Set();
                const re = /([0-9A-F]{2}([-:])){5}[0-9A-F]{2}/i;
                function walk(v) {
                    if (v == null) return '';
                    if (typeof v === 'string') {
                        const m = v.match(re);
                        return m ? normalizeMAC(m[0]) : '';
                    }
                    if (typeof v === 'number' || typeof v === 'boolean') return '';
                    if (typeof v === 'object') {
                        if (seen.has(v)) return '';
                        seen.add(v);
                        const prefer = ['mac_address', 'mac', 'macAddr', 'device_mac', 'deviceMac', 'wifi_mac', 'eth_mac'];
                        for (const k of prefer) {
                            if (k in v) {
                                const got = walk(v[k]);
                                if (got) return got;
                            }
                        }
                        for (const key of Object.keys(v)) {
                            const got = walk(v[key]);
                            if (got) return got;
                        }
                    }
                    return '';
                }
                return walk(obj);
            }
            function applyRoomNames() {
                const names = window.ROOM_NAMES || {};
                for (const roomId in names) {
                    const name = names[roomId];
                    const cardHeader = document.querySelector(`.room-card[data-room="${roomId}"] h3`);
                    if (cardHeader) cardHeader.textContent = name;
                    const option = document.querySelector(`#cfg-room option[value="${roomId}"]`);
                    if (option) option.textContent = name;
                    const rebootOption = document.querySelector(`#modal-reboot select[name="target"] option[value="${roomId}"]`);
                    if (rebootOption) rebootOption.textContent = name;
                    const exportOption = document.querySelector(`#modal-export select[name="room"] option[value="${roomId}"]`);
                    if (exportOption) exportOption.textContent = name;
                }
            }
            console.table(window.MAC_TO_ROOM_MAP);
            window._roomTimeouts = {};
            const ROOM_TIMEOUT_MS = 80000;
            window.RoomStore = {
                'room-a': { selectedPin: 'OVERALL', sensors: {} },
                'room-b': { selectedPin: 'OVERALL', sensors: {} },
                'room-c': { selectedPin: 'OVERALL', sensors: {} },
                'room-d': { selectedPin: 'OVERALL', sensors: {} },
            };
            function loadMapForm() {
                const map = window.DEVICE_MAP_DATA;
                const form = document.getElementById('form-device-map');
                if (!form) return;
                form.mac_room_a.value = map.roomA || '';
                form.name_room_a.value = map.nameA || '';
                form.mac_room_b.value = map.roomB || '';
                form.name_room_b.value = map.nameB || '';
                form.mac_room_c.value = map.roomC || '';
                form.name_room_c.value = map.nameC || '';
                form.mac_room_d.value = map.roomD || '';
                form.name_room_d.value = map.nameD || '';
            }
            const getOrCreateTooltip = (chart) => {
                let tooltipEl = document.getElementById('custom-tooltip');
                if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'custom-tooltip';
                    tooltipEl.className = 'custom-tooltip';
                    document.body.appendChild(tooltipEl);
                }
                return tooltipEl;
            };
            const customTooltipHandler = (context) => {
                const tooltipEl = getOrCreateTooltip(context.chart);
                const tooltipModel = context.tooltip;
                if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                }
                const tempChart = window._detailCharts.temp;
                const rhChart = window._detailCharts.rh;
                if (!tooltipModel.dataPoints.length || !tempChart || !rhChart) {
                    return;
                }
                const timestamp = tooltipModel.dataPoints[0].parsed.x;
                const findDataForTimestamp = (chart, ts) => {
                    const points = [];
                    chart.data.datasets.forEach((dataset, i) => {
                        if (chart.isDatasetVisible(i)) {
                            const point = dataset.data.find(p => p.x === ts);
                            if (point) {
                                points.push({
                                    value: point.y,
                                    label: dataset.label,
                                    pinId: dataset.pinId,
                                    dataType: dataset.dataType,
                                    color: dataset.borderColor,
                                    unit: dataset.dataType === 'rh' ? '%' : '°C'
                                });
                            }
                        }
                    });
                    return points;
                };
                const tempPoints = findDataForTimestamp(tempChart, timestamp);
                const rhPoints = findDataForTimestamp(rhChart, timestamp);
                const combinedPoints = [...tempPoints, ...rhPoints];
                let innerHtml = '';
                if (combinedPoints.length > 0) {
                    const title = new Date(timestamp).toLocaleString('en-GB', {
                        year: 'numeric',
                        month: 'long',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'Asia/Bangkok',
                    }).replace(',', ' at');
                    innerHtml = `<div class="custom-tooltip-header">${title}</div>`;
                    innerHtml += '<div class="custom-tooltip-body">';
                    const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                    const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                    const pinMap = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                    const getDynamicPinLabel = (pin) => (pinMap[`${pin}`]?.trim()) || `Pin ${pin}`;
                    combinedPoints.forEach(point => {
                        let dynamicLabel;
                        if (point.dataType === 'dew') {
                            dynamicLabel = 'Dew Point(Overall)';
                        } else if (point.pinId === 'overall') {
                            dynamicLabel = `${point.dataType === 'temp' ? 'Temp' : 'Humi'} (Overall)`;
                        } else {
                            dynamicLabel = `${point.dataType === 'temp' ? 'Temp' : 'Humi'} ${getDynamicPinLabel(point.pinId)}`;
                        }
                        innerHtml += `
                    <div class="tooltip-line">
                        <span class="tooltip-color-box" style="background-color:${point.color}"></span>
                        <span>${dynamicLabel}: ${point.value.toFixed(1)} ${point.unit}</span>
                    </div>
                    `;
                    });
                    innerHtml += '</div>';
                }
                tooltipEl.innerHTML = innerHtml;
                const position = context.chart.canvas.getBoundingClientRect();
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
            };
            function isValidIP(ip) {
                const re = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
                return re.test(String(ip || '').trim());
            }
            function isValidHostname(h) {
                const re = /^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9-]*[A-Za-z0-9])$/;
                return re.test(String(h || '').trim());
            }
            function isValidPort(p) {
                const n = Number(p); return Number.isInteger(n) && n >= 1 && n <= 65535;
            }
            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
            }
            function isValidChatId(id) {
                return /^-?\d+$/.test(String(id || '').trim());
            }
            function parseBrokerHost(broker) {
                if (!broker) return '';
                const withProto = broker.startsWith('mqtt://') || broker.startsWith('ws://') || broker.startsWith('wss://')
                    ? broker : `mqtt://${broker}`;
                try { return new URL(withProto).hostname; } catch { return ''; }
            }
            function validateEthernet(room) {
                const ip = document.getElementById('ip').value.trim();
                const mask = document.getElementById('subnet').value.trim();
                const gw = document.getElementById('gateway').value.trim();
                const dns = document.getElementById('dns').value.trim();
                if (!isValidIP(ip)) return { ok: false, msg: '❌ IP Address ไม่ถูกต้อง' };
                if (!isValidIP(mask)) return { ok: false, msg: '❌ Subnet Mask ไม่ถูกต้อง' };
                if (!isValidIP(gw)) return { ok: false, msg: '❌ Gateway ไม่ถูกต้อง' };
                if (!isValidIP(dns)) return { ok: false, msg: '❌ DNS ไม่ถูกต้อง' };
                return { ok: true };
            }
            function validateMqtt() {
                const broker = document.getElementById('mqtt-broker').value.trim();
                const port = document.getElementById('mqtt-port').value.trim();
                if (!broker) return { ok: false, msg: '❌ Broker URL/Host ว่าง' };
                const host = parseBrokerHost(broker);
                if (!(isValidIP(host) || isValidHostname(host)))
                    return { ok: false, msg: '❌ Broker ต้องเป็น IP หรือ Hostname ที่ถูกต้อง (เช่น 192.168.1.10 หรือ my-broker.local)' };
                if (!isValidPort(port)) return { ok: false, msg: '❌ Port ต้องเป็นตัวเลข 1–65535' };
                return { ok: true };
            }
            function validateAlerts() {
                const t = {
                    cl: +document.getElementById('temp-crit-low').value,
                    wl: +document.getElementById('temp-warn-low').value,
                    wh: +document.getElementById('temp-warn-high').value,
                    ch: +document.getElementById('temp-crit-high').value
                };
                const h = {
                    cl: +document.getElementById('hum-crit-low').value,
                    wl: +document.getElementById('hum-warn-low').value,
                    wh: +document.getElementById('hum-warn-high').value,
                    ch: +document.getElementById('hum-crit-high').value
                };
                const asc = (o) => [o.cl, o.wl, o.wh, o.ch].every(v => !isNaN(v)) && o.cl < o.wl && o.wl < o.wh && o.wh < o.ch;
                if (!asc(t)) return { ok: false, msg: '❌ ช่วง Temperature ต้องเรียง: Crit Low < Warn Low < Warn High < Crit High' };
                if (!asc(h)) return { ok: false, msg: '❌ ช่วง Humidity ต้องเรียง: Crit Low < Warn Low < Warn High < Crit High' };
                return { ok: true };
            }
            function renderDetailAlerts(alerts, roomId) {
                const listEl = document.getElementById('detail-alert-list');
                if (!listEl) return;
                const modalEl = document.getElementById('modal-room-detail');
                const currentOpenRoom = document.getElementById('detail-room-name')?.dataset.currentRoom;
                if (modalEl.classList.contains('hidden') || currentOpenRoom !== roomId) {
                    console.warn(`[Render Guard] Dropping stale alert render for '${roomId}'. Current modal is for '${currentOpenRoom}'.`);
                    return;
                }
                const getConditionText = (alert) => {
                    const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                    if (!currentRoomId || !window.liveAlertSettings || !window.liveAlertSettings[currentRoomId]) {
                        return '';
                    }
                    const thresholds = window.liveAlertSettings[currentRoomId][alert.metric];
                    if (!thresholds || typeof alert.trigger_value !== 'number') {
                        return '';
                    }
                    if (alert.trigger_value > thresholds.warnHigh) {
                        return 'High';
                    }
                    if (alert.trigger_value < thresholds.warnLow) {
                        return 'Low';
                    }
                    return 'Threshold Event';
                };
                listEl.innerHTML = '';
                if (!alerts || alerts.length === 0) {
                    listEl.innerHTML = '<li class="text-center text-[var(--muted)] mt-4 w-full">No active alerts for this room</li>';
                    return;
                }
                const alertChipsHtml = alerts.map(alert => {
                    const levelClass = alert.level === 'critical' ? 'alert-chip-critical' : 'alert-chip-warning';
                    const icon = '<i class="fa-solid fa-triangle-exclamation icon"></i>';
                    const dateTimeText = new Date(alert.opened_at).toLocaleString('th-TH', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit',
                        hour12: false
                    }).replace(',', '');
                    const mac = window.ROOM_TO_MAC_MAP?.[roomId] || alert.mac;
                    const pinMap = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                    const sensorNameText = (String(alert.sensor_name).toLowerCase() === 'device_status' || String(alert.sensor_name).toLowerCase() === 'overall')
                        ? 'OVERALL'
                        : (pinMap[alert.sensor_name] || `${alert.sensor_name}`);
                    let ackButtonHtml = '';
                    if (alert.status === 'open') {
                        ackButtonHtml = `<button class="btn-ack-chip" data-event-id="${alert.event_id}">ACK</button>`;
                    }
                    const metricMap = {
                        temp: 'Temperature',
                        hum: 'Humidity',
                        connectivity: 'Device Status'
                    };
                    const displayMetric = metricMap[alert.metric] || alert.metric;
                    let fullMessage = '';
                    if (alert.message) {
                        fullMessage = `${dateTimeText} <strong>${alert.sensor_name}:</strong> ${alert.message}`;
                    } else {
                        const displayMetric = metricMap[alert.metric] || alert.metric;
                        if (alert.metric === 'connectivity' || alert.metric === 'sensor_connectivity') {
                            fullMessage = `${dateTimeText} <strong>${alert.sensor_name}:</strong> Offline`;
                        } else {
                            const conditionText = getConditionText(alert);
                            const valueText = Number(alert.trigger_value).toFixed(1);
                            const unit = alert.metric === 'temp' ? '°C' : '%';
                            fullMessage = `${dateTimeText} <strong>${alert.sensor_name}:</strong> ${displayMetric} ${conditionText} ${valueText}${unit}`;
                        }
                    }
                    return `
            <li data-event-id="${alert.event_id}">
                <div class="alert-chip ${levelClass}">
                    <div class="alert-chip-info" title="${fullMessage.replace(/<strong>|<\/strong>/g, '')}">
                        ${icon}
                        <span>${fullMessage}</span>
                    </div>
                    ${ackButtonHtml}
                </div>
            </li>
        `;
                }).join('');
                listEl.innerHTML = alertChipsHtml;
                const alertItems = listEl.querySelectorAll('li[data-event-id]');
                alertItems.forEach(item => {
                    const eventId = item.dataset.eventId;
                    const alertData = alerts.find(a => String(a.event_id) === eventId);
                    if (!alertData) return;
                    const currentTab = 'open,ack';
                    item.addEventListener('mouseenter', (e) => {
                        const tooltipEl = document.getElementById('alert-lifecycle-tooltip');
                        if (tooltipEl) {
                            tooltipEl.innerHTML = buildLifecycleTooltipHTML(alertData, currentTab);
                            tooltipEl.style.opacity = 1;
                        }
                    });
                    item.addEventListener('mousemove', (e) => {
                        const tooltipEl = document.getElementById('alert-lifecycle-tooltip');
                        if (tooltipEl) {
                            tooltipEl.style.left = `${e.pageX + 15}px`;
                            tooltipEl.style.top = `${e.pageY}px`;
                            tooltipEl.style.transform = 'translateY(-50%)';
                        }
                    });
                    item.addEventListener('mouseleave', () => {
                        const tooltipEl = document.getElementById('alert-lifecycle-tooltip');
                        if (tooltipEl) {
                            tooltipEl.style.opacity = 0;
                        }
                    });
                });
            }
            let originalSettings = {};
            const settingsModalPanel = document.querySelector('#modal-settings .config-panel');
            const settingsFormBody = document.querySelector('#modal-settings .config-body');
            const btnEditSettings = document.getElementById('btn-edit-settings');
            const btnCancelSettings = document.getElementById('btn-cancel-settings');
            const btnSaveSettings = document.getElementById('btn-save-settings');
            const alertLifecycleTooltip = document.getElementById('alert-lifecycle-tooltip');
            const qaAlertsButton = document.getElementById('qa-alerts');
            const alertCenterModalEl = document.getElementById('modal-alert-center');
            const alertTableBodyEl = document.getElementById('alert-table-body');
            const qaAlertCountEl = document.getElementById('qa-alert-count');
            const bulkAckButton = document.getElementById('btn-bulk-ack');
            const ackAllCheckbox = document.getElementById('ack-all-checkbox');
            const searchInput = document.getElementById('alert-filter-search');
            const levelSelect = document.getElementById('alert-filter-level');
            const statusSelect = document.getElementById('alert-filter-status');
            const startDateInput = document.getElementById('alert-filter-start-date');
            const endDateInput = document.getElementById('alert-filter-end-date');
            const applyButton = document.getElementById('alert-filter-apply');
            const resetButton = document.getElementById('alert-filter-reset');
            const drawerEl = document.getElementById('modal-sensor-rules');
            const ruleFormFields = document.getElementById('sensor-rule-form-fields');
            const overrideToggle = document.getElementById('toggle-override');
            const recoveryFab = document.getElementById('recovery-fab');
            const recoveryBadge = document.getElementById('recovery-badge');
            const unseenRecoveryIds = new Set();
            const newlySeenIds = new Set();
            let intersectionObserver;
            function setupIntersectionObserver() {
                if (intersectionObserver) {
                    intersectionObserver.disconnect();
                }
                newlySeenIds.clear();
                console.log('[Observer] Cleared newlySeenIds for new session.');
                const options = {
                    root: alertCenterModalEl.querySelector('.flex-grow.overflow-y-auto'),
                    rootMargin: '0px',
                    threshold: 0.5
                };
                const callback = (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const item = entry.target;
                            const eventId = item.dataset.eventId;
                            if (eventId && unseenRecoveryIds.has(eventId)) {
                                newlySeenIds.add(eventId);
                                console.log(`[Observer] Item ${eventId} is visible. Added to newlySeenIds set.`);
                                intersectionObserver.unobserve(item);
                            }
                        }
                    });
                };
                intersectionObserver = new IntersectionObserver(callback, options);
                const unseenItems = document.querySelectorAll('#alert-table-body tr.unseen-recovery');
                unseenItems.forEach(item => intersectionObserver.observe(item));
                console.log(`[Observer] Now observing ${unseenItems.length} unseen items.`);
            }
            function processNewlySeenRecoveries() {
                if (newlySeenIds.size === 0) {
                    console.log('[RecoveryBell] Modal closed, but no new items were seen.');
                    return;
                }
                console.log(`[RecoveryBell] Closing modal. Marking ${newlySeenIds.size} newly seen item(s) as read.`);
                newlySeenIds.forEach(eventId => {
                    uibuilder.send({ 'topic': 'mark_as_seen', 'payload': eventId });
                    unseenRecoveryIds.delete(eventId);
                });
                newlySeenIds.clear();
                updateRecoveryBadge();
            }
            function lockSettingsForm() {
                if (!settingsModalPanel) return;
                settingsModalPanel.classList.add('settings-locked');
                settingsFormBody.querySelectorAll('input, select').forEach(el => {
                    el.disabled = true;
                });
                btnEditSettings.classList.remove('hidden');
                btnCancelSettings.classList.add('hidden');
                btnSaveSettings.classList.add('hidden');
            }
            function updateRecoveryBadge() {
                const count = unseenRecoveryIds.size;
                const recoveryFab = document.getElementById('recovery-fab');
                const recoveryBadge = document.getElementById('recovery-badge');
                if (!recoveryFab || !recoveryBadge) {
                    console.error('[RecoveryBell] FAB or Badge element not found!');
                    return;
                }
                recoveryBadge.textContent = count;
                if (count > 0) {
                    recoveryBadge.classList.remove('hidden');
                    if (recoveryFab.classList.contains('hidden')) {
                        recoveryFab.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            recoveryFab.classList.add('fab-visible');
                        });
                    }
                } else {
                    recoveryBadge.classList.add('hidden');
                    recoveryFab.classList.remove('fab-visible');
                    const onTransitionEnd = () => {
                        if (unseenRecoveryIds.size === 0) {
                            recoveryFab.classList.add('hidden');
                        }
                        recoveryFab.removeEventListener('transitionend', onTransitionEnd);
                    };
                    recoveryFab.addEventListener('transitionend', onTransitionEnd);
                }
            }
            function unlockSettingsForm() {
                if (!settingsModalPanel) return;
                settingsModalPanel.classList.remove('settings-locked');
                settingsFormBody.querySelectorAll('input, select').forEach(el => {
                    if (el.id !== 'cfg-room') {
                        el.disabled = false;
                    }
                });
                btnEditSettings.classList.add('hidden');
                btnCancelSettings.classList.remove('hidden');
                btnSaveSettings.classList.remove('hidden');
            }
            function storeCurrentSettings() {
                originalSettings = {};
                settingsFormBody.querySelectorAll('input, select').forEach(el => {
                    if (el.id) {
                        originalSettings[el.id] = el.value;
                    }
                });
                console.log('[Lock System] Stored original settings:', originalSettings);
            }
            function restoreOriginalSettings() {
                console.log('[Lock System] Restoring original settings...');
                for (const [id, value] of Object.entries(originalSettings)) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = value;
                    }
                }
            }
            btnEditSettings?.addEventListener('click', () => {
                storeCurrentSettings();
                unlockSettingsForm();
            });
            btnCancelSettings?.addEventListener('click', () => {
                restoreOriginalSettings();
                lockSettingsForm();
            });
            function validateNotifications() {
                const badEmail = (notificationEmails || []).find(e => !isValidEmail(e));
                if (badEmail) return { ok: false, msg: `❌ Email ไม่ถูกต้อง: ${badEmail}` };
                const badChat = (telegramChatIds || []).find(id => !isValidChatId(id));
                if (badChat) return { ok: false, msg: `❌ Telegram Chat ID ไม่ถูกต้อง: ${badChat}` };
                return { ok: true };
            }
            function showQAStatus(text, opts = {}) {
                const type = opts.type || 'info';
                const timeout = opts.timeout || 4000;
                showPopup(text, { type, timeout });
            }
            function isNum(v) { return typeof v === 'number' && !isNaN(v); }
            function fmt1(v) { return isNum(v) ? v.toFixed(1) : '—'; }
            function getNumByKeys(obj, keys) {
                for (const k of keys) {
                    const v = obj?.[k];
                    if (isNum(v)) return v;
                }
                return NaN;
            }
            function setRoomCardsBlank(roomId, isBlank) {
                const tempValEl = document.getElementById(`temp-${roomId}`);
                const rhValEl = document.getElementById(`rh-${roomId}`);
                const tempCard = tempValEl?.closest('.metric-card');
                const rhCard = rhValEl?.closest('.metric-card');
                if (isBlank) {
                    if (tempCard) tempCard.classList.add('hidden');
                    if (rhCard) rhCard.classList.add('hidden');
                } else {
                    if (tempCard) tempCard.classList.remove('hidden');
                    if (rhCard) rhCard.classList.remove('hidden');
                }
            }
            function mergeIntoChart(chart, newLabels, newSeriesTuples) {
                if (!chart.data.datasets || chart.data.datasets.length === 0) {
                    chart.data.datasets = newSeriesTuples.map(([lbl, arr, style]) => ({
                        label: lbl,
                        data: [],
                        borderWidth: style?.borderWidth ?? 2,
                        tension: style?.tension ?? 0.35,
                        fill: style?.fill ?? false,
                        borderColor: style?.borderColor,
                        backgroundColor: style?.backgroundColor,
                        borderDash: style?.borderDash,
                    }));
                }
                const existing = chart.data.labels || [];
                const posMap = new Map(existing.map((l, i) => [l, i]));
                newLabels.forEach((lbl, i) => {
                    if (!posMap.has(lbl)) {
                        posMap.set(lbl, chart.data.labels.push(lbl) - 1);
                        chart.data.datasets.forEach((ds, dsIdx) => {
                            ds.data.push(newSeriesTuples[dsIdx][1][i] ?? null);
                        });
                    } else {
                        const idx = posMap.get(lbl);
                        chart.data.datasets.forEach((ds, dsIdx) => {
                            ds.data[idx] = newSeriesTuples[dsIdx][1][i] ?? ds.data[idx];
                        });
                    }
                });
                chart.update('none');
            }
            function applyConfigFieldsToUI(data, incomingMac) {
                const currentRoomId = document.getElementById('cfg-room').value;
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const expectedMac = normalizeMAC(roomToMac[currentRoomId] || '');
                if (incomingMac !== expectedMac) {
                    console.warn(`[Settings] Dropping stale config data. Expected MAC: ${expectedMac}, but got: ${incomingMac}`);
                    return;
                }
                if (data.ethernet) {
                    document.getElementById('ip').value = data.ethernet.eth_ip || data.ethernet.ip || '';
                    document.getElementById('subnet').value = data.ethernet.eth_subnet || data.ethernet.subnet || '';
                    document.getElementById('gateway').value = data.ethernet.eth_gateway || data.ethernet.gateway || '';
                    document.getElementById('dns').value = data.ethernet.eth_dns || data.ethernet.dns || '';
                }
                if (data.mqtt) {
                    document.getElementById('mqtt-broker').value = data.mqtt.broker || '';
                    document.getElementById('mqtt-port').value = data.mqtt.port || '';
                    document.getElementById('mqtt-user').value = data.mqtt.user || '';
                    document.getElementById('mqtt-pass').value = data.mqtt.password || data.mqtt.pass || '';
                }
                if (data.alerts) {
                    document.getElementById('temp-crit-low').value = data.alerts.temp_crit_low ?? '';
                    document.getElementById('temp-warn-low').value = data.alerts.temp_warn_low ?? '';
                    document.getElementById('temp-warn-high').value = data.alerts.temp_warn_high ?? '';
                    document.getElementById('temp-crit-high').value = data.alerts.temp_crit_high ?? '';
                    document.getElementById('hum-crit-low').value = data.alerts.hum_crit_low ?? '';
                    document.getElementById('hum-warn-low').value = data.alerts.hum_warn_low ?? '';
                    document.getElementById('hum-warn-high').value = data.alerts.hum_warn_high ?? '';
                    document.getElementById('hum-crit-high').value = data.alerts.hum_crit_high ?? '';
                }
                const macLabel = document.getElementById('cfg-mac');
                if (macLabel && incomingMac) macLabel.textContent = incomingMac;
                const btnCopy = document.getElementById('btn-copy-mac');
                if (btnCopy) btnCopy.disabled = !(incomingMac && incomingMac !== '--:--:--:--:--:--');
            }
            function initAllRoomsOffline() {
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                for (const roomId of rooms) {
                    const dot = document.getElementById(`status-dot-${roomId}`);
                    if (dot) {
                        setLed(dot, 'led--red');
                    }
                    const updatedEl = document.getElementById(`updated-${roomId}`);
                    if (updatedEl) updatedEl.textContent = '';
                    setRoomCardsBlank(roomId, true);
                    const chartId = `chart-${roomId}`;
                    const ch = window._roomCharts?.[chartId];
                    if (ch) {
                        ch.data.labels = [];
                        ch.data.datasets[0].data = [];
                        ch.update('none');
                    }
                }
            }
            function getSensorStyles(value, type, roomId) {
                const defaultThresholds = {
                    temp: { critHigh: 35, warnHigh: 30, warnLow: 20, critLow: 15 },
                    hum: { critHigh: 80, warnHigh: 70, warnLow: 40, critLow: 30 }
                };
                const roomConfig = window.liveAlertSettings?.[roomId];
                const cfg = (roomConfig && roomConfig[type]) ? roomConfig[type] : defaultThresholds[type];
                const normal = (type === 'temp') ? ['from-green-400', 'to-green-500'] : ['from-blue-400', 'to-blue-500'];
                const offline = ['from-slate-500', 'to-slate-600'];
                const warn = ['from-orange-400', 'to-orange-500'];
                const crit = ['from-red-500', 'to-red-600'];
                if (value === null || isNaN(value)) return { status: 'Offline', classes: offline };
                if ((cfg.critHigh !== null && value > cfg.critHigh) || (cfg.critLow !== null && value < cfg.critLow)) {
                    return { status: 'Critical', classes: crit };
                }
                if ((cfg.warnHigh !== null && value > cfg.warnHigh) || (cfg.warnLow !== null && value < cfg.warnLow)) {
                    return { status: 'Warning', classes: warn };
                }
                return { status: 'Normal', classes: normal };
            }
            function parseRoomIdFromTopic(topic) {
                if (!topic || typeof topic !== 'string') return null;
                const m = topic.toLowerCase().match(/(^|\/)(room-[abcd])(?=\/|$)/);
                return m ? m[2] : null;
            }
            function updateDeviceStatus(status, ms) {
                const statusText = document.getElementById('status-text');
                const pingTime = document.getElementById('ping-time');
                if (!statusText) return;
                if (status === 'online') {
                    statusText.textContent = '';
                    if (typeof ms === 'number') {
                        if (pingTime) {
                            pingTime.textContent = `(${ms} ms)`;
                            pingTime.classList.remove('hidden');
                        }
                    } else {
                        if (pingTime) pingTime.classList.add('hidden');
                    }
                } else {
                    statusText.textContent = '';
                    if (pingTime) pingTime.classList.add('hidden');
                }
            }
            function resetDetailModalUI(roomId) {
                console.log(`[UI Reset] Resetting detail modal for offline room: ${roomId}`);
                const modal = document.getElementById('modal-room-detail');
                if (!modal || modal.classList.contains('hidden') || modal.dataset.currentRoom !== roomId) {
                    return;
                }
                const statusLed = document.getElementById('detail-room-status-led');
                if (statusLed) setLed(statusLed, 'led--red');
                const kpiIds = [
                    'kpi-temp-min', 'kpi-temp-avg', 'kpi-temp-max',
                    'kpi-rh-min', 'kpi-rh-avg', 'kpi-rh-max', 'kpi-dew-avg'
                ];
                kpiIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '—';
                });
                const uptimePctEl = document.getElementById('detail-uptime-pct');
                if (uptimePctEl) uptimePctEl.textContent = '— %';
                const uptimeChart = window._uptimeCharts ? window._uptimeCharts['detail-uptime-chart-canvas'] : null;
                if (uptimeChart) {
                    uptimeChart.data.datasets[0].data = [];
                    uptimeChart.options.plugins.uptimeLabel.text = 'Offline';
                    uptimeChart.update('none');
                }
                const sensorList = document.getElementById('detail-sensor-list');
                if (sensorList) {
                    sensorList.innerHTML = '<li class="text-center text-[var(--muted)] mt-4">Device is offline</li>';
                }
                if (window._detailCharts) {
                    if (window._detailCharts.temp) {
                        window._detailCharts.temp.data.datasets = [];
                        window._detailCharts.temp.update('none');
                    }
                    if (window._detailCharts.rh) {
                        window._detailCharts.rh.data.datasets = [];
                        window._detailCharts.rh.update('none');
                    }
                }
                const btnIdsToDisable = ['detail-btn-reboot', 'detail-btn-settings', 'open-pin-map'];
                btnIdsToDisable.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
            }
            function resetRoomUI(roomId) {
                console.warn(`[Offline] No data for ${roomId} in ${ROOM_TIMEOUT_MS / 1000}s. Setting UI to offline.`);
                if (window.roomDataStore && window.roomDataStore[roomId]) {
                    window.roomDataStore[roomId].history = [];
                    window.roomDataStore[roomId].live = {};
                }
                const statusDot = document.getElementById(`status-dot-${roomId}`);
                if (statusDot) {
                    setLed(statusDot, 'led--red');
                }
                const updatedEl = document.getElementById(`updated-${roomId}`);
                if (updatedEl) {
                    updatedEl.textContent = '';
                }
                const tempCard = document.getElementById(`temp-${roomId}`)?.closest('.metric-card');
                const rhCard = document.getElementById(`rh-${roomId}`)?.closest('.metric-card');
                if (tempCard) {
                    const valueEl = tempCard.querySelector('.metric-value');
                    const statusEl = tempCard.querySelector('.metric-status');
                    if (valueEl) valueEl.textContent = '—';
                    if (statusEl) statusEl.textContent = 'Offline';
                    tempCard.className = 'metric-card rounded-xl shadow p-4 bg-gradient-to-r from-slate-500 to-slate-600 text-white text-center flex flex-col justify-center';
                }
                if (rhCard) {
                    const valueEl = rhCard.querySelector('.metric-value');
                    const statusEl = rhCard.querySelector('.metric-status');
                    if (valueEl) valueEl.textContent = '—';
                    if (statusEl) statusEl.textContent = 'Offline';
                    rhCard.className = 'metric-card rounded-xl shadow p-4 bg-gradient-to-r from-slate-500 to-slate-600 text-white text-center flex flex-col justify-center';
                }
                setRoomCardsBlank(roomId, true);
                console.log(`--- Starting Modal Offline Check for room: "${roomId}" ---`);
                const detailModal = document.getElementById('modal-room-detail');
                if (!detailModal) {
                    console.error("DEBUG: Cannot find the modal element with ID 'modal-room-detail'.");
                    return;
                }
                const isHidden = detailModal.classList.contains('hidden');
                const modalRoomId = detailModal.dataset.currentRoom;
                console.log(`DEBUG: Is modal hidden? ==> ${isHidden}`);
                console.log(`DEBUG: Modal is currently open for room: ==> "${modalRoomId}"`);
                console.log(`DEBUG: The offline event is for room: ==> "${roomId}"`);
                if (!isHidden && modalRoomId === roomId) {
                    console.log("%cSUCCESS: Conditions met. Calling resetDetailModalUI now.", "color: lightgreen; font-weight: bold;");
                    resetDetailModalUI(roomId);
                } else {
                    console.error("FAILURE: Conditions NOT met. The modal UI will not be updated.");
                    if (isHidden) {
                        console.error("Reason: Modal is considered hidden.");
                    }
                    if (modalRoomId !== roomId) {
                        console.error(`Reason: Mismatch in room IDs. Modal shows "${modalRoomId}", but event is for "${roomId}".`);
                    }
                }
                console.log("--- Finished Modal Offline Check ---");
            }
            function pushHistorySample(roomId, sample) {
                if (!window.roomDataStore) {
                    window.roomDataStore = {};
                }
                if (!window.roomDataStore[roomId]) {
                    window.roomDataStore[roomId] = {
                        name: sample.room_name || roomId,
                        history: [],
                        live: {}
                    };
                }
                const bucket = window.roomDataStore[roomId];
                const ts = sample.timestamp ? new Date(sample.timestamp).getTime() : Date.now();
                const temp = Number(sample.avg_temp);
                if (!Number.isFinite(temp) || !Number.isFinite(ts)) return;
                const h = bucket.history;
                if (h.length && h[h.length - 1].ts >= ts) return;
                h.push({ ts, temp_overall: temp });
                const cutoff = Date.now() - 5 * 60 * 1000;
                bucket.history = h.filter(x => x.ts >= cutoff);
            }
            function updateRoomUI(roomId, data) {
                const roomCardEl = document.querySelector(`.room-card[data-room="${roomId}"]`);
                if (roomCardEl) {
                    roomCardEl.classList.remove('hidden');
                }
                const roomTitleEl = document.querySelector(`.room-card[data-room="${roomId}"] h3`);
                if (roomTitleEl) {
                    roomTitleEl.classList.remove('hidden');
                }
                const statusDot = document.getElementById(`status-dot-${roomId}`);
                const updatedEl = document.getElementById(`updated-${roomId}`);
                const tempValEl = document.getElementById(`temp-${roomId}`);
                const rhValEl = document.getElementById(`rh-${roomId}`);
                const tempCard = tempValEl?.closest('.metric-card');
                const rhCard = rhValEl?.closest('.metric-card');
                const hasData =
                    (data.avg_temp != null && !isNaN(data.avg_temp)) ||
                    (data.avg_hum != null && !isNaN(data.avg_hum)) ||
                    (data.uptime_pct != null);
                if (data.status === 'offline' || !hasData) {
                    resetRoomUI(roomId);
                    return;
                }
                if (statusDot) {
                    setLed(statusDot, 'led--green');
                }
                checkAndFetchConfig(roomId);
                const hiddenMetricCards = roomCardEl.querySelectorAll('.metric-card.hidden');
                hiddenMetricCards.forEach(c => c.classList.remove('hidden'));
                if (data.timestamp != null && updatedEl) {
                    const d = new Date(data.timestamp);
                    updatedEl.textContent = d.toLocaleString('th-TH', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                }
                if (data.avg_temp != null && !isNaN(data.avg_temp) && tempValEl && tempCard) {
                    const tStyles = getSensorStyles(data.avg_temp, 'temp', roomId);
                    const startValue = parseFloat(tempValEl.textContent) || data.avg_temp;
                    const endValue = Number(data.avg_temp);
                    animateValue(tempValEl, startValue, endValue, 500, '°C');
                    const sEl = tempCard.querySelector('p.metric-status');
                    if (sEl) sEl.textContent = tStyles.status;
                    tempCard.className = 'metric-card rounded-xl shadow p-4 text-white text-center flex flex-col justify-center';
                    tempCard.classList.add('bg-gradient-to-r', ...tStyles.classes);
                    tempCard.classList.remove('flash-update');
                    void tempCard.offsetWidth;
                    tempCard.classList.add('flash-update');
                    setTimeout(() => tempCard.classList.remove('flash-update'), 700);
                }
                if (data.avg_hum != null && !isNaN(data.avg_hum) && rhValEl && rhCard) {
                    const hStyles = getSensorStyles(data.avg_hum, 'hum', roomId);
                    const startValue = parseFloat(rhValEl.textContent) || data.avg_hum;
                    const endValue = Number(data.avg_hum);
                    animateValue(rhValEl, startValue, endValue, 500, '%');
                    const sEl = rhCard.querySelector('p.metric-status');
                    if (sEl) sEl.textContent = hStyles.status;
                    rhCard.className = 'metric-card rounded-xl shadow p-4 text-white text-center flex flex-col justify-center';
                    rhCard.classList.add('bg-gradient-to-r', ...hStyles.classes);
                    rhCard.classList.remove('flash-update');
                    void rhCard.offsetWidth;
                    rhCard.classList.add('flash-update');
                    setTimeout(() => rhCard.classList.remove('flash-update'), 700);
                }
            }
            function resetAllRoomStatuses() {
                console.log('[SYSTEM] All room statuses have been reset due to a device map change.');
                const rooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                rooms.forEach(roomId => {
                    resetRoomUI(roomId);
                });
            }
            function getThresholdsForVisibleSeries(roomId, visibleSeries, metric) {
                const isThresholdsVisible = document.getElementById('toggle-thresholds')?.checked ?? true;
                if (!isThresholdsVisible || !roomId || !visibleSeries || visibleSeries.length === 0) {
                    return [];
                }
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac || !window.allEffectiveRules?.[mac]) {
                    return [];
                }
                const rulesForMac = window.allEffectiveRules[mac];
                let targetRule = null;
                if (visibleSeries.length > 1) {
                    targetRule = rulesForMac.room?.[metric];
                } else {
                    const singleSeries = visibleSeries[0];
                    if (singleSeries.pinId === 'overall' || singleSeries.dataType === 'dew') {
                        targetRule = rulesForMac.room?.[metric];
                    } else {
                        const sensorName = pinLabel(singleSeries.pinId);
                        targetRule = rulesForMac.sensors?.[sensorName]?.[metric] || rulesForMac.room?.[metric];
                    }
                }
                if (!targetRule) {
                    return [];
                }
                const formatLines = (rule) => {
                    return [
                        { y: rule.crit_max, color: '#ef4444', dash: [6, 3], label: `Crit High`, width: 2 },
                        { y: rule.warn_max, color: '#f59e0b', dash: [6, 3], label: `Warn High`, width: 1 },
                        { y: rule.warn_min, color: '#f59e0b', dash: [6, 3], label: `Warn Low`, width: 1 },
                        { y: rule.crit_min, color: '#ef4444', dash: [6, 3], label: `Crit Low`, width: 2 }
                    ].filter(line => typeof line.y === 'number' && !isNaN(line.y));
                };
                return formatLines(targetRule);
            }
            function feedChartsFromRows(rows, withAnimation = true) {
                if (!window._detailCharts?.temp || !window._detailCharts?.rh || !Array.isArray(rows)) {
                    return;
                }
                const show = (k) => document.querySelector(`#series-toggle input[data-series="${k}"]`)?.checked ?? true;
                const createSeries = (pin, field) => {
                    return rows
                        .filter(r => String(r.pin).toUpperCase() === String(pin).toUpperCase() && r.timestamp)
                        .map(r => ({
                            x: new Date(r.timestamp).getTime(),
                            y: (typeof r[field] === 'number' && isFinite(r[field])) ? r[field] : null
                        }))
                        .sort((a, b) => a.x - b.x);
                };
                const t_overall = createSeries('OVERALL', 'avg_temp');
                const t25 = createSeries('25', 'avg_temp');
                const t26 = createSeries('26', 'avg_temp');
                const t32 = createSeries('32', 'avg_temp');
                const t33 = createSeries('33', 'avg_temp');
                const dew = rows.filter(r => String(r.pin).toUpperCase() === 'OVERALL' && r.timestamp).map(r => ({ x: new Date(r.timestamp).getTime(), y: dewPointC_Magnus(r.avg_temp, r.avg_hum) })).sort((a, b) => a.x - b.x);
                const h_overall = createSeries('OVERALL', 'avg_hum');
                const h25 = createSeries('25', 'avg_hum');
                const h26 = createSeries('26', 'avg_hum');
                const h32 = createSeries('32', 'avg_hum');
                const h33 = createSeries('33', 'avg_hum');
                const currentRoomId = document.getElementById('detail-room-name')?.dataset.currentRoom;
                const mac = window.ROOM_TO_MAC_MAP?.[currentRoomId];
                const pinMap = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                const pinLabel = (pin) => (pinMap[`${pin}`]?.trim()) || `Pin ${pin}`;
                let tempDatasets = [];
                if (show('overall')) tempDatasets.push({ label: 'Temp (Overall)', data: t_overall, borderColor: 'rgba(239,68,68,1)', backgroundColor: 'rgba(239,68,68,0.2)', borderWidth: 3, fill: false, tension: 0.35, pinId: 'overall', dataType: 'temp' });
                if (show('pin25')) tempDatasets.push({ label: `Temp ${pinLabel('25')}`, data: t25, borderColor: 'rgba(252,165,165,0.9)', backgroundColor: 'rgba(252,165,165,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '25', dataType: 'temp' });
                if (show('pin26')) tempDatasets.push({ label: `Temp ${pinLabel('26')}`, data: t26, borderColor: 'rgba(251,146,60,0.9)', backgroundColor: 'rgba(251,146,60,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '26', dataType: 'temp' });
                if (show('pin32')) tempDatasets.push({ label: `Temp ${pinLabel('32')}`, data: t32, borderColor: 'rgba(250,204,21,0.9)', backgroundColor: 'rgba(250,204,21,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '32', dataType: 'temp' });
                if (show('pin33')) tempDatasets.push({ label: `Temp ${pinLabel('33')}`, data: t33, borderColor: 'rgba(147,51,234,0.9)', backgroundColor: 'rgba(147,51,234,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '33', dataType: 'temp' });
                if (show('dew')) tempDatasets.push({ label: 'Dew Point(Overall)', data: dew, borderColor: 'rgba(34,197,94,1)', backgroundColor: 'rgba(34,197,94,0.15)', borderWidth: 2, fill: false, tension: 0.35, pinId: 'overall', dataType: 'dew' });
                let rhDatasets = [];
                if (show('overall')) rhDatasets.push({ label: 'Humi (Overall)', data: h_overall, borderColor: 'rgba(59,130,246,1)', backgroundColor: 'rgba(59,130,246,0.2)', borderWidth: 3, fill: false, tension: 0.35, pinId: 'overall', dataType: 'rh' });
                if (show('pin25')) rhDatasets.push({ label: `Humi ${pinLabel('25')}`, data: h25, borderColor: 'rgba(191,219,254,0.95)', backgroundColor: 'rgba(191,219,254,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '25', dataType: 'rh' });
                if (show('pin26')) rhDatasets.push({ label: `Humi ${pinLabel('26')}`, data: h26, borderColor: 'rgba(147,197,253,0.95)', backgroundColor: 'rgba(147,197,253,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '26', dataType: 'rh' });
                if (show('pin32')) rhDatasets.push({ label: `Humi ${pinLabel('32')}`, data: h32, borderColor: 'rgba(96,165,250,0.95)', backgroundColor: 'rgba(96,165,250,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '32', dataType: 'rh' });
                if (show('pin33')) rhDatasets.push({ label: `Humi ${pinLabel('33')}`, data: h33, borderColor: 'rgba(59,130,246,0.85)', backgroundColor: 'rgba(59,130,246,0.08)', borderWidth: 1.6, fill: false, tension: 0.35, pinId: '33', dataType: 'rh' });
                let minTimestamp = Infinity;
                let maxTimestamp = -Infinity;
                const allPoints = rows.map(r => new Date(r.timestamp).getTime()).filter(t => !isNaN(t));
                if (allPoints.length > 0) {
                    minTimestamp = Math.min(...allPoints);
                    maxTimestamp = Math.max(...allPoints);
                }
                const tempChart = window._detailCharts.temp;
                const rhChart = window._detailCharts.rh;
                if (isFinite(minTimestamp) && isFinite(maxTimestamp)) {
                    tempChart.options.plugins.zoom.limits.x.min = minTimestamp;
                    tempChart.options.plugins.zoom.limits.x.max = maxTimestamp;
                    rhChart.options.plugins.zoom.limits.x.min = minTimestamp;
                    rhChart.options.plugins.zoom.limits.x.max = maxTimestamp;
                } else {
                    delete tempChart.options.plugins.zoom.limits.x.min;
                    delete tempChart.options.plugins.zoom.limits.x.max;
                    delete rhChart.options.plugins.zoom.limits.x.min;
                    delete rhChart.options.plugins.zoom.limits.x.max;
                }
                const visibleTempSeries = tempDatasets.map(ds => ({ pinId: ds.pinId, label: ds.label, dataType: ds.dataType }));
                const visibleRhSeries = rhDatasets.map(ds => ({ pinId: ds.pinId, label: ds.label, dataType: ds.dataType }));
                const tempThresholdLines = getThresholdsForVisibleSeries(currentRoomId, visibleTempSeries, 'temp');
                const rhThresholdLines = getThresholdsForVisibleSeries(currentRoomId, visibleRhSeries, 'hum');
                tempChart.data.datasets = tempDatasets;
                tempChart.options.plugins.thresholdPlugin = { lines: tempThresholdLines };
                rhChart.data.datasets = rhDatasets;
                rhChart.options.plugins.thresholdPlugin = { lines: rhThresholdLines };
                const animMode = withAnimation ? 'default' : 'none';
                tempChart.update(animMode);
                rhChart.update(animMode);
                tempChart.resetZoom('none');
                rhChart.resetZoom('none');
            }
            initAllRoomsOffline();
            initDetailToolbar();
            let notificationEmails = [];
            let telegramChatIds = [];
            let scheduleWeekdays = [true, true, true, true, true, true, true];
            let scheduleConfigs = [{ sendAt: "08:00", rangeStart: "17:00", rangeEnd: "08:00" }];
            const WEEKDAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            async function loadNotificationSettings() {
                try {
                    const res = await fetch('/api/notification-settings', { cache: 'no-store' });
                    if (!res.ok) throw new Error('Failed to fetch settings');
                    const data = await res.json();
                    notificationEmails = data.recipients?.email || [];
                    telegramChatIds = data.recipients?.telegram || [];
                    const schedule = data.schedule;
                    if (schedule && schedule.weekdays?.length === 7 && Array.isArray(schedule.configs) && schedule.configs.length > 0) {
                        scheduleWeekdays = schedule.weekdays;
                        scheduleConfigs = schedule.configs;
                    } else {
                        scheduleWeekdays = [true, true, true, true, true, true, true];
                        scheduleConfigs = [{ sendAt: "08:00", rangeStart: "17:00", rangeEnd: "08:00" }];
                    }
                } catch (err) {
                    console.warn('[Notifications] Could not load settings, using defaults:', err);
                    notificationEmails = [];
                    telegramChatIds = [];
                    scheduleWeekdays = [true, true, true, true, true, true, true];
                    scheduleConfigs = [{ sendAt: "08:00", rangeStart: "17:00", rangeEnd: "08:00" }];
                }
                renderAllSettingsUI();
            }
            async function saveNotificationSettings() {
                const confirmed = await showConfirmationModal(
                    'Confirm Notification Settings',
                    'Are you sure you want to save these recipient and schedule settings?',
                    {
                        confirmText: 'Confirm & Save',
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-paper-plane',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                const statusEl = document.getElementById('recipients-status');
                statusEl.textContent = 'Saving...';
                const payload = {
                    recipients: { email: notificationEmails, telegram: telegramChatIds },
                    schedule: { weekdays: scheduleWeekdays, configs: scheduleConfigs }
                };
                try {
                    const res = await fetch('/api/notification-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(errText || `Server error: ${res.status}`);
                    }
                    await res.json();
                    showPopup('Notification settings saved successfully!', { type: 'success' });
                    closeModal('modal-recipients');
                } catch (err) {
                    console.error('[Notifications] Save failed:', err);
                    showPopup(`Save failed: ${err.message}`, { type: 'fail' });
                } finally {
                    statusEl.textContent = '';
                }
            }
            function renderAllSettingsUI() {
                setupCustomDropdown('email', notificationEmails, (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val));
                setupCustomDropdown('telegram', telegramChatIds, (val) => /^-?\d+$/.test(val));
                renderScheduleDays();
                renderSchedules();
            }
            function setupCustomDropdown(type, itemsArray, validationFn) {
                const container = document.querySelector(`#${type}-dropdown-panel`).parentElement;
                const inputEl = document.getElementById(`recipient-input-${type}`);
                const panelEl = document.getElementById(`${type}-dropdown-panel`);
                const actionBtn = document.getElementById(`recipient-action-${type}`);
                const renderDropdown = () => {
                    panelEl.innerHTML = '';
                    itemsArray.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'dropdown-item';
                        itemEl.innerHTML = `<span class="truncate">${item}</span><button class="item-delete-btn" data-value="${item}">&times;</button>`;
                        panelEl.appendChild(itemEl);
                    });
                };
                inputEl.addEventListener('focus', () => {
                    renderDropdown();
                    panelEl.classList.remove('hidden');
                });
                actionBtn.addEventListener('click', () => {
                    const value = inputEl.value.trim();
                    if (value && validationFn(value)) {
                        if (!itemsArray.includes(value)) {
                            itemsArray.push(value);
                            inputEl.value = '';
                            renderDropdown();
                        } else {
                            showPopup('This item already exists.', { type: 'warn' });
                        }
                    } else if (value) {
                        showPopup('Invalid format.', { type: 'warn' });
                    }
                });
                panelEl.addEventListener('click', (e) => {
                    if (e.target.classList.contains('item-delete-btn')) {
                        const valueToDelete = e.target.dataset.value;
                        const index = itemsArray.indexOf(valueToDelete);
                        if (index > -1) {
                            itemsArray.splice(index, 1);
                            renderDropdown();
                        }
                    }
                });
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        panelEl.classList.add('hidden');
                    }
                }, true);
                renderDropdown();
            }
            function renderScheduleDays() {
                const container = document.getElementById('schedule-weekdays');
                if (!container) return;
                container.innerHTML = '';
                WEEKDAY_NAMES.forEach((name, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `weekday-btn ${scheduleWeekdays[index] ? 'active' : ''}`;
                    btn.textContent = name;
                    btn.dataset.dayIndex = index;
                    container.appendChild(btn);
                });
            }
            function renderSchedules() {
                const container = document.getElementById('schedule-list');
                if (!container) return;
                container.innerHTML = '';
                scheduleConfigs.forEach((config, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-[var(--panel-2)] rounded-lg border border-[var(--border)] space-y-2';
                    div.innerHTML = `
    <div class="flex items-center justify-between">
        <label class="font-medium text-sm text-slate-300">Schedule #${index + 1}</label>
        <button class="remove-item-btn text-lg p-1 leading-none" data-index="${index}" title="Remove schedule">&times;</button>
    </div>
    <div class="flex items-center gap-4">
        <label class="font-medium text-sm text-slate-300">Report Time:</label>
        <input type="time" value="${config.sendAt}" data-index="${index}" data-field="sendAt" 
               class="config-input schedule-input w-32 h-9 p-2 text-sm" 
               onclick="this.showPicker()">
    </div>
    <div class="flex items-center gap-5">
        <label class="font-medium text-sm text-slate-300">Data Range:</label>
        <div class="flex items-center gap-2">
            <input type="time" value="${config.rangeStart}" data-index="${index}" data-field="rangeStart" 
                   class="config-input schedule-input w-32 h-9 p-2 text-sm" 
                   onclick="this.showPicker()">
            <span>to</span>
            <input type="time" value="${config.rangeEnd}" data-index="${index}" data-field="rangeEnd" 
                   class="config-input schedule-input w-32 h-9 p-2 text-sm" 
                   onclick="this.showPicker()">
        </div>
    </div>
`;
                    container.appendChild(div);
                });
            }
            document.getElementById('qa-recipients')?.addEventListener('click', () => {
                loadNotificationSettings();
                openModal('modal-recipients');
            });
            document.getElementById('schedule-weekdays')?.addEventListener('click', (e) => {
                const btn = e.target.closest('.weekday-btn');
                if (!btn) return;
                const index = parseInt(btn.dataset.dayIndex, 10);
                scheduleWeekdays[index] = !scheduleWeekdays[index];
                btn.classList.toggle('active');
            });
            document.getElementById('schedule-add-btn')?.addEventListener('click', () => {
                scheduleConfigs.push({ sendAt: "17:00", rangeStart: "08:00", rangeEnd: "17:00" });
                renderSchedules();
            });
            document.getElementById('schedule-list')?.addEventListener('change', (e) => {
                if (e.target.classList.contains('schedule-input')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    const field = e.target.dataset.field;
                    if (scheduleConfigs[index]) {
                        scheduleConfigs[index][field] = e.target.value;
                    }
                }
            });
            document.getElementById('schedule-list')?.addEventListener('click', e => {
                const btn = e.target.closest('.remove-item-btn');
                if (!btn) return;
                const index = parseInt(btn.dataset.index, 10);
                scheduleConfigs.splice(index, 1);
                renderSchedules();
            });
            document.getElementById('btn-save-notification-settings')?.addEventListener('click', saveNotificationSettings);
            function dewPointC_Magnus(Tc, RHpct) {
                const T = Number(Tc), RH = Number(RHpct);
                if (!Number.isFinite(T) || !Number.isFinite(RH)) return null;
                const a = 17.62, b = 243.12;
                const gamma = (a * T) / (b + T) + Math.log(RH / 100);
                return (b * gamma) / (a - gamma);
            }
            function stats(arr) {
                const clean = arr.filter(v => typeof v === 'number' && !isNaN(v));
                if (!clean.length) return { min: NaN, avg: NaN, max: NaN };
                const sum = clean.reduce((a, b) => a + b, 0);
                return { min: Math.min(...clean), avg: sum / clean.length, max: Math.max(...clean) };
            }
            function updateKPIs(payload) {
                const online = (payload.devices_online != null) ? payload.devices_online : null;
                const total = (payload.devices_total != null) ? payload.devices_total : 4;
                const activeAlerts = (payload.active_alerts != null) ? payload.active_alerts : null;
                if (document.getElementById('kpi-devices-online') && online != null) {
                    document.getElementById('kpi-devices-online').textContent = `${online}/${total}`;
                }
                if (document.getElementById('kpi-active-alerts') && activeAlerts != null) {
                    document.getElementById('kpi-active-alerts').textContent = `${activeAlerts}`;
                }
                if (document.getElementById('kpi-avg-temp')) {
                    if (payload.avg_temp != null && !isNaN(payload.avg_temp)) {
                        document.getElementById('kpi-avg-temp').textContent = `${Number(payload.avg_temp).toFixed(1)}°C`;
                    } else {
                        document.getElementById('kpi-avg-temp').textContent = '—';
                    }
                }
                if (document.getElementById('kpi-avg-rh')) {
                    if (payload.avg_hum != null && !isNaN(payload.avg_hum)) {
                        document.getElementById('kpi-avg-rh').textContent = `${Number(payload.avg_hum).toFixed(1)}%`;
                    } else {
                        document.getElementById('kpi-avg-rh').textContent = '—';
                    }
                }
            }
            function updateAlertCards(payload) {
                let critCount = 0;
                let warnCount = 0;
                if (payload.critical_count !== undefined || payload.warning_count !== undefined) {
                    critCount = Number(payload.critical_count || 0);
                    warnCount = Number(payload.warning_count || 0);
                } else if (Array.isArray(payload.alerts)) {
                    const allActiveAlerts = payload.alerts;
                    critCount = allActiveAlerts.filter(a => a.level === 'critical' && (a.status === 'open' || a.status === 'ack')).length;
                    warnCount = allActiveAlerts.filter(a => a.level === 'warning' && (a.status === 'open' || a.status === 'ack')).length;
                }
                const critEl = document.getElementById('count-critical');
                const warnEl = document.getElementById('count-warning');
                if (critEl) critEl.textContent = String(critCount);
                if (warnEl) warnEl.textContent = String(warnCount);
                const activeAlertsEl = document.getElementById('kpi-active-alerts');
                if (activeAlertsEl) {
                    activeAlertsEl.textContent = String(critCount + warnCount);
                }
            }
            async function fetchAlertsForRoom(roomId) {
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) {
                    console.log(`[Alerts] No MAC address for room ${roomId}, returning empty array.`);
                    return [];
                }
                try {
                    const response = await fetch(`/api/alerts?mac=${mac}&status=open,ack`);
                    if (!response.ok) {
                        console.error(`[Alerts] API request for ${roomId} failed with status ${response.status}`);
                        return [];
                    }
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        return data;
                    } else if (data && Array.isArray(data.alerts)) {
                        return data.alerts;
                    } else {
                        console.warn(`[Alerts] API for ${roomId} did not return a valid array or {alerts: [...]}. Got:`, data);
                        return [];
                    }
                } catch (error) {
                    console.error(`[Alerts] Failed to fetch or parse alerts for ${roomId}:`, error);
                    return [];
                }
            }
            async function fetchAlertSummaryAndRender() {
                try {
                    const url = '/api/alerts/summary';
                    const res = await fetch(url, { cache: 'no-store' });
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    console.debug('[AlertSummary] data =', data);
                    updateAlertCards({
                        critical_count: Number(data.critical_count || 0),
                        warning_count: Number(data.warning_count || 0)
                    });
                } catch (err) {
                    console.error('[AlertSummary] fetch failed:', err);
                }
            }
            function uuid() {
                return (crypto?.randomUUID?.() || (Date.now().toString(16) + Math.random().toString(16).slice(2)));
            }
            function lockQA(text) {
                const btns = document.querySelectorAll('#qa-card button');
                btns.forEach(b => { b.disabled = true; b.classList.add('opacity-60', 'cursor-not-allowed'); });
                return () => {
                    btns.forEach(b => { b.disabled = false; b.classList.remove('opacity-60', 'cursor-not-allowed'); });
                };
            }
            function checkAndFetchConfig(roomId) {
                if (!roomId) return;
                const hasConfig = !!window.liveAlertSettings[roomId];
                if (!hasConfig) {
                    console.warn(`[Config] Config for room ${roomId} not found. Attempting to fetch...`);
                    fetchConfigWithRetry(roomId, window.ROOM_TO_MAC_MAP[roomId]);
                } else {
                    console.log(`[Config] Config for room ${roomId} already exists.`);
                }
            }
            function waitForAction(actionId, timeoutMs = 8000) {
                return new Promise((resolve) => {
                    let settled = false;
                    const tid = setTimeout(() => {
                        if (!settled) { settled = true; resolve({ ok: false, status: 'timeout', message: 'No response' }); }
                    }, timeoutMs);
                    const key = 'qa_' + actionId;
                    window._qaHandlers = window._qaHandlers || {};
                    window._qaHandlers[key] = (msg) => {
                        const data = msg?.payload || {};
                        if (data.actionId !== actionId) return;
                        if (settled) return;
                        settled = true;
                        clearTimeout(tid);
                        const ok = (data.status === 'ok' || data.status === 'accepted');
                        resolve({ ok, status: data.status, message: data.message });
                        delete window._qaHandlers[key];
                    };
                });
            }
            function _dispatchQA(msg) {
                const t = msg?.topic;
                const p = (typeof msg?.payload === 'string') ? JSON.parse(msg.payload) : (msg?.payload || {});
                const id =
                    p.actionId || p.reqId || p.requestId ||
                    msg.actionId || msg.reqId || msg.requestId;
                if (!id) return;
                const key = 'qa_' + id;
                const handler = window._qaHandlers?.[key];
                if (!handler) return;
                handler(msg);
            }
            async function fetchAndRenderRange() {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl?.dataset.currentRoom;
                if (!roomId) {
                    console.error("fetchAndRenderRange: ไม่สามารถหา roomId ได้");
                    return;
                }
                const roomToMac = Object.fromEntries(
                    Object.entries(window.MAC_TO_ROOM_MAP || {}).map(([mac, rid]) => [rid, mac])
                );
                const mac = roomToMac[roomId];
                if (!mac) {
                    showPopup(`MAC address for ${roomId} not found in Device Map`, { type: 'fail' });
                    console.error(`fetchAndRenderRange: ไม่มี MAC Address สำหรับห้อง ${roomId}`);
                    return;
                }
                const { fromISO, toISO } = getCurrentRangeISO();
                if (!fromISO || !toISO) {
                    console.error("fetchAndRenderRange: ไม่สามารถหาช่วงเวลาได้");
                    return;
                }
                try {
                    const res = await fetch(`/api/data?start=${fromISO}&end=${toISO}&mac=${mac}`);
                    if (!res.ok) {
                        throw new Error(`Server responded with status ${res.status}`);
                    }
                    const data = await res.json();
                    window.chartApiData = data;
                    if (data && data.length > 0) {
                        feedChartsFromRows(data, true);
                    } else {
                        window.chartApiData = [];
                        console.log(`ไม่มีข้อมูลสำหรับช่วงเวลานี้ของห้อง ${roomId}`);
                        feedChartsFromRows([], true);
                    }
                } catch (err) {
                    showPopup(`Failed to load chart data: ${err.message}`, { type: 'fail', timeout: 5000 });
                    console.error("Fetch data failed:", err);
                }
            }
            async function sendAction(cmd, payload = {}, roomName = '') {
                if (typeof uibuilder === 'undefined') {
                    console.warn('uibuilder is undefined');
                    return false;
                }
                const actionId = uuid();
                const unlock = lockQA(`Sending command ${cmd}...`);
                try {
                    uibuilder.send({
                        topic: `actions/${cmd}`,
                        payload: {
                            cmd,
                            actionId,
                            ...payload,
                            meta: { by: 'web', ts: Date.now(), ver: 1 }
                        }
                    });
                    const res = await waitForAction(actionId, 60000);
                    const target = roomName ? `${roomName}` : '';
                    if (res?.ok) {
                        showPopup(`${cmd} ${target} succeeded.`, { type: 'success' });
                        return true;
                    } else {
                        const reason = res?.message || res?.status || 'unknown error';
                        showPopup(`${cmd} ${target} failed: ${reason}`, { type: 'fail' });
                        return false;
                    }
                } catch (err) {
                    const target = roomName ? ` for ${roomName}` : '';
                    showPopup(`${cmd} ${target} failed: ${err?.message || err}`, { type: 'fail' });
                    return false;
                } finally {
                    unlock();
                }
            }
            function getCommonChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false, labels: { color: '#fff' } },
                        tooltip: { enabled: false, external: customTooltipHandler, mode: 'index', intersect: false, titleColor: '#fff', bodyColor: '#fff' },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,.05)' },
                            ticks: { color: '#fff' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,.10)' },
                            ticks: { color: '#fff' }
                        }
                    },
                    elements: { point: { radius: 1 } }
                };
            }
            function updateAllDetailUI(roomData) {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl.dataset.currentRoom;
                const statusLed = document.getElementById('detail-room-status-led');
                const mainStatusDot = document.getElementById(`status-dot-${roomId}`);
                const statusClass = mainStatusDot ? Array.from(mainStatusDot.classList).find(c => c.startsWith('led--')) : 'led--red';
                if (statusLed && statusClass) {
                    setLed(statusLed, statusClass);
                }
                if (statusClass === 'led--green') {
                    const btnIdsToEnable = ['detail-btn-reboot', 'detail-btn-settings', 'open-pin-map'];
                    btnIdsToEnable.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.disabled = false;
                    });
                }
                updateDetailKPIs(roomData.history);
                updateSensorList(roomData.live, roomId);
            }
            function updateDetailKPIs(history) {
                const set = (id, val, unit = '') => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const startValue = parseFloat(el.textContent) || val || 0;
                    const endValue = isNaN(val) ? startValue : Number(val);
                    if (isNaN(val)) {
                        el.textContent = '—';
                    } else {
                        animateValue(el, startValue, endValue, 500, unit);
                    }
                };
                if (!history || history.length === 0) {
                    ['kpi-temp-min', 'kpi-temp-avg', 'kpi-temp-max',
                        'kpi-rh-min', 'kpi-rh-avg', 'kpi-rh-max', 'kpi-dew-avg'
                    ].forEach(id => set(id, NaN));
                    return;
                }
                const latest = history[history.length - 1];
                const hasPayloadMinMax =
                    [latest.min_temp, latest.max_temp, latest.min_hum, latest.max_hum]
                        .every(v => typeof v === 'number' && !isNaN(v));
                if (hasPayloadMinMax) {
                    set('kpi-temp-min', latest.min_temp);
                    set('kpi-temp-avg', latest.temp_overall);
                    set('kpi-temp-max', latest.max_temp);
                    set('kpi-rh-min', latest.min_hum);
                    set('kpi-rh-avg', latest.rh_overall);
                    set('kpi-rh-max', latest.max_hum);
                    set('kpi-dew-avg', dewPointC_Magnus(latest.temp_overall, latest.rh_overall));
                    return;
                }
                const nums = a => a.filter(v => typeof v === 'number' && !isNaN(v));
                const T = nums(history.map(h => h.temp_overall));
                const H = nums(history.map(h => h.rh_overall));
                const D = nums(history.map(h => dewPointC_Magnus(h.temp_overall, h.rh_overall)));
                const stat = arr => arr.length ? ({ min: Math.min(...arr), avg: arr.reduce((s, v) => s + v, 0) / arr.length, max: Math.max(...arr) }) : { min: NaN, avg: NaN, max: NaN };
                const t = stat(T), h = stat(H), d = stat(D);
                set('kpi-temp-min', t.min); set('kpi-temp-avg', t.avg); set('kpi-temp-max', t.max);
                set('kpi-rh-min', h.min); set('kpi-rh-avg', h.avg); set('kpi-rh-max', h.max);
                set('kpi-dew-avg', d.avg);
            }
            function updateSensorList(liveData, roomId) {
                const listEl = document.getElementById('detail-sensor-list');
                if (!listEl) return;
                if (!liveData || Object.keys(liveData).length === 0) {
                    if (!listEl.hasChildNodes() || listEl.querySelector('li')?.textContent.includes('Waiting')) {
                        listEl.innerHTML = '<li class="text-center text-[var(--muted)] mt-4">Waiting for live data...</li>';
                    }
                    return;
                }
                roomId = roomId || document.getElementById('detail-room-name')?.dataset?.currentRoom || null;
                listEl.innerHTML = '';
                const pins = ['25', '26', '32', '33'];
                const isNum = v => typeof v === 'number' && Number.isFinite(v);
                const fmt1 = v => isNum(v) ? v.toFixed(1) : '—';
                const get = (o, keys) => { for (const k of keys) { const v = o?.[k]; if (isNum(v)) return v; } return NaN; };
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) {
                    console.error("Cannot find MAC for room:", roomId);
                    return;
                }
                const pinNames = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                pins.forEach(pin => {
                    const pkt = liveData[pin] || {};
                    const isOffline = !pkt.timestamp;
                    const tmin = get(pkt, ['min_temp', 'tmin']);
                    const tavg = get(pkt, ['avg_temp', 'tavg', 'temp']);
                    const tmax = get(pkt, ['max_temp', 'tmax']);
                    const hmin = get(pkt, ['min_hum', 'hmin', 'min_rh']);
                    const havg = get(pkt, ['avg_hum', 'havg', 'rh']);
                    const hmax = get(pkt, ['max_hum', 'hmax', 'max_rh']);
                    const customName = pinNames[pin] || `Pin ${pin}`;
                    const li = document.createElement('li');
                    li.className = 'live-row text-sm p-3 py-2 bg-[var(--panel)] rounded-md border border-[var(--border)] clickable-sensor-row flash-update-row';
                    setTimeout(() => li.classList.remove('flash-update-row'), 800);
                    li.dataset.mac = mac;
                    li.dataset.sensor = customName;
                    li.innerHTML = `
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span class="led ${isOffline ? 'led--red' : 'led--green'}"></span>
                    <span class="text-[var(--muted)] font-medium">${customName}</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-right live-values">
                <div class="flex items-center justify-end gap-2">
                    <span class="badge-chip badge-temp text-xs">Temperature</span>
                    <span class="font-bold text-base">
                        <span class="text-sky-400">${isOffline ? '—' : fmt1(tmin)}</span>
                        <span class="live-sep">/</span>
                        <span>${isOffline ? '—' : fmt1(tavg)}</span>
                        <span class="live-sep">/</span>
                        <span class="text-red-400">${isOffline ? '—' : fmt1(tmax)}</span>
                    </span>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <span class="badge-chip badge-hum text-xs">Humidity</span>
                    <span class="font-bold text-base">
                        <span class="text-sky-400">${isOffline ? '—' : fmt1(hmin)}</span>
                        <span class="live-sep">/</span>
                        <span>${isOffline ? '—' : fmt1(havg)}</span>
                        <span class="live-sep">/</span>
                        <span class="text-red-400">${isOffline ? '—' : fmt1(hmax)}</span>
                    </span>
                </div>
            </div>
        `;
                    listEl.appendChild(li);
                });
            }
            function openModal(id) {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.add('modal-is-entering');
                el.classList.remove('hidden');
                if (el.classList.contains('config-overlay')) el.classList.add('active');
                const centerIds = new Set(['modal-reboot', 'modal-export', 'modal-device-map', 'modal-settings', 'modal-room-detail', 'modal-pin-map', 'modal-recipients', 'modal-sensor-rules', 'modal-alert-center', 'modal-ack', 'modal-confirm', 'modal-summary-detail']);
                if (centerIds.has(id)) el.classList.add('centered');
                requestAnimationFrame(() => {
                    el.classList.remove('modal-is-entering');
                });
            }
            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (!el || el.classList.contains('hidden')) return;
                if (id === 'modal-settings') {
                    lockSettingsForm();
                }
                if (id === 'modal-alert-center') {
                    processNewlySeenRecoveries();
                }
                el.classList.add('modal-is-exiting');
                setTimeout(() => {
                    el.classList.add('hidden');
                    el.classList.remove('active', 'centered', 'modal-is-exiting');
                }, 50);
                if (document.activeElement?.blur) document.activeElement.blur();
            }
            async function openRoomDetailModal(roomId) {
                const modalEl = document.getElementById('modal-room-detail');
                if (!modalEl) return;
                openModal('modal-room-detail');
                modalEl.dataset.currentRoom = roomId;
                const roomToMacMap = {};
                Object.entries(window.MAC_TO_ROOM_MAP || {}).forEach(([mac, rId]) => {
                    roomToMacMap[rId] = mac;
                });
                const mac = roomToMacMap[roomId];
                if (mac) {
                    await fetchAllEffectiveRules(mac);
                }
                const defaultName = roomId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                const finalName = window.ROOM_NAMES?.[roomId] || defaultName;
                if (window._detailCharts.temp) {
                    window._detailCharts.temp.destroy();
                    window._detailCharts.temp = null;
                }
                if (window._detailCharts.rh) {
                    window._detailCharts.rh.destroy();
                    window._detailCharts.rh = null;
                }
                renderDetailAlerts([]);
                if (!window._detailCharts.temp || !window._detailCharts.rh) {
                    console.log('[ChartJS] Initializing detail charts for the first time...');
                    const tempCtx = document.getElementById('detail-chart-temp')?.getContext('2d');
                    const rhCtx = document.getElementById('detail-chart-rh')?.getContext('2d');
                    if (!tempCtx || !rhCtx) {
                        console.error("Critical Error: Could not find canvas contexts for detail charts.");
                        showPopup("Error: Cannot initialize charts.", { type: 'fail' });
                        return;
                    }
                    const createTimeScaleOptions = (chartType, containerId) => ({
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    tooltipFormat: 'dd MMM yyyy, HH:mm',
                                    displayFormats: { hour: 'HH:mm', day: 'dd MMM' }
                                },
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.06)' }
                            },
                            y: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255,255,255,0.12)' }
                            }
                        },
                        plugins: {
                            htmlLegend: {
                                containerID: containerId
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false,
                                mode: 'index',
                                intersect: false,
                                external: customTooltipHandler,
                                usePointStyle: true,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            const unit = context.chart.canvas.id.includes('rh') ? '%' : '°C';
                                            label += `${context.parsed.y.toFixed(1)} ${unit}`;
                                        }
                                        return label;
                                    },
                                    labelPointStyle: function (context) {
                                        return {
                                            pointStyle: 'rect',
                                            rotation: 0
                                        };
                                    }
                                }
                            },
                            zoom: {
                                pan: { enabled: true, mode: 'x' },
                                zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                                limits: { x: {} }
                            }
                        },
                        interaction: { intersect: false, mode: 'index' },
                        elements: { point: { radius: 0 } }
                    });
                    const tempOptions = createTimeScaleOptions('temp', 'legend-container-temp');
                    const rhOptions = createTimeScaleOptions('rh', 'legend-container-rh');
                    tempOptions.scales.y.min = 0;
                    tempOptions.scales.y.max = 40;
                    window._detailCharts.temp = new Chart(tempCtx, {
                        type: 'line',
                        data: { datasets: [] },
                        options: tempOptions
                    });
                    rhOptions.scales.y.min = 0;
                    rhOptions.scales.y.max = 100;
                    window._detailCharts.rh = new Chart(rhCtx, {
                        type: 'line',
                        data: { datasets: [] },
                        options: rhOptions
                    });
                }
                console.log(`Clearing charts before loading new room: ${roomId}`);
                updateDetailKPIs([]);
                const sensorList = document.getElementById('detail-sensor-list');
                if (sensorList) sensorList.innerHTML = '<li class="text-center text-[var(--muted)] mt-4">Loading data...</li>';
                const detailRoomNameEl = document.getElementById('detail-room-name');
                detailRoomNameEl.textContent = `${finalName}`;
                detailRoomNameEl.dataset.currentRoom = roomId;
                const alertListEl = document.getElementById('detail-alert-list');
                if (alertListEl) {
                    alertListEl.innerHTML = '<li class="text-center text-[var(--muted)] mt-4 w-full">Loading alerts...</li>';
                }
                applyPinNames(roomId);
                window.currentCfgRoom = roomId;
                const cfgRoomSelect = document.getElementById('cfg-room');
                if (cfgRoomSelect) {
                    cfgRoomSelect.value = roomId;
                }
                delete window.liveAlertSettings[roomId];
                try {
                    console.log(`Attempting to fetch live config for ${roomId}...`);
                    const config = await fetchConfigFromDevice(roomId);
                    console.log(`Successfully fetched config for ${roomId}`, config);
                    if (config && config.alerts) {
                        window.liveAlertSettings[roomId] = {
                            temp: {
                                critLow: config.alerts.temp_crit_low,
                                warnLow: config.alerts.temp_warn_low,
                                warnHigh: config.alerts.temp_warn_high,
                                critHigh: config.alerts.temp_crit_high
                            },
                            hum: {
                                critLow: config.alerts.hum_crit_low,
                                warnLow: config.alerts.hum_warn_low,
                                warnHigh: config.alerts.hum_warn_high,
                                critHigh: config.alerts.hum_crit_high
                            }
                        };
                    }
                } catch (error) {
                    console.warn(`Could not fetch live config for ${roomId}:`, error.message);
                    showPopup(`Could not get latest value from ${finalName}, fallback to last saved value`, { type: 'warn' });
                }
                const roomData = window.roomDataStore[roomId];
                updateAllDetailUI(roomData);
                const now = new Date().toISOString();
                const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                setDefault24hRange();
                const alerts = await fetchAlertsForRoom(roomId);
                renderDetailAlerts(alerts, roomId);
                fetchAndRenderRange();
                fetchAndRenderUptimeChart(roomId, 'detail-uptime-chart-canvas', 'detail-uptime-pct');
            }
            async function savePinMapToServer(roomId, formData) {
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                if (!mac) {
                    showPopup(`MAC address for room ${roomId} was not found`, { type: 'fail' });
                    return false;
                }
                const payload = {
                    mac: mac,
                    name_pin_25: formData.get('name_pin_25')?.trim() || '',
                    name_pin_26: formData.get('name_pin_26')?.trim() || '',
                    name_pin_32: formData.get('name_pin_32')?.trim() || '',
                    name_pin_33: formData.get('name_pin_33')?.trim() || '',
                };
                try {
                    const response = await fetch('/api/pin-map', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.error || 'Unknown error');
                    await loadPinMapFromServer();
                    showPopup('Sensor name saved successfully!', { type: 'success' });
                    return true;
                } catch (error) {
                    console.error('[Pin Map] Error saving to server:', error);
                    showPopup(`Failed to save: ${error.message}`, { type: 'fail' });
                    return false;
                }
            }
            function showPopup(message, opts = {}) {
                const type = opts.type || 'info';
                const timeout = (typeof opts.timeout === 'number') ? opts.timeout : 4000;
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                const icon = document.createElement('div');
                icon.className = 'toast-icon';
                icon.innerHTML = (type === 'success') ? '✅' : (type === 'warn') ? '⚠️' : (type === 'fail') ? '❌' : 'ℹ️';
                const msg = document.createElement('div');
                msg.className = 'qa-msg';
                msg.textContent = message;
                const closeBtn = document.createElement('button');
                closeBtn.className = 'toast-close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.addEventListener('click', () => {
                    toast.remove();
                    if (container && !container.hasChildNodes()) {
                        container.remove();
                    }
                });
                toast.appendChild(icon);
                toast.appendChild(msg);
                toast.appendChild(closeBtn);
                container.appendChild(toast);
                const timeoutId = setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.4s ease-out forwards';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                            if (container && !container.hasChildNodes()) {
                                container.remove();
                            }
                        }
                    }, 400);
                }, timeout);
                closeBtn.addEventListener('click', () => {
                    clearTimeout(timeoutId);
                });
            }
            document.addEventListener('click', e => { const id = e.target?.dataset?.close; if (id) closeModal(id); });
            document.getElementById('qa-reboot')?.addEventListener('click', () => openModal('modal-reboot'));
            document.getElementById('detail-btn-export')?.addEventListener('click', () => {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl?.dataset.currentRoom;
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                if (exportForm) {
                    exportForm.from.value = toLocalDatetimeInputValue(start);
                    exportForm.to.value = toLocalDatetimeInputValue(end);
                }
                if (roomId) {
                    const exportForm = document.getElementById('form-export');
                    if (exportForm && exportForm.room) {
                        exportForm.room.value = roomId;
                        const exportRoomSelect = exportForm.querySelector('select[name="room"]');
                        populateSensorCheckboxes(exportRoomSelect.value);
                    }
                }
                openModal('modal-export');
            });
            document.getElementById('detail-btn-settings')?.addEventListener('click', () => {
                const roomId = document.getElementById('detail-room-name').dataset.currentRoom;
                if (!roomId) return;
                if (window.chartApiData) feedChartsFromRows(window.chartApiData, false);
                window.currentCfgRoom = roomId;
                const cfgRoomSelect = document.getElementById('cfg-room');
                if (cfgRoomSelect) {
                    cfgRoomSelect.value = roomId;
                    cfgRoomSelect.dispatchEvent(new Event('change'));
                }
                showConfigPopup();
            });
            document.getElementById('detail-btn-reboot')?.addEventListener('click', () => {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl.dataset.currentRoom;
                const rebootModal = document.getElementById('modal-reboot');
                const rebootSelect = rebootModal.querySelector('select[name="target"]');
                if (rebootSelect && roomId) {
                    rebootSelect.value = roomId;
                }
                openModal('modal-reboot');
            });
            document.getElementById('qa-export')?.addEventListener('click', () => openModal('modal-export'));
            document.getElementById('qa-device-map')?.addEventListener('click', () => {
                try {
                    if (typeof loadMapForm === 'function') loadMapForm();
                    openModal('modal-device-map');
                } catch (e) { console.error(e); }
            });
            document.getElementById('form-reboot')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.currentTarget;
                const roomId = new FormData(form).get('target') || 'room-a';
                const roomName = roomId === 'all' ? 'All Devices' : (window.ROOM_NAMES?.[roomId] || roomId);
                const safeClose = () => { try { closeModal('modal-reboot'); } catch { } };
                const roomToMac = window.ROOM_TO_MAC_MAP || {};

                if (roomId === 'all') {
                    const allPotentialRooms = ['room-a', 'room-b', 'room-c', 'room-d'];
                    const roomsToReboot = allPotentialRooms.filter(rId => {
                        const mac = normalizeMAC(roomToMac[rId] || '');
                        const statusDot = document.getElementById(`status-dot-${rId}`);
                        const isOnline = statusDot && statusDot.classList.contains('led--green');
                        return mac && isOnline;
                    });

                    if (roomsToReboot.length === 0) {
                        showPopup('No online devices to reboot.', { type: 'fail' });
                        return;
                    }

                    const confirmed = await showConfirmationModal(
                        'Confirm Reboot All',
                        `This will send a reboot command to <strong>${roomsToReboot.length} online device(s)</strong>. Are you sure?`, {
                        confirmText: `Reboot ${roomsToReboot.length} Devices`,
                        confirmClass: 'btn-reset',
                        iconClass: 'fa-power-off',
                        iconColorClass: 'text-red-400'
                    }
                    );
                    if (!confirmed) return;

                    safeClose();
                    const success = await sendAction('Reboot', { room_id: 'all', mac: 'all' }, 'All Devices');
                    if (success) {
                        roomsToReboot.forEach(rId => {
                            console.log(`Rebooting all: resetting UI for ${rId}`);
                            resetRoomUI(rId);
                        });
                    }

                } else {
                    const mac = normalizeMAC(roomToMac[roomId] || '');
                    if (!mac) {
                        showPopup(`Device is not mapped for ${roomName}. Please check Device Map settings.`, { type: 'fail' });
                        return;
                    }
                    const statusDot = document.getElementById(`status-dot-${roomId}`);
                    const isOnline = statusDot && statusDot.classList.contains('led--green');
                    if (!isOnline) {
                        showPopup(`Cannot reboot: ${roomName} is offline.`, { type: 'fail' });
                        return;
                    }
                    const confirmed = await showConfirmationModal(
                        'Confirm Reboot',
                        `Are you sure you want to reboot <strong>${roomName}</strong>? This action is irreversible.`, {
                        confirmText: 'Yes, Reboot',
                        confirmClass: 'btn-reset',
                        iconClass: 'fa-power-off',
                        iconColorClass: 'text-red-400'
                    }
                    );
                    if (!confirmed) return;

                    safeClose();
                    const success = await sendAction('Reboot', { room_id: roomId, mac }, roomName);
                    if (success) {
                        console.log(`Reboot command successful for ${roomId}. Resetting UI.`);
                        resetRoomUI(roomId);
                    }
                }
            });
            document.querySelector('#form-export select[name="range"]')?.addEventListener('change', e => {
                const block = document.getElementById('export-custom');
                if (block) block.classList.toggle('hidden', e.target.value !== 'custom');
            });
            document.getElementById('form-export')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-export');
                const fd = new FormData(form);
                const room = fd.get('room') || 'all';
                const type = fd.get('type').toUpperCase();
                const from = fd.get('from') ? new Date(fd.get('from')).toISOString() : null;
                const to = fd.get('to') ? new Date(fd.get('to')).toISOString() : null;
                const roomName = room === 'all' ? 'All Rooms' : (window.ROOM_NAMES?.[room] || room);
                if (from && to && from >= to) {
                    showPopup('Error: Start date must be before end date.', { type: 'fail' });
                    return;
                }
                const confirmed = await showConfirmationModal(
                    `Confirm ${type} Export`,
                    `Are you sure you want to generate a <strong>${type}</strong> report for <strong>${roomName}</strong>?`,
                    {
                        confirmText: `Yes, Export ${type}`,
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-file-arrow-down',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                if (typeof uibuilder !== 'undefined') {
                    uibuilder.send({
                        topic: `reports/${room}/export`,
                        payload: { command: 'export', room: room, type: type.toLowerCase(), from, to }
                    });
                }
                showPopup(`Export request for ${roomName} has been sent.`, { type: 'success' });
                closeModal('modal-export');
            });
            document.getElementById('form-device-map')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-device-map');
                const confirmed = await showConfirmationModal(
                    'Confirm Device Map',
                    'Saving these changes will map devices to rooms and may require a page refresh. Proceed?',
                    {
                        confirmText: 'Confirm & Save',
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-diagram-project',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                const ok = await saveDeviceMapToServer(new FormData(form));
                if (ok) {
                    closeModal('modal-device-map');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            });
            document.getElementById('open-pin-map')?.addEventListener('click', () => {
                const detailRoomNameEl = document.getElementById('detail-room-name');
                const roomId = detailRoomNameEl?.dataset.currentRoom;
                if (!roomId) {
                    showPopup('Could not determine room ID', { type: 'fail' });
                    return;
                }
                const pinMapModal = document.getElementById('modal-pin-map');
                pinMapModal.dataset.currentRoom = roomId;
                const form = document.getElementById('form-pin-map');
                const mac = window.ROOM_TO_MAC_MAP?.[roomId];
                const roomPinNames = mac ? (window.MAC_PIN_NAMES?.[mac] || {}) : {};
                if (form) {
                    form.name_pin_25.value = roomPinNames['25'] || '';
                    form.name_pin_26.value = roomPinNames['26'] || '';
                    form.name_pin_32.value = roomPinNames['32'] || '';
                    form.name_pin_33.value = roomPinNames['33'] || '';
                }
                openModal('modal-pin-map');
            });
            document.getElementById('form-pin-map')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = document.getElementById('form-pin-map');
                const modal = form.closest('#modal-pin-map');
                const roomId = modal?.dataset.currentRoom;
                const roomName = window.ROOM_NAMES?.[roomId] || roomId;
                if (!roomId) {
                    showPopup('Error: Could not find Room ID', { type: 'fail' });
                    return;
                }
                const confirmed = await showConfirmationModal(
                    'Confirm Sensor Names',
                    `Are you sure you want to save these names for <strong>${roomName}</strong>?`,
                    {
                        confirmText: 'Confirm & Save',
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-tags',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (!confirmed) return;
                const ok = await savePinMapToServer(roomId, new FormData(form));
                if (ok) {
                    closeModal('modal-pin-map');
                    const currentRoomData = window.roomDataStore[roomId];
                    if (currentRoomData) {
                        updateSensorList(currentRoomData.live, roomId);
                    }
                    if (window.chartApiData) {
                        feedChartsFromRows(window.chartApiData, false);
                    }
                }
            });
            if (typeof uibuilder !== 'undefined') {
                window.roomDataStore = window.roomDataStore || {};
                window._roomTimeouts = window._roomTimeouts || {};
                window.pinStatuses = window.pinStatuses || {};
                window._configPromises = window._configPromises || {};
                const safeParse = v => {
                    if (v == null) return null;
                    if (typeof v === 'string') {
                        try { return JSON.parse(v); } catch { return null; }
                    }
                    return v;
                };
                uibuilder.onChange('msg', function (msg) {
                    if (msg.topic === 'system_summary_pro') {
                        const data = msg.payload;
                        const updateProKPI = (valueId, roomId, value, room, unit = '', options = {}) => {
                            const valueEl = document.getElementById(valueId);
                            const roomEl = document.getElementById(roomId);
                            if (!valueEl || !roomEl) return;
                            const prefix = options.prefix || '';
                            const decimals = options.decimals !== undefined ? options.decimals : 1;
                            if (value !== null && typeof value !== 'undefined' && isFinite(value)) {
                                valueEl.textContent = `${prefix}${Number(value).toFixed(decimals)}${unit}`;
                            } else {
                                valueEl.textContent = '—';
                            }
                            roomEl.textContent = room ? `@ ${room}` : '';
                            roomEl.title = room || '';
                        };
                        const hasMappedDevices = window.ROOM_TO_MAC_MAP && Object.keys(window.ROOM_TO_MAC_MAP).length > 0 && Object.values(window.ROOM_TO_MAC_MAP).some(mac => mac);
                        if (hasMappedDevices) {
                            updateProKPI('kpi-pro-temp-max', 'kpi-pro-temp-max-room', data.temp_max, data.temp_max_room, '°C');
                            updateProKPI('kpi-pro-hum-max', 'kpi-pro-hum-max-room', data.hum_max, data.hum_max_room, '%');
                            updateProKPI('kpi-pro-dew-max', 'kpi-pro-dew-max-room', data.dew_max, data.dew_max_room, '°C');
                            updateProKPI('kpi-pro-temp-rise', 'kpi-pro-temp-rise-room', data.temp_rise_max, data.temp_rise_max_room, '°C', {
                                prefix: (data.temp_rise_max > 0) ? '+' : ''
                            });
                        } else {
                            console.log('[System Summary] No mapped devices found, clearing summary KPIs.');
                            updateProKPI('kpi-pro-temp-max', 'kpi-pro-temp-max-room', null, '');
                            updateProKPI('kpi-pro-hum-max', 'kpi-pro-hum-max-room', null, '');
                            updateProKPI('kpi-pro-dew-max', 'kpi-pro-dew-max-room', null, '');
                            updateProKPI('kpi-pro-temp-rise', 'kpi-pro-temp-rise-room', null, '');
                        }
                        lastSystemSummary = {
                            temp_rise_per_room: data.temp_rise_per_room || {}
                        };
                        const modal = document.getElementById('modal-summary-detail');
                        if (modal && !modal.classList.contains('hidden')) {
                            refreshSummaryModal();
                        }
                        return;
                    }
                    const dataForRecoveryCheck = safeParse(msg.payload);
                    if (msg.topic === 'alert_recovered') {
                        console.log(`%c[RecoveryBell] MSG RECEIVED`, 'color: #88aaff; font-weight: bold;', dataForRecoveryCheck);
                        if (dataForRecoveryCheck && dataForRecoveryCheck.event_id !== undefined) {
                            const eventId = dataForRecoveryCheck.event_id;
                            const isDuplicate = allAlertsCache.some(item => item.event_id === eventId);
                            if (!isDuplicate) {
                                allAlertsCache.unshift(dataForRecoveryCheck);
                                console.log(`%c[DataStore] Added new recovery event to cache. New cache size: ${allAlertsCache.length}`, 'color: cyan;');
                            }
                            if (!unseenRecoveryIds.has(eventId)) {
                                unseenRecoveryIds.add(eventId);
                                console.log(`%c[RecoveryBell] -> ID was new. Added to set. New size: ${unseenRecoveryIds.size}.`, 'color: lightgreen;');
                                updateRecoveryBadge();
                            }
                        }
                    }
                    if (!msg) return;
                    const data = safeParse(msg.payload);
                    if (!data || typeof data !== 'object') return;
                    if (data.mac && data.status && data.avg_temp === undefined) {
                        const mac = findMACInObject(data);
                        const roomId = mac ? window.MAC_TO_ROOM_MAP[mac] : null;
                        if (roomId) {
                            console.log(`[Direct Status] Received status for ${roomId}: ${data.status}`);
                            if (data.status === 'offline') {
                                resetRoomUI(roomId);
                            } else {
                                const statusDot = document.getElementById(`status-dot-${roomId}`);
                                if (statusDot) setLed(statusDot, 'led--green');
                            }
                        }
                        return;
                    }
                    const topic = msg.topic || '';
                    if (data.actionId || topic === 'actions/ack') {
                        _dispatchQA(msg);
                        return;
                    }
                    if (topic === 'alert_event' || topic === 'alert_recovered') {
                        if (data.type) {
                            const roomName = data.room_name || 'Unknown Room';
                            const metricMap = {
                                temp: 'Temperature',
                                hum: 'Humidity',
                                connectivity: 'Device Status',
                                sensor_connectivity: 'Sensor Status'
                            };
                            const metricText = metricMap[data.metric] || data.metric;
                            if (data.type === 'triggered') {
                                const level = data.level;
                                const toastType = level === 'critical' ? 'fail' : 'warn';
                                let message = '';
                                const sensorName = data.sensor_name || 'Unknown Sensor';
                                if (data.metric === 'connectivity') {
                                    message = `${level.toUpperCase()} in ${roomName}: Device is now Offline.`;
                                } else if (data.metric === 'sensor_connectivity') {
                                    message = `${level.toUpperCase()} in ${roomName}: Sensor '${sensorName}' is now Offline.`;
                                } else {
                                    const value = Number(data.value).toFixed(1);
                                    const unit = data.metric === 'temp' ? '°C' : '%';
                                    message = `${level.toUpperCase()} in ${roomName}: ${sensorName} ${metricText} is ${value}${unit}.`;
                                }
                                showPopup(message, { type: toastType, timeout: 10000 });
                            } else if (data.type === 'recovered') {
                                let message = '';
                                const sensorName = data.sensor_name || 'Unknown Sensor';
                                if (data.metric === 'connectivity') {
                                    message = `Recovery in ${roomName}: Device is back online.`;
                                } else if (data.metric === 'sensor_connectivity') {
                                    message = `Recovery in ${roomName}: Sensor '${sensorName}' is back online.`;
                                } else {
                                    message = `Recovery in ${roomName}: ${sensorName} ${metricText} is back to normal.`;
                                }
                                showPopup(message, { type: 'success', timeout: 7000 });
                            }
                        }
                        refreshVisibleAlertViews();
                    }
                    if (topic.startsWith('esp32/response/') && topic.endsWith('/config')) {
                        const incomingId = (data?.requestId || '').toString();
                        if (incomingId && window._configPromises[incomingId]) {
                            window._configPromises[incomingId].resolve(data);
                            delete window._configPromises[incomingId];
                            console.log(`[Config] Resolved promise for requestId: ${incomingId}`);
                        }
                        return;
                    }
                    if (topic === 'uibuilder') return;
                    if (topic === 'pin_status_update') {
                        const statuses = Array.isArray(msg.payload) ? msg.payload : [];
                        let changed = false;
                        statuses.forEach(s => {
                            const k = String(s.pin);
                            if (window.pinStatuses[k] !== s.status) {
                                window.pinStatuses[k] = s.status;
                                changed = true;
                            }
                        });
                        if (changed) {
                            const detailModal = document.getElementById('modal-room-detail');
                            const currentRoom = document.getElementById('detail-room-name')?.dataset.currentRoom;
                            if (detailModal && !detailModal.classList.contains('hidden') && currentRoom && window.roomDataStore[currentRoom]) {
                                updateSensorList(window.roomDataStore[currentRoom].live, currentRoom);
                            }
                        }
                        return;
                    }
                    if (!window._gotFirstMsg) window._gotFirstMsg = true;
                    const mac = findMACInObject(data);
                    const roomId = mac ? window.MAC_TO_ROOM_MAP[mac] : null;
                    if (data.status) {
                        updateDeviceStatus(data.status, data.ping_ms);
                    }
                    if (!roomId) {
                        updateKPIs(data);
                        updateAlertCards(data);
                        return;
                    }
                    if (window._roomTimeouts[roomId]) {
                        clearTimeout(window._roomTimeouts[roomId]);
                    }
                    window._roomTimeouts[roomId] = setTimeout(() => {
                        resetRoomUI(roomId);
                    }, ROOM_TIMEOUT_MS);
                    if (!window.roomDataStore[roomId]) {
                        window.roomDataStore[roomId] = { history: [], live: {} };
                    }
                    const store = window.roomDataStore[roomId];
                    const pinVal = (typeof data.pin === 'number' || /^\d+$/.test(data.pin)) ? Number(data.pin) : data.pin || 'OVERALL';
                    store.live[pinVal] = data;
                    if (pinVal === 'OVERALL') {
                        updateRoomUI(roomId, data);
                        pushHistorySample(roomId, data);
                        const detailModal = document.getElementById('modal-room-detail');
                        const detailRoomNameEl = document.getElementById('detail-room-name');
                        const isDetailModalOpenForThisRoom =
                            detailModal &&
                            !detailModal.classList.contains('hidden') &&
                            detailRoomNameEl?.dataset.currentRoom === roomId;
                        if (isDetailModalOpenForThisRoom) {
                            console.log(`[Real-time Update] Refreshing open detail modal for ${roomId}`);
                            updateAllDetailUI(store);
                        }
                        const last = store.history.length ? store.history[store.history.length - 1] : {};
                        const newHistoryEntry = {
                            timestamp: data.timestamp,
                            temp_overall: data.avg_temp,
                            rh_overall: data.avg_hum,
                            temp_pin25: store.live[25]?.avg_temp ?? last.temp_pin25,
                            temp_pin26: store.live[26]?.avg_temp ?? last.temp_pin26,
                            temp_pin32: store.live[32]?.avg_temp ?? last.temp_pin32,
                            temp_pin33: store.live[33]?.avg_temp ?? last.temp_pin33,
                            rh_pin25: store.live[25]?.avg_hum ?? last.rh_pin25,
                            rh_pin26: store.live[26]?.avg_hum ?? last.rh_pin26,
                            rh_pin32: store.live[32]?.avg_hum ?? last.rh_pin32,
                            rh_pin33: store.live[33]?.avg_hum ?? last.rh_pin33,
                            min_temp: data.min_temp,
                            max_temp: data.max_temp,
                            min_hum: data.min_hum,
                            max_hum: data.max_hum,
                        };
                        store.history.push(newHistoryEntry);
                        if (store.history.length > 100) store.history.shift();
                        if (detailModal && !detailModal.classList.contains('hidden') && detailRoomNameEl?.dataset.currentRoom === roomId) {
                            if (window.chartApiData && newHistoryEntry) window.chartApiData.push(newHistoryEntry);
                            feedChartsFromRows(window.chartApiData, false);
                            updateAllDetailUI(store);
                            updateDetailKPIs(store.history);
                            updateSensorList(store.live);
                        }
                    }
                    if (typeof ensurePanel === 'function') ensurePanel(roomId);
                    if (typeof checkAndFetchConfig === 'function') checkAndFetchConfig(roomId);
                    updateKPIs(data);
                });
            }
            document.getElementById('btn-copy-mac')?.addEventListener('click', handleCopyMac);
            function copyTextFallback(text) {
                const ta = document.createElement('textarea');
                ta.value = text; ta.setAttribute('readonly', '');
                ta.style.position = 'absolute'; ta.style.left = '-9999px';
                document.body.appendChild(ta); ta.select();
                let ok = false; try { ok = document.execCommand('copy'); } catch { }
                document.body.removeChild(ta); return ok;
            }
            async function handleCopyMac() {
                const macEl = document.getElementById('cfg-mac');
                const btn = document.getElementById('btn-copy-mac');
                const mac = (macEl?.textContent || '').trim();
                if (!mac || mac === '--:--:--:--:--:--') return;
                const originalHTML = btn.innerHTML;
                const showOK = () => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i><span></span>';
                    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 1400);
                };
                const showFail = () => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-xmark"></i><span>Retry</span>';
                    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalHTML; }, 1400);
                };
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(mac);
                        showOK();
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = mac; ta.setAttribute('readonly', '');
                        ta.style.position = 'absolute'; ta.style.left = '-9999px';
                        document.body.appendChild(ta); ta.select();
                        const ok = document.execCommand('copy');
                        document.body.removeChild(ta);
                        ok ? showOK() : showFail();
                    }
                } catch {
                    showFail();
                }
            }
            (function bindKeyOnce() {
                if (window.__modalKeyBound) return;
                window.__modalKeyBound = true;
                document.addEventListener('keydown', (e) => {
                    const m = findOpenModal();
                    if (!m) return;
                    if (e.key === 'Escape' || e.key === 'Esc') {
                        e.preventDefault(); e.stopPropagation();
                        closeModal(m.id);
                        return;
                    }
                    if (e.key === 'Enter') {
                        if (m.id === 'modal-settings') {
                            const settingsPanel = m.querySelector('.config-panel');
                            if (settingsPanel && settingsPanel.classList.contains('settings-locked')) {
                                console.log('[Keybind] Enter key ignored: Settings form is locked.');
                                return;
                            }
                        }
                        const tag = document.activeElement?.tagName?.toLowerCase();
                        if (tag === 'textarea') return;
                        e.preventDefault(); e.stopPropagation();
                        clickPrimary(m);
                    }
                }, { capture: true });
            })();
            applyRoomNames();
            initAllRoomsOffline();
            function isVisible(el) {
                if (!el) return false;
                const st = getComputedStyle(el);
                if (st.display === 'none' || st.visibility === 'hidden' || st.opacity === '0') return false;
                return el.offsetWidth > 0 || el.offsetHeight > 0;
            }
            function findOpenModal() {
                const cands = Array.from(document.querySelectorAll('[id^="modal-"]'));
                const visible = cands.filter(el => !el.classList.contains('hidden') && isVisible(el));
                if (visible.length === 0) {
                    return null;
                }
                if (visible.length === 1) {
                    return visible[0];
                }
                return visible.reduce((topModal, currentModal) => {
                    const topZ = parseInt(getComputedStyle(topModal).zIndex, 10) || 0;
                    const currentZ = parseInt(getComputedStyle(currentModal).zIndex, 10) || 0;
                    return currentZ > topZ ? currentModal : topModal;
                });
            }
            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (!el || el.classList.contains('hidden')) return;
                if (id === 'modal-settings') {
                    lockSettingsForm();
                }
                if (id === 'modal-alert-center') {
                    processNewlySeenRecoveries();
                }
                el.classList.add('modal-is-exiting');
                setTimeout(() => {
                    el.classList.add('hidden');
                    el.classList.remove('active', 'centered', 'modal-is-exiting');
                }, 200);
                if (document.activeElement?.blur) document.activeElement.blur();
            }
            function clickPrimary(modalEl) {
                if (!modalEl) return;
                const selectors = [
                    '#btn-save-settings',
                    'button[data-primary="true"]',
                    'button.btn-primary:not([disabled])',
                    'button[type="submit"]:not([disabled])',
                ];
                for (const sel of selectors) {
                    const btn = modalEl.querySelector(sel);
                    if (btn) { btn.click(); return; }
                }
            }
            window.DetailUI = {
                series: { overall: true, pin25: true, pin26: true, pin32: true, pin33: true, dew: true },
                range: { mode: '24h', start: null, end: null }
            };
            window.allEffectiveRules = {};
            function initDetailToolbar() {
                document.querySelectorAll('#detail-toolbar [data-range]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        window.DetailUI.range = { mode: btn.dataset.range, start: null, end: null };
                        fetchAndRenderRange();
                    });
                });
                document.getElementById('btn-apply-range')?.addEventListener('click', () => {
                    fetchAndRenderRange();
                });
                document.getElementById('series-toggle')?.addEventListener('change', (e) => {
                    if (!e.target.matches('input[type="checkbox"][data-series]')) return;
                    const key = e.target.dataset.series;
                    const isChecked = e.target.checked;
                    window.DetailUI.series[key] = isChecked;
                    if (key === 'overall' && !isChecked) {
                        const dewCheckbox = document.querySelector('input[data-series="dew"]');
                        if (dewCheckbox) {
                            dewCheckbox.checked = false;
                            window.DetailUI.series['dew'] = false;
                        }
                    }
                    feedChartsFromRows(window.chartApiData, false);
                });
                document.getElementById('toggle-thresholds')?.addEventListener('change', () => {
                    feedChartsFromRows(window.chartApiData, false);
                });
            }
            document.addEventListener('click', (e) => {
                const closeTarget = e.target?.closest?.('[data-close]');
                if (!closeTarget) return;
                const val = closeTarget.getAttribute('data-close');
                if (val === 'this') {
                    const m = findOpenModal();
                    if (m) closeModal(m.id);
                } else if (val) {
                    closeModal(val);
                }
            }, { capture: true });
            function setDefault24hRange() {
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                document.getElementById('range-start').value = toLocalDatetimeInputValue(start);
                document.getElementById('range-end').value = toLocalDatetimeInputValue(end);
            }
            function getCurrentRangeISO() {
                const fromISO = getIsoFromInput('range-start');
                const toISO = getIsoFromInput('range-end');
                return { fromISO, toISO };
            }
            function getIsoFromInput(id) {
                const v = document.getElementById(id).value;
                if (!v) return null;
                const dt = new Date(v);
                if (isNaN(dt)) return null;
                return dt.toISOString();
            }
            (function initRangeOnce() {
                const rs = document.getElementById('range-start');
                const re = document.getElementById('range-end');
                if (rs && re) setDefault24hRange();
            })();
            async function fetchSeriesForCurrentRoom() {
                const detailTitle = document.getElementById('detail-room-name');
                const roomId = detailTitle?.dataset?.currentRoom;
                if (!roomId) throw new Error('No current room');
                const roomToMac = {};
                Object.entries(window.MAC_TO_ROOM_MAP || {}).forEach(([mac, r]) => { roomToMac[r] = mac; });
                const mac = roomToMac[roomId];
                if (!mac) throw new Error('No MAC mapped for room ' + roomId);
                const startISO = getIsoFromInput('range-start');
                const endISO = getIsoFromInput('range-end');
                if (!startISO || !endISO) throw new Error('Start/End is missing');
                const pins = ['OVERALL', '25', '26', '32', '33'];
                const qs = new URLSearchParams({
                    mac,
                    start: startISO,
                    end: endISO,
                    pins: pins.join(',')
                });
                const res = await fetch(`/api/data?${qs.toString()}`);
                if (!res.ok) throw new Error('API failed');
                const rows = await res.json();
                return rows;
            }
            document.getElementById('btn-apply-range')?.addEventListener('click', async () => {
                try {
                    const rows = await fetchSeriesForCurrentRoom();
                    feedChartsFromRows(rows, true);
                } catch (e) {
                    showPopup('Failed to load data: ' + e.message, { type: 'fail' });
                }
            });
            document.getElementById('btn-reset-range')?.addEventListener('click', async () => {
                setDefault24hRange();
                await fetchAndRenderRange();
            });
            loadDeviceMapFromServer();
            const dateInputs = document.querySelectorAll('input[type="datetime-local"]');
            dateInputs.forEach(input => {
                input.addEventListener('click', (event) => {
                    try {
                        event.target.showPicker();
                    } catch (error) {
                        console.error("เบราว์เซอร์นี้อาจจะไม่รองรับ .showPicker()", error);
                    }
                });
            });
            let allAlertsCache = [];
            let isFetchingAlerts = false;
            qaAlertsButton?.addEventListener('click', () => {
                openModal('modal-alert-center');
                resetFilters();
                loadAndCacheAlerts();
            });
            searchInput?.addEventListener('input', applyFilters);
            levelSelect?.addEventListener('change', applyFilters);
            statusSelect?.addEventListener('change', loadAndCacheAlerts);
            applyButton?.addEventListener('click', loadAndCacheAlerts);
            resetButton?.addEventListener('click', () => {
                resetFilters();
                loadAndCacheAlerts();
            });
            async function loadAndCacheAlerts() {
                if (isFetchingAlerts) {
                    console.log('[AlertCenter] Fetch is already in progress. Skipping.');
                    return;
                }
                isFetchingAlerts = true;
                alertTableBodyEl.innerHTML = '<tr><td colspan="11" class="p-8 text-center text-[var(--muted)]"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Loading alerts...</td></tr>';
                const status = statusSelect.value || 'open,ack';
                const isClosedTab = status.includes('closed');
                toggleDateInputs(!isClosedTab);
                let start = '';
                let end = '';
                if (isClosedTab) {
                    start = startDateInput.value ? new Date(startDateInput.value).toISOString() : '';
                    end = endDateInput.value ? new Date(endDateInput.value).toISOString() : '';
                }
                try {
                    const apiUrl = `/api/alerts?status=${encodeURIComponent(status)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
                    const res = await fetch(apiUrl, { cache: 'no-store' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    allAlertsCache = Array.isArray(data) ? data : (data?.alerts || []);
                    applyFilters();
                } catch (err) {
                    console.error('[AlertCenter] loadAlerts error:', err);
                    allAlertsCache = [];
                    renderAlertTable([]);
                    alertTableBodyEl.innerHTML = '<tr><td colspan="11" class="p-8 text-center text-red-400">Failed to load alerts. Please try again.</td></tr>';
                } finally {
                    isFetchingAlerts = false;
                }
            }
            function toggleDateInputs(isDisabled) {
                const startDateInput = document.getElementById('alert-filter-start-date');
                const endDateInput = document.getElementById('alert-filter-end-date');
                const applyButton = document.getElementById('alert-filter-apply');
                const resetButton = document.getElementById('alert-filter-reset');
                if (startDateInput) {
                    startDateInput.disabled = isDisabled;
                    startDateInput.classList.toggle('opacity-50', isDisabled);
                    startDateInput.classList.toggle('cursor-not-allowed', isDisabled);
                }
                if (endDateInput) {
                    endDateInput.disabled = isDisabled;
                    endDateInput.classList.toggle('opacity-50', isDisabled);
                    endDateInput.classList.toggle('cursor-not-allowed', isDisabled);
                }
                if (applyButton) {
                    applyButton.disabled = isDisabled;
                    applyButton.classList.toggle('opacity-50', isDisabled);
                    applyButton.classList.toggle('cursor-not-allowed', isDisabled);
                }
                if (resetButton) {
                    resetButton.disabled = isDisabled;
                    resetButton.classList.toggle('opacity-50', isDisabled);
                    resetButton.classList.toggle('cursor-not-allowed', isDisabled);
                }
            }
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const level = levelSelect.value;
                const metricMap = {
                    temp: 'Temperature',
                    hum: 'Humidity',
                    connectivity: 'Connectivity',
                    sensor_connectivity: 'Sensor Connectivity'
                };
                const filteredAlerts = allAlertsCache.filter(alert => {
                    const pinMap = window.MAC_PIN_NAMES?.[alert.mac] || {};
                    const customSensorName = pinMap[`name_pin_${alert.sensor_name}`] || alert.sensor_name;
                    const displayMetric = (metricMap[alert.metric] || alert.metric).toLowerCase();
                    const inSearch = searchTerm === '' ||
                        (alert.opened_at?.toLowerCase().includes(searchTerm)) ||
                        (alert.room_name?.toLowerCase().includes(searchTerm)) ||
                        (customSensorName.toLowerCase().includes(searchTerm)) ||
                        (alert.metric?.toLowerCase().includes(searchTerm)) ||
                        (displayMetric.includes(searchTerm)) ||
                        (alert.level?.toLowerCase().includes(searchTerm)) ||
                        String(alert.trigger_value).toLowerCase().includes(searchTerm) ||
                        (alert.status?.toLowerCase().includes(searchTerm)) ||
                        (alert.ack_by?.toLowerCase().includes(searchTerm)) ||
                        (alert.ack_note?.toLowerCase().includes(searchTerm)) ||
                        (alert.mac?.toLowerCase().includes(searchTerm));
                    const inLevel = level === '' || alert.level === level;
                    return inSearch && inLevel;
                });
                renderAlertTable(filteredAlerts);
            }
            function renderAlertTable(alerts) {
                console.log('DEBUG 2: Rendering table. Unseen IDs Set:', unseenRecoveryIds);
                const alertTableBodyEl = document.getElementById('alert-table-body');
                if (!alertTableBodyEl) return;
                alertTableBodyEl.innerHTML = '';
                if (!alerts || alerts.length === 0) {
                    alertTableBodyEl.innerHTML = '<tr><td colspan="11" class="p-8 text-center text-[var(--muted)]">No alerts match the current filters.</td></tr>';
                    return;
                }
                const currentTab = document.getElementById('alert-filter-status').value || 'open,ack';
                const metricMap = {
                    temp: 'Temperature',
                    hum: 'Humidity',
                    connectivity: 'Connectivity',
                    sensor_connectivity: 'Sensor Connectivity'
                };
                alerts.forEach(alert => {
                    const row = document.createElement('tr');
                    const isUnseen = unseenRecoveryIds.has(alert.event_id);
                    console.log(`DEBUG 3: Checking event_id: ${alert.event_id}, Status: ${alert.status}, Is Unseen? ${isUnseen}`);
                    row.className = `border-b border-[var(--border)] ${isUnseen ? 'unseen-recovery' : ''}`;
                    row.dataset.eventId = alert.event_id;
                    const primaryTime = fmtDate(resolvePrimaryTime(alert, currentTab));
                    const pinMap = window.MAC_PIN_NAMES?.[alert.mac] || {};
                    const customSensorName = pinMap[`name_pin_${alert.sensor_name}`] || alert.sensor_name;
                    const displayMetric = metricMap[alert.metric] || alert.metric;
                    row.innerHTML = `
            <td class="p-3 text-center"><input type="checkbox" class="ack-checkbox" data-event-id="${alert.event_id}" ${alert.status !== 'open' ? 'disabled' : ''}></td>
            <td class="p-3 whitespace-nowrap time-cell cursor-pointer">${primaryTime}</td>
            <td class="p-3">${alert.room_name}</td>
            <td class="p-3">${customSensorName}</td>
            <td class="p-3">${displayMetric}</td>
            <td class="p-3"><span class="badge badge-${alert.level}">${alert.level}</span></td>
            <td class="p-3">${alert.trigger_value !== null ? Number(alert.trigger_value).toFixed(2) : 'N/A'}</td>
            <td class="p-3 capitalize">${alert.status}</td>
            <td class="p-3">${alert.ack_by || '-'}</td>
            <td class="p-3 truncate max-w-xs" title="${alert.ack_note || ''}">${alert.ack_note || '<i class="opacity-50">No note</i>'}</td>
            <td class="p-3 text-center">
                ${alert.status === 'open' ? `<button class="btn text-xs py-1 px-2 btn-ack-single" data-event-id="${alert.event_id}">ACK</button>` : ''}
            </td>
        `;
                    const timeCell = row.querySelector('.time-cell');
                    if (timeCell) {
                        timeCell.addEventListener('mouseenter', (e) => {
                            alertLifecycleTooltip.innerHTML = buildLifecycleTooltipHTML(alert, currentTab);
                            alertLifecycleTooltip.style.opacity = 1;
                        });
                        timeCell.addEventListener('mousemove', (e) => {
                            alertLifecycleTooltip.style.left = `${e.pageX + 15}px`;
                            alertLifecycleTooltip.style.top = `${e.pageY}px`;
                            alertLifecycleTooltip.style.transform = 'translateY(-50%)';
                        });
                        timeCell.addEventListener('mouseleave', () => {
                            alertLifecycleTooltip.style.opacity = 0;
                        });
                    }
                    alertTableBodyEl.appendChild(row);
                });
                setupIntersectionObserver();
            }
            function toLocalDatetimeInputValue(d) {
                if (!(d instanceof Date) || isNaN(d)) return '';
                const pad = n => String(n).padStart(2, '0');
                const y = d.getFullYear();
                const m = pad(d.getMonth() + 1);
                const day = pad(d.getDate());
                const hh = pad(d.getHours());
                const mm = pad(d.getMinutes());
                return `${y}-${m}-${day}T${hh}:${mm}`;
            }
            function resetFilters() {
                searchInput.value = '';
                levelSelect.value = '';
                const end = new Date();
                const start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
                startDateInput.value = toLocalDatetimeInputValue(start);
                endDateInput.value = toLocalDatetimeInputValue(end);
            }
            function updateQAAlertCount(count) {
                if (qaAlertCountEl) {
                    if (count > 0) {
                        qaAlertCountEl.textContent = count;
                        qaAlertCountEl.classList.remove('hidden');
                        qaAlertCountEl.classList.add('flex');
                    } else {
                        qaAlertCountEl.classList.add('hidden');
                    }
                }
            }
            document.getElementById('alert-table-body').addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-ack-single');
                if (btn) {
                    const eventId = btn.dataset.eventId;
                    openAckModal([eventId]);
                }
            });
            bulkAckButton?.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.ack-checkbox:checked')).map(cb => cb.dataset.eventId);
                if (selectedIds.length > 0) {
                    openAckModal(selectedIds);
                } else {
                    showPopup('Please select at least one alert to acknowledge.', { type: 'warn' });
                }
            });
            function updateBulkAckButtonState() {
                const selectedCount = document.querySelectorAll('.ack-checkbox:checked').length;
                bulkAckButton.disabled = selectedCount === 0;
            }
            ackAllCheckbox?.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.ack-checkbox:not(:disabled)').forEach(cb => {
                    cb.checked = isChecked;
                });
                updateBulkAckButtonState();
            });
            alertTableBodyEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('ack-checkbox')) {
                    const totalCheckboxes = document.querySelectorAll('.ack-checkbox:not(:disabled)').length;
                    const selectedCount = document.querySelectorAll('.ack-checkbox:checked').length;
                    ackAllCheckbox.checked = totalCheckboxes > 0 && selectedCount === totalCheckboxes;
                    updateBulkAckButtonState();
                }
            });
            function openAckModal(eventIds) {
                if (!Array.isArray(eventIds)) eventIds = [eventIds];
                if (eventIds.length === 0) return;
                const modal = document.getElementById('modal-ack');
                modal.dataset.eventIds = JSON.stringify(eventIds);
                document.getElementById('ack-by-input').value = '';
                document.getElementById('ack-note-input').value = '';
                document.getElementById('ack-by-error').classList.add('hidden');
                openModal('modal-ack');
                document.getElementById('ack-by-input').focus();
            }
            async function handleConfirmAck() {
                const ackByInput = document.getElementById('ack-by-input');
                const ackNoteInput = document.getElementById('ack-note-input');
                const errorEl = document.getElementById('ack-by-error');
                const modal = document.getElementById('modal-ack');
                const ackBy = ackByInput.value.trim();
                const ackNote = ackNoteInput.value.trim();
                const eventIds = JSON.parse(modal.dataset.eventIds || '[]');
                if (!ackBy) {
                    errorEl.textContent = 'Please fill in the name of the acknowledge';
                    errorEl.classList.remove('hidden');
                    ackByInput.focus();
                    return;
                } else if (ackBy.toLowerCase() === 'system') {
                    errorEl.textContent = 'The name ‘System’ cannot be used.';
                    errorEl.classList.remove('hidden');
                    ackByInput.focus();
                    return;
                } else {
                    errorEl.classList.add('hidden');
                }
                const btn = document.getElementById('btn-confirm-ack');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Processing...';
                const payload = { ack_by: ackBy, ack_note: ackNote };
                const promises = eventIds.map(id =>
                    fetch(`/api/alerts/${id}/ack`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                );
                try {
                    const responses = await Promise.all(promises);
                    const allSuccess = responses.every(res => res.ok);
                    if (allSuccess) {
                        showPopup(`Acknowledged ${eventIds.length} alert(s).`, { type: 'success' });
                        closeModal('modal-ack');
                        await refreshVisibleAlertViews();
                    } else {
                        const failedResponse = responses.find(res => !res.ok);
                        let errorMessage = `Server responded with status ${failedResponse.status}`;
                        try {
                            const errorJson = await failedResponse.json();
                            errorMessage = errorJson.error || errorMessage;
                        } catch (e) { }
                        throw new Error(errorMessage);
                    }
                } catch (err) {
                    showPopup(`Failed to acknowledge alerts: ${err.message}`, { type: 'fail' });
                    console.error("ACK Error:", err);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Confirm';
                }
            }
            recoveryFab.addEventListener('click', () => {
                console.log('[RecoveryBell] FAB clicked!');
                openModal('modal-alert-center');
                const statusSelect = document.getElementById('alert-filter-status');
                const startDateInput = document.getElementById('alert-filter-start-date');
                const endDateInput = document.getElementById('alert-filter-end-date');
                if (statusSelect && startDateInput && endDateInput) {
                    resetFilters();
                    startDateInput.value = '';
                    endDateInput.value = '';
                    statusSelect.value = 'closed';
                    loadAndCacheAlerts();
                }
            });
            async function handleDeleteSensorRule() {
                const mac = drawerEl.dataset.mac;
                const sensorName = drawerEl.dataset.sensor;
                if (!mac || !sensorName) {
                    showPopup('Error: Cannot identify sensor to reset.', { type: 'fail' });
                    return;
                }
                const rulePayload = [
                    { scope: 'sensor', mac, sensor_name: sensorName, metric: 'temp', active: 0 },
                    { scope: 'sensor', mac, sensor_name: sensorName, metric: 'hum', active: 0 }
                ];
                try {
                    const res = await fetch('/api/alert-rules', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(rulePayload)
                    });
                    if (!res.ok) throw new Error('Server returned an error');
                    showPopup('Sensor rule has been reset to inherit.', { type: 'success' });
                    await loadSensorRuleData(mac, sensorName);
                    const overrideToggle = document.getElementById('toggle-override');
                    if (overrideToggle) {
                        overrideToggle.checked = false;
                        overrideToggle.dispatchEvent(new Event('change'));
                    }
                    drawerEl.classList.remove('open');
                } catch (err) {
                    showPopup('Failed to reset rule.', { type: 'fail' });
                    console.error('Failed to reset/delete sensor rule:', err);
                }
            }
            document.getElementById('btn-confirm-ack')?.addEventListener('click', handleConfirmAck);
            document.getElementById('alert-table-body').addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-ack-single');
                if (btn) {
                    const eventId = btn.dataset.eventId;
                    openAckModal([eventId]);
                }
            });
            document.getElementById('btn-bulk-ack')?.addEventListener('click', () => {
                const selectedIds = Array.from(document.querySelectorAll('.ack-checkbox:checked')).map(cb => cb.dataset.eventId);
                if (selectedIds.length > 0) {
                    openAckModal(selectedIds);
                }
            });
            function handleAlertCardClick(levelFilter = '') {
                openModal('modal-alert-center');
                resetFilters();
                const statusSelect = document.getElementById('alert-filter-status');
                const levelSelect = document.getElementById('alert-filter-level');
                if (unseenRecoveryIds.size > 0) {
                    statusSelect.value = 'closed';
                    const startDateInput = document.getElementById('alert-filter-start-date');
                    const endDateInput = document.getElementById('alert-filter-end-date');
                    if (startDateInput) startDateInput.value = '';
                    if (endDateInput) endDateInput.value = '';
                } else {
                    statusSelect.value = 'open,ack';
                }
                levelSelect.value = levelFilter;
                loadAndCacheAlerts();
            }
            document.getElementById('qa-alert-card')?.addEventListener('click', (e) => {
                if (e.target.closest('#card-critical') || e.target.closest('#card-warning')) {
                    return;
                }
                handleAlertCardClick('');
            });
            document.getElementById('card-critical')?.addEventListener('click', () => {
                handleAlertCardClick('critical');
            });
            document.getElementById('card-warning')?.addEventListener('click', () => {
                handleAlertCardClick('warning');
            });
            function updateBulkAckButtonState() {
                const selectedCount = document.querySelectorAll('.ack-checkbox:checked').length;
                bulkAckButton.disabled = selectedCount === 0;
            }
            ackAllCheckbox?.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.ack-checkbox:not(:disabled)').forEach(cb => {
                    cb.checked = isChecked;
                });
                updateBulkAckButtonState();
            });
            alertTableBodyEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('ack-checkbox')) {
                    const totalCheckboxes = document.querySelectorAll('.ack-checkbox:not(:disabled)').length;
                    const selectedCount = document.querySelectorAll('.ack-checkbox:checked').length;
                    ackAllCheckbox.checked = totalCheckboxes > 0 && selectedCount === totalCheckboxes;
                    updateBulkAckButtonState();
                }
            });
            function openSensorRuleEditor(mac, sensorName, metric) {
                const modalEl = document.getElementById('modal-sensor-rules');
                modalEl.dataset.mac = mac;
                modalEl.dataset.sensor = sensorName;
                modalEl.dataset.metric = metric;
                const roomName = window.ROOM_NAMES[window.MAC_TO_ROOM_MAP[mac]] || mac;
                document.getElementById('drawer-sensor-subtitle').textContent = `${roomName} / ${sensorName}`;
                loadSensorRuleData(mac, sensorName);
                openModal('modal-sensor-rules');
            }
            async function loadSensorRuleData(mac, sensorName) {
                const [resTemp, resHum] = await Promise.all([
                    fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=${sensorName}&metric=temp`),
                    fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=${sensorName}&metric=hum`)
                ]);
                const effectiveTempRule = await resTemp.json();
                const effectiveHumRule = await resHum.json();
                const resOverride = await fetch(`/api/alert-rules?scope=sensor&mac=${mac}&sensor_name=${sensorName}`);
                const overrideData = await resOverride.json();
                const tempRule = overrideData.find(r => r.metric === 'temp' && r.active) || {};
                const humRule = overrideData.find(r => r.metric === 'hum' && r.active) || {};
                const hasOverride = tempRule.id || humRule.id;
                overrideToggle.checked = hasOverride;
                ruleFormFields.classList.toggle('opacity-50', !hasOverride);
                ruleFormFields.classList.toggle('pointer-events-none', !hasOverride);
                document.getElementById('rule-temp-crit-low').value = tempRule.crit_min ?? effectiveTempRule.crit_min ?? '';
                document.getElementById('rule-temp-warn-low').value = tempRule.warn_min ?? effectiveTempRule.warn_min ?? '';
                document.getElementById('rule-temp-warn-high').value = tempRule.warn_max ?? effectiveTempRule.warn_max ?? '';
                document.getElementById('rule-temp-crit-high').value = tempRule.crit_max ?? effectiveTempRule.crit_max ?? '';
                document.getElementById('rule-hum-crit-low').value = humRule.crit_min ?? effectiveHumRule.crit_min ?? '';
                document.getElementById('rule-hum-warn-low').value = humRule.warn_min ?? effectiveHumRule.warn_min ?? '';
                document.getElementById('rule-hum-warn-high').value = humRule.warn_max ?? effectiveHumRule.warn_max ?? '';
                document.getElementById('rule-hum-crit-high').value = humRule.crit_max ?? effectiveHumRule.crit_max ?? '';
                displayEffectiveRule(effectiveTempRule, effectiveHumRule);
            }
            async function fetchAllEffectiveRules(mac) {
                if (!mac) return null;
                if (window.allEffectiveRules[mac]) {
                    console.log(`[Rules] Using cached effective rules for ${mac}`);
                    return window.allEffectiveRules[mac];
                }
                try {
                    console.log(`[Rules] Fetching all effective rules for ${mac}...`);
                    const allRules = {
                        room: {},
                        sensors: {}
                    };
                    const roomTempRes = await fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=overall&metric=temp`);
                    const roomHumRes = await fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=overall&metric=hum`);
                    allRules.room.temp = await roomTempRes.json();
                    allRules.room.hum = await roomHumRes.json();
                    const pinMap = window.MAC_PIN_NAMES?.[mac] || {};
                    const sensorNames = ['25', '26', '32', '33'].map(pin => pinMap[`name_pin_${pin}`] || `Pin ${pin}`);
                    for (const sensorName of sensorNames) {
                        const sensorTempRes = await fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=${encodeURIComponent(sensorName)}&metric=temp`);
                        const sensorHumRes = await fetch(`/api/alert-rules/effective?mac=${mac}&sensor_name=${encodeURIComponent(sensorName)}&metric=hum`);
                        allRules.sensors[sensorName] = {
                            temp: await sensorTempRes.json(),
                            hum: await sensorHumRes.json()
                        };
                    }
                    window.allEffectiveRules[mac] = allRules;
                    console.log(`[Rules] Successfully fetched and cached all rules for ${mac}`, allRules);
                    return allRules;
                } catch (error) {
                    console.error(`[Rules] Failed to fetch all effective rules for ${mac}:`, error);
                    return null;
                }
            }
            function displayEffectiveRule(tempRule, humRule) {
                const container = document.getElementById('effective-rule-display');
                container.innerHTML = '';
                const renderSection = (title, rule, metricFields) => {
                    let sectionHtml = `<h6 class="font-semibold text-base mb-1 ${title.includes('Temp') ? 'text-red-400' : 'text-blue-400'}">${title}</h6>`;
                    for (const [label, key] of Object.entries(metricFields)) {
                        const value = rule[key] ?? 'N/A';
                        const origin = rule.origins?.[key] ?? 'system';
                        sectionHtml += `
                <div class="effective-rule-item">
                    <span>${label}: <strong>${value}</strong></span>
                    <span class="origin-badge origin-${origin}">${origin}</span>
                </div>
            `;
                    }
                    return sectionHtml;
                };
                const tempFields = {
                    'Crit Low': 'crit_min', 'Warn Low': 'warn_min',
                    'Warn High': 'warn_max', 'Crit High': 'crit_max'
                };
                const humFields = {
                    'Crit Low': 'crit_min', 'Warn Low': 'warn_min',
                    'Warn High': 'warn_max', 'Crit High': 'crit_max'
                };
                container.innerHTML += renderSection('🌡️ Temperature', tempRule, tempFields);
                container.innerHTML += '<div class="border-t border-dashed border-[var(--border)] my-3"></div>';
                container.innerHTML += renderSection('💧 Humidity', humRule, humFields);
            }
            overrideToggle?.addEventListener('change', (e) => {
                const enabled = e.target.checked;
                ruleFormFields.classList.toggle('opacity-50', !enabled);
                ruleFormFields.classList.toggle('pointer-events-none', !enabled);
            });
            document.querySelectorAll('.config-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    const name = btn.dataset.tab;
                    if (!name) {
                        console.error('[UI] Clicked tab has no data-tab attribute!', btn);
                        return;
                    }
                    document.querySelectorAll('.config-tab').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.config-section').forEach(s => s.classList.remove('active'));
                    btn.classList.add('active');
                    const sectionToActivate = document.getElementById('tab-' + name);
                    if (sectionToActivate) {
                        sectionToActivate.classList.add('active');
                    } else {
                        console.warn(`[UI] ไม่พบ Section ที่ตรงกับ tab: '${name}' (ID ที่พยายามหา: 'tab-${name}')`);
                    }
                });
            });
            document.getElementById('btn-reset-rule')?.addEventListener('click', async () => {
                const sensorName = drawerEl.dataset.sensor;
                const confirmed = await showConfirmationModal(
                    'Confirm Reset',
                    `This will remove the specific rule for <strong>${sensorName}</strong> and it will inherit from the room/system default. Are you sure?`,
                    {
                        confirmText: 'Yes, Reset',
                        confirmClass: 'btn-reset',
                        iconClass: 'fa-trash-arrow-up',
                        iconColorClass: 'text-red-400'
                    }
                );
                if (confirmed) {
                    handleDeleteSensorRule();
                }
            });
            document.addEventListener('click', function (e) {
                const sensorRow = e.target.closest('.clickable-sensor-row');
                if (sensorRow) {
                    const mac = sensorRow.dataset.mac;
                    const sensorName = sensorRow.dataset.sensor;
                    if (mac && sensorName) {
                        console.log(`Sensor row clicked for: MAC=${mac}, Sensor=${sensorName}`);
                        openSensorRuleEditor(mac, sensorName, 'temp');
                    } else {
                        console.error('Could not find mac or sensor name on the clicked sensor row.');
                    }
                }
            });
            async function handleSaveSensorRule() {
                const mac = drawerEl.dataset.mac;
                const sensorName = drawerEl.dataset.sensor;
                const overrideEnabled = overrideToggle.checked;
                if (!mac || !sensorName) {
                    showPopup('Error: Cannot identify the sensor.', { type: 'fail' });
                    return;
                }
                const getVal = id => {
                    const val = document.getElementById(id).value;
                    return val === '' ? null : parseFloat(val);
                };
                const tempRule = {
                    scope: 'sensor', mac, sensor_name: sensorName, metric: 'temp',
                    active: overrideEnabled ? 1 : 0,
                    crit_min: getVal('rule-temp-crit-low'),
                    warn_min: getVal('rule-temp-warn-low'),
                    warn_max: getVal('rule-temp-warn-high'),
                    crit_max: getVal('rule-temp-crit-high')
                };
                const humRule = {
                    scope: 'sensor', mac, sensor_name: sensorName, metric: 'hum',
                    active: overrideEnabled ? 1 : 0,
                    crit_min: getVal('rule-hum-crit-low'),
                    warn_min: getVal('rule-hum-warn-low'),
                    warn_max: getVal('rule-hum-warn-high'),
                    crit_max: getVal('rule-hum-crit-high')
                };
                try {
                    const res = await fetch('/api/alert-rules', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify([tempRule, humRule])
                    });
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error || 'Server returned an error');
                    }
                    showPopup('Sensor rules saved successfully.', { type: 'success' });
                    closeModal('modal-sensor-rules');
                    await loadPinMapFromServer();
                } catch (err) {
                    showPopup(`Failed to save rules: ${err.message}`, { type: 'fail' });
                    console.error('Failed to save sensor rule:', err);
                }
            }
            document.getElementById('btn-save-rule')?.addEventListener('click', async () => {
                const sensorName = drawerEl.dataset.sensor;
                const confirmed = await showConfirmationModal(
                    'Confirm Rule Changes',
                    `Are you sure you want to save these rules for sensor <strong>${sensorName}</strong>?`,
                    {
                        confirmText: 'Save Rules',
                        confirmClass: 'btn-confirm',
                        iconClass: 'fa-save',
                        iconColorClass: 'text-sky-400'
                    }
                );
                if (confirmed) {
                    handleSaveSensorRule();
                }
            });
            document.getElementById('detail-alert-list').addEventListener('click', (e) => {
                const ackButton = e.target.closest('.btn-ack-chip');
                if (!ackButton) return;
                const eventId = ackButton.dataset.eventId;
                if (eventId) {
                    console.log(`ACK button in chip clicked for event_id: ${eventId}`);
                    openAckModal([eventId]);
                }
            });
            document.getElementById('form-settings')?.addEventListener('submit', e => {
                e.preventDefault();
            });
            function openSummaryDetailModal(metric, title, unit) {
                const modal = document.getElementById('modal-summary-detail');
                if (!modal) return;
                modal.dataset.metric = metric;
                modal.dataset.title = title;
                modal.dataset.unit = unit;
                refreshSummaryModal();
                openModal('modal-summary-detail');
            }
            document.getElementById('summary-card-temp-max')?.addEventListener('click', () => {
                openSummaryDetailModal('temp_max', 'Highest Temperature per Room', '°C');
            });
            document.getElementById('summary-card-hum-max')?.addEventListener('click', () => {
                openSummaryDetailModal('hum_max', 'Highest Humidity per Room', '%');
            });
            document.getElementById('summary-card-dew-max')?.addEventListener('click', () => {
                openSummaryDetailModal('dew_max', 'Highest Dew Point per Room', '°C');
            });
            function calculateTempRiseForRoom(roomId) {
                const history = window.roomDataStore[roomId]?.history;
                if (!history || history.length < 1) return null;
                const latest = history[history.length - 1];
                if (typeof latest.temp_overall !== 'number') return null;
                const fiveMinutesAgo = new Date(latest.timestamp).getTime() - 300000;
                let baseline = null;
                for (let i = history.length - 2; i >= 0; i--) {
                    const pointTime = new Date(history[i].timestamp).getTime();
                    if (pointTime <= fiveMinutesAgo) {
                        baseline = history[i];
                        break;
                    }
                }
                if (!baseline && history.length > 1) {
                    baseline = history[0];
                }
                if (baseline && typeof baseline.temp_overall === 'number') {
                    return latest.temp_overall - baseline.temp_overall;
                }
                return 0;
            }
            let lastSystemSummary = {};
            function refreshSummaryModal() {
                const modal = document.getElementById('modal-summary-detail');
                if (!modal || modal.classList.contains('hidden')) {
                    return;
                }
                const metric = modal.dataset.metric;
                const title = modal.dataset.title;
                const unit = modal.dataset.unit;
                const titleEl = document.getElementById('summary-detail-title');
                const listEl = document.getElementById('summary-detail-list');
                if (!metric || !titleEl || !listEl) return;
                titleEl.textContent = title;
                const roomIds = ['room-a', 'room-b', 'room-c', 'room-d'];
                const allRoomData = [];
                roomIds.forEach(roomId => {
                    const roomName = window.ROOM_NAMES[roomId] || roomId;
                    const mac = window.ROOM_TO_MAC_MAP[roomId];
                    const statusDot = document.getElementById(`status-dot-${roomId}`);
                    const isOnline = statusDot && statusDot.classList.contains('led--green');
                    if (isOnline && mac) {
                        let value = null;
                        const roomDataStore = window.roomDataStore[roomId];
                        const lastData = roomDataStore?.history?.[roomDataStore.history.length - 1];
                        if (metric === 'temp_rise') {
                            if (lastSystemSummary.temp_rise_per_room && lastSystemSummary.temp_rise_per_room[mac] !== undefined) {
                                value = lastSystemSummary.temp_rise_per_room[mac];
                            }
                        } else if (lastData) {
                            if (metric === 'temp_max') value = lastData.max_temp;
                            else if (metric === 'hum_max') value = lastData.max_hum;
                            else if (metric === 'dew_max') value = dewPointC_Magnus(lastData.temp_overall, lastData.rh_overall);
                        }
                        if (value !== null && isFinite(value)) {
                            allRoomData.push({ name: roomName, value: value });
                        }
                    }
                });
                allRoomData.sort((a, b) => b.value - a.value);
                if (allRoomData.length > 0) {
                    listEl.innerHTML = allRoomData.map(data => {
                        const value = data.value;
                        let colorClass = 'text-slate-300';
                        let iconClass = 'fa-thermometer-half';
                        let sign = '';
                        if (metric === 'temp_rise') {
                            colorClass = value > 0.1 ? 'text-amber-400' : value < -0.1 ? 'text-sky-400' : 'text-slate-400';
                            iconClass = value > 0.1 ? 'fa-arrow-trend-up' : value < -0.1 ? 'fa-arrow-trend-down' : 'fa-minus';
                            if (value > 0) sign = '+';
                        } else if (metric === 'temp_max') {
                            iconClass = 'fa-temperature-high text-red-400';
                        } else if (metric === 'hum_max') {
                            iconClass = 'fa-droplet text-blue-400';
                        } else if (metric === 'dew_max') {
                            iconClass = 'fa-wind text-teal-400';
                        }
                        return `
                <li class="flex items-center justify-between p-3 bg-[var(--panel-2)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-3">
                        <i class="fas ${iconClass} w-5 text-center"></i>
                        <span class="font-medium">${data.name}</span>
                    </div>
                    <span class="font-bold text-lg ${colorClass}">${sign}${value.toFixed(1)}${unit}</span>
                </li>`;
                    }).join('');
                } else {
                    listEl.innerHTML = '<li class="text-center text-[var(--muted)]">No active rooms to display or not enough data.</li>';
                }
            }
            document.getElementById('summary-card-temp-rise')?.addEventListener('click', () => {
                const modal = document.getElementById('modal-summary-detail');
                const titleEl = document.getElementById('summary-detail-title');
                const listEl = document.getElementById('summary-detail-list');
                if (!modal || !titleEl || !listEl) return;
                titleEl.textContent = 'Temperature Rise per Room';
                listEl.innerHTML = '';
                const roomIds = ['room-a', 'room-b', 'room-c', 'room-d'];
                const allRoomData = [];
                roomIds.forEach(roomId => {
                    const roomName = window.ROOM_NAMES[roomId] || roomId;
                    const statusDot = document.getElementById(`status-dot-${roomId}`);
                    const isOnline = statusDot && statusDot.classList.contains('led--green');
                    if (isOnline) {
                        const riseValue = calculateTempRiseForRoom(roomId);
                        if (riseValue !== null) {
                            allRoomData.push({ name: roomName, value: riseValue });
                        }
                    }
                });
                allRoomData.sort((a, b) => b.value - a.value);
                if (allRoomData.length > 0) {
                    listEl.innerHTML = allRoomData.map(data => {
                        const value = data.value;
                        const isRise = value > 0;
                        const isFall = value < 0;
                        const colorClass = isRise ? 'text-amber-400' : isFall ? 'text-sky-400' : 'text-slate-400';
                        const iconClass = isRise ? 'fa-arrow-trend-up' : isFall ? 'fa-arrow-trend-down' : 'fa-minus';
                        const sign = isRise ? '+' : '';
                        return `
                <li class="flex items-center justify-between p-3 bg-[var(--panel-2)] rounded-lg border border-[var(--border)]">
                    <div class="flex items-center gap-3">
                        <i class="fas ${iconClass} w-5 text-center ${colorClass}"></i>
                        <span class="font-medium">${data.name}</span>
                    </div>
                    <span class="font-bold text-lg ${colorClass}">${sign}${value.toFixed(1)}°C</span>
                </li>
            `;
                    }).join('');
                } else {
                    listEl.innerHTML = '<li class="text-center text-[var(--muted)]">Not enough data to calculate temperature rise.</li>';
                }
                openModal('modal-summary-detail');
            });
            document.getElementById('summary-card-temp-max')?.addEventListener('click', () => {
                openSummaryDetailModal('temp_max', 'Highest Temperature per Room', '°C');
            });
            document.getElementById('summary-card-hum-max')?.addEventListener('click', () => {
                openSummaryDetailModal('hum_max', 'Highest Humidity per Room', '%');
            });
            document.getElementById('summary-card-dew-max')?.addEventListener('click', () => {
                openSummaryDetailModal('dew_max', 'Highest Dew Point per Room', '°C');
            });
            document.getElementById('summary-card-temp-rise')?.addEventListener('click', () => {
                openSummaryDetailModal('temp_rise', 'Temperature Rise per Room', '°C');
            });
            const fabElement = document.getElementById('recovery-fab');
            if (fabElement) {
                makeDraggable(fabElement, () => {
                    console.log('[RecoveryBell] Genuine CLICK detected!');
                    openModal('modal-alert-center');
                    const statusSelect = document.getElementById('alert-filter-status');
                    const startDateInput = document.getElementById('alert-filter-start-date');
                    const endDateInput = document.getElementById('alert-filter-end-date');
                    if (statusSelect && startDateInput && endDateInput) {
                        resetFilters();
                        startDateInput.value = '';
                        endDateInput.value = '';
                        statusSelect.value = 'closed';
                        loadAndCacheAlerts();
                    }
                });
            }
        });
        function makeDraggable(element, onClickCallback) {
            let isDragging = false;
            let hasMoved = false;
            let offsetX, offsetY, startX, startY;
            const DRAG_THRESHOLD = 5;
            const onMouseDown = (e) => {
                if (e.button !== 0) return;
                isDragging = true;
                hasMoved = false;
                const rect = element.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                element.style.transition = 'none';
                document.body.style.userSelect = 'none';
            };
            const onMouseMove = (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if (!hasMoved && Math.sqrt(dx * dx + dy * dy) > DRAG_THRESHOLD) {
                    hasMoved = true;
                }
                if (hasMoved) {
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;
                    const rect = element.getBoundingClientRect();
                    newX = Math.max(0, Math.min(newX, window.innerWidth - rect.width));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - rect.height));
                    element.style.left = `${newX}px`;
                    element.style.top = `${newY}px`;
                }
            };
            const onMouseUp = () => {
                if (!isDragging) return;
                if (hasMoved) {
                    const blockClick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        document.removeEventListener('click', blockClick, true);
                    };
                    document.addEventListener('click', blockClick, true);
                }
                isDragging = false;
                element.style.transition = '';
                document.body.style.userSelect = '';
            };
            const onClick = (e) => {
                if (typeof onClickCallback === 'function') {
                    onClickCallback(e);
                }
            };
            element.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            element.addEventListener('click', onClick);
            element.addEventListener('touchstart', (e) => {
                isDragging = true;
                hasMoved = false;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                offsetX = touch.clientX - element.getBoundingClientRect().left;
                offsetY = touch.clientY - element.getBoundingClientRect().top;
                element.style.transition = 'none';
            }, { passive: true });
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                if (!hasMoved && Math.sqrt(dx * dx + dy * dy) > DRAG_THRESHOLD) {
                    hasMoved = true;
                }
                if (hasMoved) {
                    e.preventDefault();
                    let newX = touch.clientX - offsetX;
                    let newY = touch.clientY - offsetY;
                    const rect = element.getBoundingClientRect();
                    newX = Math.max(0, Math.min(newX, window.innerWidth - rect.width));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - rect.height));
                    element.style.left = `${newX}px`;
                    element.style.top = `${newY}px`;
                }
            }, { passive: false });
            document.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                if (hasMoved) {
                    e.preventDefault();
                }
                isDragging = false;
                element.style.transition = '';
            });
        }
    </script>
    <button id="recovery-fab"
        class="hidden fixed bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300 z-[99]"
        style="top: 2rem; right: 2rem;">
        <i class="fas fa-bell"></i>
        <span id="recovery-badge"
            class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white">0</span>
    </button>
</body>

</html>
